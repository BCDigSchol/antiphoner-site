(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";

function Antiphoner(success_callback) {
    var data = {};

    load();

    this.getFolios = getFolios;
    this.getChant = getChant;
    this.getChants = getChants;

    function load() {
        var request = new XMLHttpRequest();
        request.onload = function () {
            data = JSON.parse(request.responseText);
            success_callback();
        };
        request.onerror = function () {
        };
        request.open('GET', 'antiphoner-data.json');
        request.send();
    };

    function getFolios(){
        return Object.keys(data);
    }

    function getChants(folio) {
        if (!data[folio]) {
            throw new ChantError('No folio found with ID ' + folio);
        }
        return data[folio];
    }

    function getChant(chant_id) {
        var regex_results = /0*(\d*(r|v))(\d*)/.exec(chant_id);
        var folio_id = regex_results[1],
            chant_sequence = regex_results[3] - 1;
        var folio = getChants(folio_id);
        if (!folio[chant_sequence]) {
            throw new ChantError('No chant found on ' + folio_id + ' with sequence number ' + chant_sequence + ' : ' + chant_id);
        }
        return folio[chant_sequence];
    }
}

function ChantError(message) {
    this.message = message;
}

ChantError.prototype = Object.create(Error.prototype);

module.exports = Antiphoner;
},{}],2:[function(require,module,exports){
"use strict";

function Viewer(antiphoner) {
    var incipit_template = require('./templates/incipit.hbs');
    var data = {};
    var hold_state = false;

    this.diva_settings = {
        enableAutoHeight: true,
        fixedHeightGrid: false,
        iipServerURL: "http://mlib.bc.edu/iipsrv/iipsrv.fcgi",
        objectData: "antiphoner-processed.json",
        imageDir: "",
        enableCanvas: true,
        enableDownload: true,
        enableLinkIcon: false,
        enableAutoTitle: false,
        enableAntiphoner: true,
        zoomLevel: 2,
        pageAliasFunction: getPageAlias,
        enablePagealias: true
    };
    this.goTo = goTo;

    // Add to the Diva plugin list
    window.divaPlugins.push({
        pluginName: 'antiphoner',
        init: initialize,
        handleClick: function (event) {
            // Diva.js plugins need a handleClick function, but we have no clicks to handle.
        }
    });

    function getPageAlias(page) {
        var numeric = 0;

        switch (page) {
            case 0:
                return 'Front cover';
            case 1:
                return 'Front endpaper';
            case 239:
                return 'Back endpaper';
            case 240:
                return 'Back cover';
        }

        numeric = Math.floor(page / 2);

        if (page % 2 === 0) {
            return numeric + "r";
        } else {
            return numeric + "v";
        }
    }

    /**
     * Initialize the antiphoner display
     *
     * @param diva_settings
     * @param diva_instance
     */
    function initialize(diva_settings, diva_instance) {
        data.current_diva = diva_instance;
        data.current_folio = '';
        diva.Events.subscribe('VisiblePageDidChange', loadPage, self);
        diva.Events.subscribe('ObjectDidLoad', loadInitialViewer, self);
    }

    function loadInitialViewer() {
        //var folio = querystring.parse(window.location.pathname.slice(1)).page;
        var path_parts = window.location.pathname.split('/');
        var folio = path_parts[2], sequence = path_parts[3];
        if (folio) {
            goTo(folio, sequence);
        }
    }

    function update_state(state, url, push) {
        if (push) {
            history.pushState(state, '', url);
        } else {
            history.replaceState(state, '', url);
        }
    }

    /**
     * Jump to a folio
     *
     * @param folio
     */
    function goTo(folio, sequence) {
        // For some reason we have to wait before jumping.
        // @TODO: Why do we have to wait before jumping?
        setTimeout(function () {
            var url = (sequence) ? folio + '/' + sequence : folio;
            data.current_diva.gotoPageByAliasedNumber(folio.replace(/^0+/, ''));
        }, 1);
    }

    /**
     * Load a folio of antiphoner data
     *
     * @param page_num
     * @param filename
     */
    function loadPage(page_num, filename) {
        var chants_on_page = [];
        if (pageHasChanged()) {
            chants_on_page = antiphoner.getChants(data.current_folio);
            $('#metadata-tab').html(incipit_template({incipits: chants_on_page}));
            $('#metadata-tab h3').click(function () {
                $(this).next('.metadata').slideToggle().siblings('.metadata:visible').slideUp();
            });
        }
    }

    /**
     * Monitor page changes
     *
     * @returns {boolean}
     */
    function pageHasChanged() {
        var state;
        if (data.current_folio != data.current_diva.getCurrentAliasedPageIndex()) {
            data.current_folio = data.current_diva.getCurrentAliasedPageIndex();
            state = {folio: data.current_folio, sequence: false, hold: false};
            if (hold_state) {
                update_state(state, data.current_folio, true);
            } else {
                update_state(state, data.current_folio, false);
            }
            return true;
        } else {
            return false;
        }
    }

    window.onpopstate = function (e) {
        if (e.state) {
            goTo(e.state.folio, e.state.sequence);
        }
    };
}

module.exports = Viewer;
},{"./templates/incipit.hbs":28}],3:[function(require,module,exports){
(function (global){
global.diva = require("diva");

var Antiphoner = require('./antiphoner.js');
var Viewer = require('./antiphoner_viewer.js');
var SearchEngine = require('./search.js');

var antiphoner;

// Once the window loads, load the Antiphoner and display.
window.onload = function () {
    antiphoner = new Antiphoner(display_antiphoner);
};

function display_antiphoner() {

    var result_template = require('./templates/search-results.hbs');
    var search = new SearchEngine(antiphoner);
    var viewer = new Viewer(antiphoner);
    var current_index = 'volpiano';
    var current_tab = 'metadata';

    function selectSearchField(event) {
        document.getElementById(current_index + '-row').className = 'search-row';
        current_index = event.target.value;
        document.getElementById(event.target.value + '-row').className = 'search-row active-field';
    }

    function searchVolpiano(event) {
        var results = search.searchVolpiano(event.target.value);
        displayResults(results);
    }

    function searchText(event) {
        var results = search.searchTextField(event.target.value, current_index);
        displayResults(results);
    }

    function displayResults(results) {
        var total_results = results.length,
            result_elements = [];
        document.getElementById('results-holder').innerHTML = result_template({results: results, total: total_results});
        result_elements = document.getElementsByClassName('search-result');
        for (var i=0; i < result_elements.length; i++) {
            result_elements[i].onclick = goToResult;
        }
    }

    function goToResult(event) {
        var array = event.currentTarget.pathname.split('/'),
            folio = array[2], sequence = array[3];
        var url = folio + '/' + sequence;
        viewer.goTo(folio, sequence);
        return false;
    }

    function addSearchListeners() {
        var text_inputs = document.getElementsByClassName('text-input');
        for (var i = 0; i < text_inputs.length; i++) {
            text_inputs[i].oninput = searchText
        }
        document.getElementById('volpiano-input').oninput = searchVolpiano;
        document.getElementById('index-selector').onchange = selectSearchField;
    }

    function listenToTabs(event) {
        var new_tab = event.target.id.replace('-tab-selector', '');
        if (new_tab !== current_tab) {
            changeTab(new_tab);
        }
    }

    function changeTab(new_tab) {
        var current = document.getElementsByClassName('current-tab');
        while (current.length) {
            current[0].className = '';
        }
        document.getElementById(new_tab + '-tab-selector').className = 'current-tab';
        document.getElementById(new_tab + '-tab').className = 'current-tab';
        current_tab = new_tab;
    }

    // Load everything.
    $('#diva-wrapper').diva(viewer.diva_settings);
    document.querySelector('#tab-menu').onclick = listenToTabs;
    addSearchListeners();
}
}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./antiphoner.js":1,"./antiphoner_viewer.js":2,"./search.js":27,"./templates/search-results.hbs":29,"diva":5}],4:[function(require,module,exports){
"use strict";

var lunr = require("lunr");

function Index(field) {
    var index = lunr(function () {
        this.field(field);
        this.ref('id');
        this.pipeline.remove(lunr.stemmer)
        this.pipeline.remove(lunr.stopWordFilter)
    });

     this.index = index;

    this.search = function (text) {
        return index.search(text);
    };

    this.addChant = function (chant) {
        var to_add = { id: chant['id']};
        to_add[field] = chant[field];
        index.add(to_add);
    }
}

module.exports = Index;
},{"lunr":26}],5:[function(require,module,exports){
(function (global){
; var __browserify_shim_require__=require;(function browserifyShim(module, exports, require, define, browserify_shim__define__module__export__) {
!function(e){var t;if("object"==typeof module&&module.exports)try{t=__browserify_shim_require__("jquery")}catch(i){}e(t||jQuery)}(function(e){Storage.prototype.setObject=function(e,t){this.setItem(e,JSON.stringify(t))},Storage.prototype.getObject=function(e){var t=this.getItem(e);return t&&JSON.parse(t)},function(e){var t=1;e.generateId=function(e){var i;do i=t++ +(e?"-"+e:"");while(document.getElementById(i));return i}}(e),function(e){e.getScrollbarWidth=function(){var e=document.createElement("p");e.style.width="100%",e.style.height="200px";var t=document.createElement("div");t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.visibility="hidden",t.style.width="200px",t.style.height="150px",t.style.overflow="hidden",t.appendChild(e),document.body.appendChild(t);var i=e.offsetWidth;t.style.overflow="scroll";var n=e.offsetWidth;return i==n&&(n=t.clientWidth),document.body.removeChild(t),i-n}}(e),function(e){e.getHashParam=function(e){var t=window.location.hash;if(""!==t){var i=t.indexOf("&"+e+"=")>0?t.indexOf("&"+e+"="):t.indexOf("#"+e+"=");if(i>=0){i+=e.length+2;var n=t.indexOf("&",i);return n>i?decodeURIComponent(t.substring(i,n)):0>n?decodeURIComponent(t.substring(i)):""}return!1}return!1}}(e),function(e){e.updateHashParam=function(t,i){var n=e.getHashParam(t),o=window.location.hash;if(n!==i)if("string"==typeof n){var a=o.indexOf("&"+t+"=")>0?o.indexOf("&"+t+"="):o.indexOf("#"+t+"="),r=a+t.length+2+n.length,s=0===a?"#":"&";window.location.replace(o.substring(0,a)+s+t+"="+i+o.substring(r))}else 0===o.length?window.location.replace("#"+t+"="+i):window.location.replace(o+"&"+t+"="+i)}}(e),function(e){e.fn.dragscrollable=function(t){var i=e.extend({dragSelector:">:first",acceptPropagatedEvent:!0,preventDefault:!0},t||{}),n={mouseDownHandler:function(t){return 1!=t.which||!t.data.acceptPropagatedEvent&&t.target!=this?!1:(t.data.lastCoord={left:t.clientX,top:t.clientY},e.event.add(document,"mouseup",n.mouseUpHandler,t.data),e.event.add(document,"mousemove",n.mouseMoveHandler,t.data),t.data.preventDefault?(t.preventDefault(),!1):void 0)},mouseMoveHandler:function(e){var t={left:e.clientX-e.data.lastCoord.left,top:e.clientY-e.data.lastCoord.top};return e.data.scrollable.scrollLeft(e.data.scrollable.scrollLeft()-t.left),e.data.scrollable.scrollTop(e.data.scrollable.scrollTop()-t.top),e.data.lastCoord={left:e.clientX,top:e.clientY},e.data.preventDefault?(e.preventDefault(),!1):void 0},mouseUpHandler:function(t){return e.event.remove(document,"mousemove",n.mouseMoveHandler),e.event.remove(document,"mouseup",n.mouseUpHandler),t.data.preventDefault?(t.preventDefault(),!1):void 0}};this.each(function(){var t={scrollable:e(this),acceptPropagatedEvent:i.acceptPropagatedEvent,preventDefault:i.preventDefault};e(this).find(i.dragSelector).bind("mousedown",t,n.mouseDownHandler)})}}(e),function(e){"use strict";var t="kinetic-active";window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}()),e.support=e.support||{},e.extend(e.support,{touch:"ontouchend"in document});var i=function(t,i){return this.settings=i,this.el=t,this.$el=e(t),this._initElements(),this};i.DATA_KEY="kinetic",i.DEFAULTS={cursor:"move",decelerate:!0,triggerHardware:!1,threshold:0,y:!0,x:!0,slowdown:.9,maxvelocity:40,throttleFPS:60,invert:!1,movingClass:{up:"kinetic-moving-up",down:"kinetic-moving-down",left:"kinetic-moving-left",right:"kinetic-moving-right"},deceleratingClass:{up:"kinetic-decelerating-up",down:"kinetic-decelerating-down",left:"kinetic-decelerating-left",right:"kinetic-decelerating-right"}},i.prototype.start=function(t){this.settings=e.extend(this.settings,t),this.velocity=t.velocity||this.velocity,this.velocityY=t.velocityY||this.velocityY,this.settings.decelerate=!1,this._move()},i.prototype.end=function(){this.settings.decelerate=!0},i.prototype.stop=function(){this.velocity=0,this.velocityY=0,this.settings.decelerate=!0,e.isFunction(this.settings.stopped)&&this.settings.stopped.call(this)},i.prototype.detach=function(){this._detachListeners(),this.$el.removeClass(t).css("cursor","")},i.prototype.attach=function(){this.$el.hasClass(t)||(this._attachListeners(this.$el),this.$el.addClass(t).css("cursor",this.settings.cursor))},i.prototype._initElements=function(){this.$el.addClass(t),e.extend(this,{xpos:null,prevXPos:!1,ypos:null,prevYPos:!1,mouseDown:!1,throttleTimeout:1e3/this.settings.throttleFPS,lastMove:null,elementFocused:null}),this.velocity=0,this.velocityY=0,e(document).mouseup(e.proxy(this._resetMouse,this)).click(e.proxy(this._resetMouse,this)),this._initEvents(),this.$el.css("cursor",this.settings.cursor),this.settings.triggerHardware&&this.$el.css({"-webkit-transform":"translate3d(0,0,0)","-webkit-perspective":"1000","-webkit-backface-visibility":"hidden"})},i.prototype._initEvents=function(){var t=this;this.settings.events={touchStart:function(e){var i;t._useTarget(e.target,e)&&(i=e.originalEvent.touches[0],t.threshold=t._threshold(e.target,e),t._start(i.clientX,i.clientY),e.stopPropagation())},touchMove:function(e){var i;t.mouseDown&&(i=e.originalEvent.touches[0],t._inputmove(i.clientX,i.clientY),e.preventDefault&&e.preventDefault())},inputDown:function(e){t._useTarget(e.target,e)&&(t.threshold=t._threshold(e.target,e),t._start(e.clientX,e.clientY),t.elementFocused=e.target,"IMG"===e.target.nodeName&&e.preventDefault(),e.stopPropagation())},inputEnd:function(e){t._useTarget(e.target,e)&&(t._end(),t.elementFocused=null,e.preventDefault&&e.preventDefault())},inputMove:function(e){t.mouseDown&&(t._inputmove(e.clientX,e.clientY),e.preventDefault&&e.preventDefault())},scroll:function(i){e.isFunction(t.settings.moved)&&t.settings.moved.call(t,t.settings),i.preventDefault&&i.preventDefault()},inputClick:function(e){return Math.abs(t.velocity)>0?(e.preventDefault(),!1):void 0},dragStart:function(e){return t._useTarget(e.target,e)&&t.elementFocused?!1:void 0},selectStart:function(i){return e.isFunction(t.settings.selectStart)?t.settings.selectStart.apply(t,arguments):t._useTarget(i.target,i)?!1:void 0}},this._attachListeners(this.$el,this.settings)},i.prototype._inputmove=function(t,i){var n=this.$el;this.el;if((!this.lastMove||new Date>new Date(this.lastMove.getTime()+this.throttleTimeout))&&(this.lastMove=new Date,this.mouseDown&&(this.xpos||this.ypos))){var o=t-this.xpos,a=i-this.ypos;if(this.settings.invert&&(o*=-1,a*=-1),this.threshold>0){var r=Math.sqrt(o*o+a*a);if(this.threshold>r)return;this.threshold=0}this.elementFocused&&(e(this.elementFocused).blur(),this.elementFocused=null,n.focus()),this.settings.decelerate=!1,this.velocity=this.velocityY=0;var s=this.scrollLeft(),l=this.scrollTop();this.scrollLeft(this.settings.x?s-o:s),this.scrollTop(this.settings.y?l-a:l),this.prevXPos=this.xpos,this.prevYPos=this.ypos,this.xpos=t,this.ypos=i,this._calculateVelocities(),this._setMoveClasses(this.settings.movingClass),e.isFunction(this.settings.moved)&&this.settings.moved.call(this,this.settings)}},i.prototype._calculateVelocities=function(){this.velocity=this._capVelocity(this.prevXPos-this.xpos,this.settings.maxvelocity),this.velocityY=this._capVelocity(this.prevYPos-this.ypos,this.settings.maxvelocity),this.settings.invert&&(this.velocity*=-1,this.velocityY*=-1)},i.prototype._end=function(){this.xpos&&this.prevXPos&&this.settings.decelerate===!1&&(this.settings.decelerate=!0,this._calculateVelocities(),this.xpos=this.prevXPos=this.mouseDown=!1,this._move())},i.prototype._useTarget=function(t,i){return e.isFunction(this.settings.filterTarget)?this.settings.filterTarget.call(this,t,i)!==!1:!0},i.prototype._threshold=function(t,i){return e.isFunction(this.settings.threshold)?this.settings.threshold.call(this,t,i):this.settings.threshold},i.prototype._start=function(e,t){this.mouseDown=!0,this.velocity=this.prevXPos=0,this.velocityY=this.prevYPos=0,this.xpos=e,this.ypos=t},i.prototype._resetMouse=function(){this.xpos=!1,this.ypos=!1,this.mouseDown=!1},i.prototype._decelerateVelocity=function(e,t){return 0===Math.floor(Math.abs(e))?0:e*t},i.prototype._capVelocity=function(e,t){var i=e;return e>0?e>t&&(i=t):0-t>e&&(i=0-t),i},i.prototype._setMoveClasses=function(e){var t=this.settings,i=this.$el;i.removeClass(t.movingClass.up).removeClass(t.movingClass.down).removeClass(t.movingClass.left).removeClass(t.movingClass.right).removeClass(t.deceleratingClass.up).removeClass(t.deceleratingClass.down).removeClass(t.deceleratingClass.left).removeClass(t.deceleratingClass.right),this.velocity>0&&i.addClass(e.right),this.velocity<0&&i.addClass(e.left),this.velocityY>0&&i.addClass(e.down),this.velocityY<0&&i.addClass(e.up)},i.prototype._move=function(){var t=this._getScroller(),i=t[0],n=this,o=n.settings;o.x&&i.scrollWidth>0?(this.scrollLeft(this.scrollLeft()+this.velocity),Math.abs(this.velocity)>0&&(this.velocity=o.decelerate?n._decelerateVelocity(this.velocity,o.slowdown):this.velocity)):this.velocity=0,o.y&&i.scrollHeight>0?(this.scrollTop(this.scrollTop()+this.velocityY),Math.abs(this.velocityY)>0&&(this.velocityY=o.decelerate?n._decelerateVelocity(this.velocityY,o.slowdown):this.velocityY)):this.velocityY=0,n._setMoveClasses(o.deceleratingClass),e.isFunction(o.moved)&&o.moved.call(this,o),Math.abs(this.velocity)>0||Math.abs(this.velocityY)>0?this.moving||(this.moving=!0,window.requestAnimationFrame(function(){n.moving=!1,n._move()})):n.stop()},i.prototype._getScroller=function(){var t=this.$el;return(this.$el.is("body")||this.$el.is("html"))&&(t=e(window)),t},i.prototype.scrollLeft=function(e){var t=this._getScroller();return"number"!=typeof e?t.scrollLeft():(t.scrollLeft(e),void(this.settings.scrollLeft=e))},i.prototype.scrollTop=function(e){var t=this._getScroller();return"number"!=typeof e?t.scrollTop():(t.scrollTop(e),void(this.settings.scrollTop=e))},i.prototype._attachListeners=function(){var t=this.$el,i=this.settings;e.support.touch&&t.bind("touchstart",i.events.touchStart).bind("touchend",i.events.inputEnd).bind("touchmove",i.events.touchMove),t.mousedown(i.events.inputDown).mouseup(i.events.inputEnd).mousemove(i.events.inputMove),t.click(i.events.inputClick).scroll(i.events.scroll).bind("selectstart",i.events.selectStart).bind("dragstart",i.events.dragStart)},i.prototype._detachListeners=function(){var t=this.$el,i=this.settings;e.support.touch&&t.unbind("touchstart",i.events.touchStart).unbind("touchend",i.events.inputEnd).unbind("touchmove",i.events.touchMove),t.unbind("mousedown",i.events.inputDown).unbind("mouseup",i.events.inputEnd).unbind("mousemove",i.events.inputMove),t.unbind("click",i.events.inputClick).unbind("scroll",i.events.scroll).unbind("selectstart",i.events.selectStart).unbind("dragstart",i.events.dragStart)},e.Kinetic=i,e.fn.kinetic=function(t,n){return this.each(function(){var o=e(this),a=o.data(i.DATA_KEY),r=e.extend({},i.DEFAULTS,o.data(),"object"==typeof t&&t);a||o.data(i.DATA_KEY,a=new i(this,r)),"string"==typeof t&&a[t](n)})}}(e),function(e){e.Kinetic.prototype._attachListeners=function(){var t=this.$el,i=this.settings;e.support.touch&&t.bind("touchstart",i.events.touchStart).bind("touchend",i.events.inputEnd).bind("touchmove",i.events.touchMove),t.click(i.events.inputClick).scroll(i.events.scroll).bind("selectstart",i.events.selectStart).bind("dragstart",i.events.dragStart)},e.Kinetic.prototype._detachListeners=function(){var t=this.$el,i=this.settings;e.support.touch&&t.unbind("touchstart",i.events.touchStart).unbind("touchend",i.events.inputEnd).unbind("touchmove",i.events.touchMove),t.unbind("click",i.events.inputClick).unbind("scroll",i.events.scroll).unbind("selectstart",i.events.selectStart).unbind("dragstart",i.events.dragStart)}}(e);var t=function(){var e={},t={Events:{publish:function(t,i,n){if(e[t]){var o=e[t];if("undefined"!=typeof o.global)for(var a=o.global,r=a.length;r--;)a[r].apply(n||this,i||[]);if(n&&"undefined"!=typeof n.getInstanceId){var s=n.getInstanceId();if(e[t][s])for(var l=e[t][s],c=l.length;c--;)l[c].apply(n||this,i||[])}}},subscribe:function(t,i,n){e[t]||(e[t]={}),"string"==typeof n?(e[t][n]||(e[t][n]=[]),e[t][n].push(i)):(e[t].global||(e[t].global=[]),e[t].global.push(i));var o=n?[t,i,n]:[t,i];return o},unsubscribe:function(t,i){var n=t[0];if(e[n]){var o,a=3===t.length&&"undefined"!=typeof e[n][t[2]]?t[2]:"global";o=e[n][a];for(var r=o.length;r--;)if(o[r]===t[1])return e[n][a].splice(r,1),i&&delete e[n][a],!0}return!1},unsubscribeAll:function(t){if(t)for(var i,n=Object.keys(e),o=n.length;o--;)i=n[o],"undefined"!==e[i][t]&&delete e[i][t];else e={}}}};return t}();window.diva=t,"object"==typeof module&&module.exports&&(module.exports=t);var i=function(e){return function(){var t;e(document).on("click",function(t){i(e(t.target))});var i=function(i){var n,o,a=i.find(".diva-outer"),r=i.closest(".diva-outer"),s=document.getElementsByClassName("diva-outer"),l=s.length;if(a.length>0)n=a;else{if(!(r.length>0)){for(o=0;l>o;o++)e(s[o].parentElement).data("diva").deactivate();return}n=r}for(n.parent().data("diva").activate(),t=n.parent(),s=document.getElementsByClassName("diva-outer"),o=0;l>o;o++)s[o].getAttribute("id")!=n.attr("id")&&e(s[o].parentElement).data("diva").deactivate()};this.getActive=function(){return t}}}(e);new i;window.divaPlugins=[],function(e){var i=function(i,n){var o=e(i),a={adaptivePadding:.05,arrowScrollAmount:40,blockMobileMove:!1,objectData:"",enableAutoTitle:!0,enableFilename:!0,enableFullscreen:!0,enableGotoPage:!0,enableGridIcon:!0,enableGridControls:"buttons",enableImageTitles:!0,enableKeyScroll:!0,enableLinkIcon:!0,enableSpaceScroll:!1,enableToolbar:!0,enableZoomControls:"buttons",fixedPadding:10,fixedHeightGrid:!0,goDirectlyTo:0,iipServerURL:"",inFullscreen:!1,inBookLayout:!1,inGrid:!1,imageDir:"",maxPagesPerRow:8,maxZoomLevel:-1,minPagesPerRow:2,minZoomLevel:0,pageLoadTimeout:200,pagesPerRow:5,rowLoadTimeout:50,throbberTimeout:100,tileHeight:256,tileWidth:256,toolbarParentObject:o,verticallyOriented:!0,viewportMargin:200,zoomLevel:2},r=e.extend({},a,n),s={allTilesLoaded:[],averageHeights:[],averageWidths:[],currentPageIndex:0,doubleClickZoom:!1,documentPaged:!1,firstPageLoaded:-1,firstRowLoaded:-1,gridPageWidth:0,hashParamSuffix:"",horizontalOffset:0,horizontalPadding:0,ID:null,initialKeyScroll:!1,initialSpaceScroll:!1,innerObject:"",isActiveDiva:!0,isScrollable:!0,isIIIF:!1,itemTitle:"",lastPageLoaded:-1,lastRowLoaded:-1,loaded:!1,maxWidths:[],maxHeights:[],maxRatio:0,minRatio:0,mobileWebkit:!1,numPages:0,numRows:0,oldZoomLevel:-1,outerObject:"",pages:[],pageLeftOffsets:[],pageTopOffsets:[],pageTimeouts:[],pageTools:"",panelHeight:0,panelWidth:0,parentObject:o,plugins:[],previousLeftScroll:0,previousTopScroll:0,realMaxZoom:-1,resizeTimer:-1,rowHeight:0,scaleWait:!1,scrollbarWidth:0,selector:"",singleClick:!1,singleTap:!1,throbberTimeoutID:-1,toolbar:null,totalHeights:[],totalHeight:0,totalWidths:[],totalWidth:0,verticalOffset:0,verticalPadding:0};e.extend(r,s);var l=this,c=function(e,t){return r.pages[e].d[r.zoomLevel][t]},d=function(e){var t,i=r.numPages;for(t=0;i>t;t++)if(r.pages[t].f===e)return t;return-1},u=function(e,t){var i=r.outerObject.scrollLeft()-r.viewportMargin,n=i+r.panelWidth+2*r.viewportMargin,o=e>=i&&n>=e,a=i>=e&&t>=n,s=t>=i&&n>=t;return o||a||s},g=function(e,t){var i=r.outerObject.scrollTop()-r.viewportMargin,n=i+r.panelHeight+2*r.viewportMargin,o=e>=i&&n>=e,a=i>=e&&t>=n,s=t>=i&&n>=t;return o||a||s},h=function(e,t,i){var n,o;r.verticallyOriented?(n=r.pageTopOffsets[e]+t*r.tileHeight+r.verticalPadding,o=r.pageLeftOffsets[e]+i*r.tileWidth):(n=r.pageTopOffsets[e]+t*r.tileHeight,o=r.pageLeftOffsets[e]+i*r.tileWidth+r.horizontalPadding);var a=n+r.tileHeight,s=o+r.tileWidth;return g(n,a)&&u(o,s)},v=function(e,t){return!!document.getElementById(r.ID+"tile-"+e+"-"+t)},p=function(e){return e>=0&&e<r.numPages},f=function(e){var t=r.pageTopOffsets[e],i=t+c(e,"h")+r.verticalPadding,n=r.pageLeftOffsets[e],o=n+c(e,"w")+r.horizontalPadding;return g(t,i)&&u(n,o)},m=function(e){return!!document.getElementById(r.ID+"page-"+e)},b=function(e,i,n,o,a){var s=document.getElementById(r.ID+"page-"+e);if(null!==s&&f(e)){var d,u,g,p,m,b,w,y,I,x,P,D,L,O=r.imageDir+"/",C=Math.ceil(c(e,"h")/r.tileWidth),T=Math.ceil(c(e,"w")/r.tileHeight),E=r.pages[e].m,S=r.iipServerURL+"?FIF="+O+i+"&JTL=",k=!0,z=0,M=o-(C-1)*r.tileHeight,j=n-(T-1)*r.tileWidth;w=r.zoomLevel+E-r.realMaxZoom;var A,F,H,B=r.isIIIF?r.pages[e].url:S+w+",";for(r.isIIIF?(L=Math.pow(2,E-w),I=r.tileHeight*L,x=r.tileWidth*L,A=r.pages[e].api,F=A>=2?"default":"native",H="/0/"+F+".jpg",r.pages[e].hasOwnProperty("xoffset")?(P=r.pages[e].xoffset,D=r.pages[e].yoffset):(P=0,D=0)):(I=r.tileHeight,x=r.tileWidth),d=0;C>d;){for(u=0,g=d===C-1?M:r.tileHeight;T>u;){if(m=d*r.tileHeight,b=u*r.tileWidth,p=u===T-1?j:r.tileWidth,y=r.isIIIF?B+(u*x+P)+","+(d*I+D)+","+p*L+","+g*L+"/"+p+","+H:B+z,!v(e,z))if(h(e,d,u)){var R=document.createElement("div");R.id=r.ID+"tile-"+e+"-"+z,R.classList.add("diva-document-tile"),R.style.display="inline",R.style.position="absolute",R.style.top=m+"px",R.style.left=b+"px",R.style.backgroundImage="url('"+y+"')",R.style.height=g+"px",R.style.width=p+"px",s.appendChild(R)}else k=!1;z++,u++}d++}r.allTilesLoaded[e]=k,t.Events.publish("PageDidLoad",[e,i,a],l)}},w=function(e){if(!(m(e)&&r.allTilesLoaded[e]||r.inBookLayout&&r.documentPaged&&!r.pages[e].paged)){var i=r.pages[e].f,n=c(e,"w"),o=c(e,"h"),a=r.pageTopOffsets[e]+r.verticalPadding,s=r.pageLeftOffsets[e]+r.horizontalPadding,d=r.selector+"page-"+e;if(!m(e)){var u=document.getElementById(r.ID+"inner"),g=document.createElement("div");if(g.id=r.ID+"page-"+e,g.classList.add("diva-page","diva-document-page"),g.setAttribute("data-index",e),g.setAttribute("data-filename",i),r.enableImageTitles&&(g.title="Page "+(e+1)),g.innerHTML=r.pageTools,g.style.width=n+"px",g.style.height=o+"px",r.verticallyOriented)if(g.style.top=a+"px",r.inBookLayout)if(g.style.left=s+"px",e%2)g.classList.add("diva-page-book-left");else{if(0===e){var h=document.createElement("div");h.id=r.ID+"page-placeholder",h.classList.add("diva-page","diva-document-page"),h.style.width=n+"px",h.style.height=o+"px",h.style.left=0-n+"px",h.style.border="1px solid #ccc",h.style.background="#fdfdfd",h.style.mozBoxSizing="border-box",h.style.webkitBoxSizing="border-box",h.style.boxSizing="border-box",g.appendChild(h)}g.classList.add("diva-page-book")}else g.classList.add("diva-page-vertical");else g.style.left=s+"px",g.classList.add("diva-page-horizontal");u.appendChild(g),t.Events.publish("PageWillLoad",[e,i,d],l)}r.pageTimeouts.push(setTimeout(b,r.pageLoadTimeout,e,i,n,o))}},y=function(e){var t=document.getElementById(r.ID+"page-"+e);if(null!==t){for(;t.firstChild;)t.removeChild(t.firstChild);t.parentNode.removeChild(t)}},I=function(e){var t=r.pageTopOffsets[e]+c(e,"h")+r.verticalPadding,i=document.getElementById(r.ID+"outer").scrollTop;return i>t},x=function(e){var t=r.pageTopOffsets[e],i=document.getElementById(r.ID+"outer").scrollTop+r.panelHeight;return t>i},P=function(e){var t=r.pageLeftOffsets[e]+c(e,"w")+r.horizontalPadding,i=document.getElementById(r.ID+"outer").scrollLeft;return i>t},D=function(e){var t=r.pageLeftOffsets[e],i=document.getElementById(r.ID+"outer").scrollLeft+r.panelWidth;return t>i},L=function(e){return r.verticallyOriented?I(e):P(e)},O=function(e){return r.verticallyOriented?x(e):D(e)},C=function(e,t){p(e)&&(t>0?f(e)?(w(e),r.lastPageLoaded=e,C(r.lastPageLoaded+1,t)):p(e+1)&&f(e+1)?(w(e+1),r.lastPageLoaded=e+1,C(r.lastPageLoaded+1,t)):L(e)&&C(e+1,t):f(e)?(w(e),r.firstPageLoaded=e,C(r.firstPageLoaded-1,t)):p(e-1)&&f(e-1)?(w(e-1),r.firstPageLoaded=e-1,C(r.firstPageLoaded-1,t)):O(e)&&C(e-1,t))},T=function(e,t){t>0?p(e)&&L(e)&&(y(e),r.firstPageLoaded=e+1,T(r.firstPageLoaded,t)):p(e)&&O(e)&&(y(e),r.lastPageLoaded=e-1,T(r.lastPageLoaded,t))},E=function(e){var i;if(0>e)C(r.lastPageLoaded,e),_(-1),T(r.lastPageLoaded,e);else if(e>0)C(r.firstPageLoaded,e),_(1),T(r.firstPageLoaded,e);else{r.inBookLayout&&_(0);var n=r.lastPageLoaded;for(i=Math.max(r.firstPageLoaded,0);n>=i;i++)f(i)&&w(i)}var o=r.verticallyOriented?document.getElementById(r.ID+"outer").scrollTop:document.getElementById(r.ID+"outer").scrollLeft;t.Events.publish("ViewerDidScroll",[o],l),e>0?t.Events.publish("ViewerDidScrollDown",[o],l):0>e&&t.Events.publish("ViewerDidScrollUp",[o],l)},S=function(e){return e>=0&&e<r.numRows},k=function(e){var t=r.rowHeight*e,i=t+r.rowHeight+r.fixedPadding;return g(t,i)},z=function(e){return!!document.getElementById(r.ID+"row-"+e)},M=function(e){if(!z(e)){var i=r.rowHeight*e+r.fixedPadding,n=document.getElementById(r.ID+"inner"),o=document.createElement("div");o.id=r.ID+"row-"+e,o.classList.add("diva-row"),o.style.height=r.rowHeight+"px",o.style.top=i+"px",n.appendChild(o);var a,s,d,u,g,h,v,f,m,b,w,y,I=r.imageDir+"/",x=r.pagesPerRow;for(a=0;x>a&&(s=e*r.pagesPerRow+a,p(s));a++){d=r.pages[s].f,u=c(s,"w"),g=c(s,"h"),h=r.fixedHeightGrid?(r.rowHeight-r.fixedPadding)*u/g:r.gridPageWidth,v=r.fixedHeightGrid?r.rowHeight-r.fixedPadding:h/u*g,f=parseInt(a*(r.fixedPadding+r.gridPageWidth)+r.fixedPadding,10),b=r.pages[s].api,w=b>=2?"default":"native",y=",/0/"+w+".jpg",h=parseInt(h,10),v=parseInt(v,10),f+=r.fixedHeightGrid?(r.gridPageWidth-h)/2:0,m=r.isIIIF?encodeURI(r.pages[s].url+"full/"+h+y):encodeURI(r.iipServerURL+"?FIF="+I+d+"&HEI="+(v+2)+"&CVT=JPEG"),r.pageTopOffsets[s]=i,r.pageLeftOffsets[s]=f;var P=document.createElement("div");P.id=r.ID+"page-"+s;var D=r.selector+"page-"+s;P.classList.add("diva-page","diva-grid-page"),P.style.width=h+"px",P.style.height=v+"px",P.style.left=f+"px",P.setAttribute("data-index",s),P.setAttribute("data-filename",d),r.enableImageTitles&&(P.title="Page "+(s+1)),o.appendChild(P),t.Events.publish("PageWillLoad",[s,d,D],l),Z(e,s,m,h,v)}}},j=function(e){var t=document.getElementById(r.ID+"row-"+e);if(null!==t){for(;t.firstChild;)t.removeChild(t.firstChild);t.parentNode.removeChild(t)}},A=function(e){var t=r.rowHeight*(e+1),i=document.getElementById(r.ID+"outer").scrollTop;return i>t},F=function(e){var t=r.rowHeight*e,i=document.getElementById(r.ID+"outer").scrollTop+r.panelHeight;return t>i},H=function(e,t){t>0?S(e)&&(k(e)?(M(e),r.lastRowLoaded=e,H(r.lastRowLoaded+1,t)):A(e)&&H(e+1,t)):S(e)&&(k(e)?(M(e),r.firstRowLoaded=e,H(r.firstRowLoaded-1,t)):F(e)&&H(e-1,t))},B=function(e,t){t>0?S(e)&&A(e)&&(j(e),r.firstRowLoaded++,B(r.firstRowLoaded,t)):S(e)&&F(e)&&(j(e),r.lastRowLoaded--,B(r.lastRowLoaded,t))},R=function(e){0>e?(H(r.firstRowLoaded,-1),N(-1),B(r.lastRowLoaded,-1)):e>0&&(H(r.lastRowLoaded,1),N(1),B(r.firstRowLoaded,1));var i=document.getElementById(r.ID+"outer").scrollTop;t.Events.publish("ViewerDidScroll",[i],l),e>0?t.Events.publish("ViewerDidScrollDown",[i],l):0>e&&t.Events.publish("ViewerDidScrollUp",[i],l)},Z=function(e,t,i,n,o){var a=function(e,t,i,n,o){if(m(t)){var a=document.createElement("img");a.src=i,a.style.width=n+"px",a.style.height=o+"px",document.getElementById(r.ID+"page-"+t).appendChild(a)}};r.pageTimeouts.push(window.setTimeout(a,r.rowLoadTimeout,e,t,i,n,o))},W=function(e,t){var i=r.numPages;if(r.documentPaged&&r.inBookLayout)for(;e>0&&i>e;){if(r.pages[e].paged)return e;e+=t}return e},_=function(e){var i=r.currentPageIndex,n=i+e;if(n=W(n,e),!p(n))return!1;var o=r.verticallyOriented?document.getElementById(r.ID+"outer").scrollTop+r.panelHeight/2:document.getElementById(r.ID+"outer").scrollLeft+r.panelWidth/2,a=document.getElementById(r.ID+"outer").scrollLeft+r.panelWidth/2,s=!1;if(0>e?r.verticallyOriented?n>=0&&r.pageTopOffsets[n]+c(n,"h")+r.verticalPadding>=o&&(s=!0):n>=0&&r.pageLeftOffsets[n]+c(n,"w")+r.horizontalPadding>=o&&(s=!0):e>0&&(r.verticallyOriented?r.pageTopOffsets[i]+c(i,"h")+r.verticalPadding<o&&(s=!0):r.pageLeftOffsets[i]+c(i,"w")+r.horizontalPadding<o&&(s=!0)),r.inBookLayout&&r.verticallyOriented){var d,u=a>r.maxWidths[r.zoomLevel],g=u?1:-1,h=i+g;h=W(h,g),d=u?r.pageLeftOffsets[h]>=r.maxWidths[r.zoomLevel]/2:r.pageLeftOffsets[h]<r.maxWidths[r.zoomLevel]/2,d&&h!==r.currentPageIndex&&(r.currentPageIndex=h,t.Events.publish("VisiblePageDidChange",[h,r.pages[h].f],l))}if(s){if(r.currentPageIndex=n,0!==e&&!_(e)){var v=r.pages[n].f;t.Events.publish("VisiblePageDidChange",[n,v],l)}return!0}return!1},N=function(e){var i=Math.floor(r.currentPageIndex/r.pagesPerRow),n=i+parseInt(e,10),o=document.getElementById(r.ID+"outer").scrollTop,a=o+r.panelHeight/2,s=!1;if(0>e?n>=0&&(r.rowHeight*i>=a||r.rowHeight*n>=o)&&(s=!0):e>0&&r.rowHeight*(i+1)<o&&S(n)&&(s=!0),s){if(r.currentPageIndex=n*r.pagesPerRow,0!==e&&!N(e)){var c=r.currentPageIndex,d=r.pages[c].f;t.Events.publish("VisiblePageDidChange",[c,d],l)}return!0}return!1},V=function(e){var t=ge(e,"top"),i=he(e,"center");G(e,t,i)},G=function(e,i,n){n="undefined"!=typeof n?n:0,i="undefined"!=typeof i?i:0;var o=r.pageTopOffsets[e]+i,a=o-parseInt(r.panelHeight/2,10),s=r.pageLeftOffsets[e]+n,c=s-parseInt(r.panelWidth/2,10);if(r.outerObject.scrollTop(a),r.outerObject.scrollLeft(c),e!==r.currentPageIndex){r.currentPageIndex=e;var d=r.pages[e].f;t.Events.publish("VisiblePageDidChange",[e,d],l)}t.Events.publish("ViewerDidJump",[e],l)},Y=function(e){var i=Math.floor(e/r.pagesPerRow),n=i*r.rowHeight;r.outerObject.scrollTop(n),r.currentPageIndex=e;var o=r.pages[e].f;t.Events.publish("VisiblePageDidChange",[e,o],l)},X=function(){Y(r.goDirectlyTo)},U=function(e){return e>=r.minZoomLevel&&e<=r.maxZoomLevel?e:r.minZoomLevel},q=function(e){return e>=r.minPagesPerRow&&e<=r.maxPagesPerRow?e:r.maxPagesPerRow},K=function(){for(r.allTilesLoaded=[],r.outerObject.scrollTop(0),r.innerObject.empty(),r.firstPageLoaded=0,r.firstRowLoaded=-1,r.previousTopScroll=0,r.previousLeftScroll=0,clearTimeout(r.resizeTimer);r.pageTimeouts.length;)clearTimeout(r.pageTimeouts.pop())},$=function(){r.inGrid?ee():Q()},J=function(e,t){var i,n=0,o=0;if(r.pageTopOffsets=[],r.pageLeftOffsets=[],r.inBookLayout){var a=!1;if(r.verticallyOriented)for(i=0;i<r.numPages;i++){if(r.pageTopOffsets[i]=n,a)r.pageLeftOffsets[i]=e/2-c(i,"w")-r.horizontalPadding;else if(r.pageLeftOffsets[i]=e/2-r.horizontalPadding,!r.documentPaged||r.pages[i].paged){var s=p(i-1)?Math.max(c(i,"h"),c(i-1,"h")):c(i,"h");n=r.pageTopOffsets[i]+s+r.verticalPadding}(!r.documentPaged||r.pages[i].paged)&&(a=!a)}else for(i=0;i<r.numPages;i++){r.pageTopOffsets[i]=parseInt((t-c(i,"h"))/2,10),r.pageLeftOffsets[i]=o;var l=c(i,"w"),d=a?0:r.horizontalPadding;o=r.pageLeftOffsets[i]+l+d,(!r.documentPaged||r.pages[i].paged)&&(a=!a)}}else for(i=0;i<r.numPages;i++)r.pageTopOffsets[i]=parseInt(r.verticallyOriented?n:(t-c(i,"h"))/2,10),r.pageLeftOffsets[i]=parseInt(r.verticallyOriented?(e-c(i,"w"))/2:o,10),n=r.pageTopOffsets[i]+c(i,"h")+r.verticalPadding,o=r.pageLeftOffsets[i]+c(i,"w")+r.horizontalPadding},Q=function(){K(),r.zoomLevel=U(r.zoomLevel);var e=r.zoomLevel;r.totalHeight=r.totalHeights[e]+r.verticalPadding*(r.numPages+1),r.totalWidth=r.totalWidths[e]+r.horizontalPadding*(r.numPages+1);var i=r.inBookLayout?2*(r.maxWidths[e]+r.horizontalPadding):r.maxWidths[e]+2*r.horizontalPadding,n=r.maxHeights[e]+2*r.verticalPadding,o=Math.max(i,r.panelWidth),a=Math.max(n,r.panelHeight),s=document.getElementById(r.ID+"inner");r.verticallyOriented?(s.style.height=Math.round(r.totalHeight)+"px",s.style.width=Math.round(o)+"px"):(s.style.height=Math.round(a)+"px",s.style.width=Math.round(r.totalWidth)+"px"),J(o,a);var d=r.numPages-1;if(r.inBookLayout)if(r.verticallyOriented){var u=d%2||0===d?c(d,"h"):Math.max(c(d,"h"),c(d-1,"h"));s.style.height=r.pageTopOffsets[d]+u+2*r.verticalPadding+"px"}else s.style.width=r.pageLeftOffsets[d]+c(d,"w")+2*r.horizontalPadding+"px";p(r.goDirectlyTo)||(r.goDirectlyTo=0),G(r.goDirectlyTo,r.verticalOffset,r.horizontalOffset);for(var g=!1,h=0;h<r.numPages;h++)if(f(h))w(h),r.lastPageLoaded=h,g=!0;else if(g)break;r.oldZoomLevel>=0?(r.oldZoomLevel<r.zoomLevel?t.Events.publish("ViewerDidZoomIn",[e],l):t.Events.publish("ViewerDidZoomOut",[e],l),t.Events.publish("ViewerDidZoom",[e],l)):r.oldZoomLevel=r.zoomLevel,r.scaleWait&&(r.scaleWait=!1);var v=r.pages[r.currentPageIndex].f;t.Events.publish("DocumentDidLoad",[r.currentPageIndex,v],l)},ee=function(){var e=r.currentPageIndex;r.verticalOffset=r.verticallyOriented?r.panelHeight/2:c(e,"h")/2,r.horizontalOffset=r.verticallyOriented?c(e,"w")/2:r.panelWidth/2,K(),r.pagesPerRow=q(r.pagesPerRow);var t=r.fixedPadding*(r.pagesPerRow+1),i=(r.panelWidth-t)/r.pagesPerRow;r.gridPageWidth=i,r.rowHeight=r.fixedHeightGrid?r.fixedPadding+r.minRatio*i:r.fixedPadding+r.maxRatio*i,r.numRows=Math.ceil(r.numPages/r.pagesPerRow),r.totalHeight=r.numRows*r.rowHeight+r.fixedPadding;var n=document.getElementById(r.ID+"inner");n.style.height=Math.round(r.totalHeight)+"px",n.style.width=Math.round(r.panelWidth)+"px",X();var o,a;r.pageTopOffsets=[],r.pageLeftOffsets=[];var s=r.numPages;for(o=0;s>o;o+=r.pagesPerRow)a=Math.floor(o/r.pagesPerRow),k(a)&&(r.firstRowLoaded=r.firstRowLoaded<0?a:r.firstRowLoaded,M(a),r.lastRowLoaded=a)},te=function(e){27==e.keyCode&&oe()},ie=function(i){r.outerObject.toggleClass("diva-fullscreen"),e("body").toggleClass("diva-hide-scrollbar"),r.parentObject.toggleClass("diva-full-width");var n=r.panelHeight,o=r.panelWidth;if(we(),r.oldZoomLevel>=0&&!r.inGrid){var a=r.panelHeight,s=r.panelWidth;r.inFullscreen?(r.verticalOffset-=(a-n)/2,r.horizontalOffset-=(s-o)/2):(r.verticalOffset+=(n-a)/2,r.horizontalOffset+=(o-s)/2)}i?(r.inGrid=!r.inGrid,ne()):$(),r.inFullscreen?e(document).on("keyup",te):e(document).off("keyup",te),t.Events.publish("ModeDidSwitch",[r.inFullscreen],l)},ne=function(){return $(),t.Events.publish("ViewDidSwitch",[r.inGrid],l),!0},oe=function(){r.goDirectlyTo=r.currentPageIndex,r.inFullscreen=!r.inFullscreen,ie(!1)},ae=function(e){switch(r.goDirectlyTo=r.currentPageIndex,e){case"document":r.inGrid=!1,r.inBookLayout=!1;break;case"book":r.inGrid=!1,r.inBookLayout=!0;break;case"grid":r.inGrid=!0;break;default:return!1}return ne()},re=function(){return r.verticallyOriented=!r.verticallyOriented,r.verticalOffset=ge(),r.horizontalOffset=he(),r.goDirectlyTo=r.currentPageIndex,r.inGrid?(r.inGrid=!1,ne()):Q(),r.verticallyOriented},se=function(t){var i=e(this).offset();r.doubleClickZoom=!0,r.horizontalOffset=t.pageX-i.left,r.verticalOffset=t.pageY-i.top,r.goDirectlyTo=parseInt(e(this).attr("data-index"),10);var n=t.ctrlKey?r.zoomLevel-1:r.zoomLevel+1;de(n)},le=function(t){var i=parseInt(e(this).attr("data-index"),10);r.goDirectlyTo=i;var n=e(this).offset(),o=c(i,"w")/e(this).width();r.horizontalOffset=(t.pageX-n.left)*o,r.verticalOffset=(t.pageY-n.top)*o,r.inGrid=!1,ne()},ce=function(t,i){var n=r.zoomLevel;if(t>100&&n<r.maxZoomLevel)n++;else{if(!(-100>t&&n>r.minZoomLevel))return;n--}r.scaleWait=!0;var o=e(this).offset();r.horizontalOffset=i.pageX-o.left,r.verticalOffset=i.pageY-o.top,r.goDirectlyTo=parseInt(e(this).attr("data-index"),10),de(n)},de=function(e){var i=U(e);if(i!==e)return!1;var n=Math.pow(2,i-r.zoomLevel);return r.doubleClickZoom?(r.verticalOffset*=n,r.horizontalOffset*=n,r.doubleClickZoom=!1):(r.goDirectlyTo=r.currentPageIndex,r.verticalOffset=n*ve(),r.horizontalOffset=n*pe()),r.oldZoomLevel=r.zoomLevel,r.zoomLevel=i,t.Events.publish("ZoomLevelDidChange",[i],l),Q(),!0},ue=function(e){var i=q(e);return i!==e?!1:(r.pagesPerRow=i,t.Events.publish("GridRowNumberDidChange",[i],l),r.goDirectlyTo=r.currentPageIndex,ee(),!0)},ge=function(e,t){return e="undefined"==typeof e?r.currentPageIndex:e,"center"===t||"centre"===t?parseInt(c(e,"h")/2,10):"bottom"===t?parseInt(c(e,"h")-r.panelHeight/2,10):parseInt(r.panelHeight/2,10)},he=function(e,t){return e="undefined"==typeof e?r.currentPageIndex:e,"left"===t?parseInt(r.panelWidth/2,10):"right"===t?parseInt(c(e,"w")-r.panelWidth/2,10):parseInt(c(e,"w")/2,10)},ve=function(){var e=document.getElementById(r.ID+"outer").scrollTop,t=r.panelHeight;return e-r.pageTopOffsets[r.currentPageIndex]+parseInt(t/2,10)},pe=function(){var e=document.getElementById(r.ID+"outer").scrollLeft,t=r.panelWidth;return e-r.pageLeftOffsets[r.currentPageIndex]+parseInt(t/2,10)},fe=function(){var e;e=r.inGrid?"g":r.inBookLayout?"b":"d";
var t={f:r.inFullscreen,v:e,z:r.zoomLevel,n:r.pagesPerRow,i:r.enableFilename?r.pages[r.currentPageIndex].f:!1,p:r.enableFilename?!1:r.currentPageIndex+1,y:r.inGrid?!1:ve(),x:r.inGrid?!1:pe()};return t},me=function(){var e,t=fe(),i=[];for(e in t)t[e]!==!1&&i.push(e+r.hashParamSuffix+"="+encodeURIComponent(t[e]));return i.join("&")},be=function(){return location.protocol+"//"+location.host+location.pathname+location.search+"#"+me()},we=function(){var e=document.getElementById(r.ID+"outer");return r.panelHeight=e.clientHeight-(e.scrollWidth>e.clientWidth?r.scrollbarWidth:0),r.panelWidth=e.clientWidth-(e.scrollHeight>e.clientHeight?r.scrollbarWidth:0),r.horizontalOffset=pe(),r.verticalOffset=ve(),G(r.currentPageIndex,r.verticalOffset,r.horizontalOffset),!0},ye=function(){r.outerObject.dragscrollable({dragSelector:".diva-dragger",acceptPropagatedEvent:!0}),r.innerObject.dragscrollable({dragSelector:".diva-dragger",acceptPropagatedEvent:!0}),r.outerObject.on("dblclick",".diva-document-page",function(e){se.call(this,e)}),r.outerObject.on("contextmenu",".diva-document-page",function(e){return e.ctrlKey?(clearTimeout(r.singleClickTimeout),r.singleClick?(se.call(this,e),r.singleClick=!1):(r.singleClick=!0,r.singleClickTimeout=setTimeout(function(){r.singleClick=!1},500)),!1):void 0}),r.outerObject.on("dblclick",".diva-row",function(t){le.call(e(t.target).parent(),t)})},Ie=function(){we(),clearTimeout(r.resizeTimer),r.resizeTimer=setTimeout(function(){r.goDirectlyTo=r.currentPageIndex,r.verticalOffset=ve(),r.horizontalOffset=pe(),$()},200)},xe=function(){r.blockMobileMove&&e("body").bind("touchmove",function(e){var t=e.originalEvent;return t.preventDefault(),!1}),r.outerObject.kinetic({triggerHardware:!0});var t=[],i=[],n=0;r.outerObject.on("touchstart",".diva-document-page",function(e){e.preventDefault(),2===e.originalEvent.touches.length&&(t=[e.originalEvent.touches[0].clientX,e.originalEvent.touches[0].clientY,e.originalEvent.touches[1].clientX,e.originalEvent.touches[1].clientY],n=Pe(t[2],t[0],t[3],t[1]))}),r.outerObject.on("touchmove",".diva-document-page",function(e){if(e.preventDefault(),2===e.originalEvent.touches.length){i=[e.originalEvent.touches[0].clientX,e.originalEvent.touches[0].clientY,e.originalEvent.touches[1].clientX,e.originalEvent.touches[1].clientY];var t=Pe(i[2],i[0],i[3],i[1]),o=t-n;r.scaleWait||(r.goDirectlyTo=r.currentPageIndex,r.inGrid?(r.inGrid=!1,ne()):ce.call(this,o,e))}});var o={},a=0,s=function(t){if(t.preventDefault(),r.singleTap){var i={pageX:t.originalEvent.changedTouches[0].clientX,pageY:t.originalEvent.changedTouches[0].clientY};a=Pe(o.pageX,i.pageX,o.pageY,i.pageY),50>a&&r.zoomLevel<r.maxZoomLevel&&(r.inGrid?le.call(e(t.target).parent(),i):se.call(this,i)),r.singleTap=!1,o={}}else r.singleTap=!0,o.pageX=t.originalEvent.changedTouches[0].clientX,o.pageY=t.originalEvent.changedTouches[0].clientY,r.singleTapTimeout=setTimeout(function(){r.singleTap=!1,o={}},250)};r.outerObject.on("touchend",".diva-page",s)},Pe=function(e,t,i,n){return Math.sqrt((e-t)*(e-t)+(i-n)*(i-n))},De=function(){r.innerObject.mouseover(function(){e(this).removeClass("diva-grabbing").addClass("diva-grab")}),r.innerObject.mouseout(function(){e(this).removeClass("diva-grab")}),r.innerObject.mousedown(function(){e(this).removeClass("diva-grab").addClass("diva-grabbing")}),r.innerObject.mouseup(function(){e(this).removeClass("diva-grabbing").addClass("diva-grab")}),ye();var i=function(){var e,t=document.getElementById(r.ID+"outer").scrollTop,i=document.getElementById(r.ID+"outer").scrollLeft;e=r.verticallyOriented||r.inGrid?t-r.previousTopScroll:i-r.previousLeftScroll,r.inGrid?R(e):E(e),r.previousTopScroll=t,r.previousLeftScroll=i,r.horizontalOffset=pe(),r.verticalOffset=ve()};r.outerObject.scroll(i);var n=38,o=40,a=37,s=39,l=32,c=33,d=34,u=36,g=35;e(document).on("keydown.diva",function(e){if(!r.isActiveDiva)return!0;if(r.enableSpaceScroll&&!e.shiftKey&&e.keyCode===l||r.enableKeyScroll&&e.keyCode===d)return r.outerObject.scrollTop(document.getElementById(r.ID+"outer").scrollTop+r.panelHeight),!1;if(r.enableSpaceScroll||e.keyCode!==l||e.preventDefault(),r.enableKeyScroll){if(e.shiftKey||e.ctrlKey||e.metaKey)return!0;switch(e.keyCode){case c:return r.outerObject.scrollTop(document.getElementById(r.ID+"outer").scrollTop-r.panelHeight),!1;case n:return r.outerObject.scrollTop(document.getElementById(r.ID+"outer").scrollTop-r.arrowScrollAmount),!1;case o:return r.outerObject.scrollTop(document.getElementById(r.ID+"outer").scrollTop+r.arrowScrollAmount),!1;case a:return r.outerObject.scrollLeft(document.getElementById(r.ID+"outer").scrollLeft-r.arrowScrollAmount),!1;case s:return r.outerObject.scrollLeft(document.getElementById(r.ID+"outer").scrollLeft+r.arrowScrollAmount),!1;case u:return r.outerObject.scrollTop(0),!1;case g:return r.outerObject.scrollTop(r.totalHeight),!1;default:return!0}}return!0}),t.Events.subscribe("ViewerDidTerminate",function(){e(document).off("keydown.diva")},r.ID),xe(),window.addEventListener("resize",Ie,!1),t.Events.subscribe("ViewerDidTerminate",function(){window.removeEventListener("resize",Ie,!1)},r.ID),"onorientationchange"in window&&(window.addEventListener("orientationchange",Ie,!1),t.Events.subscribe("ViewerDidTerminate",function(){window.removeEventListener("orientationchange",Ie,!1)},r.ID)),t.Events.subscribe("PanelSizeDidChange",we,r.ID)},Le=function(e,t){var i=document.createElement("span");return i.id=r.ID+e,i.setAttribute("class","diva-"+e+" diva-button"),i.title=t,i},Oe=function(){var e=document.createElement("div");e.id=r.ID+"view-menu",e.className="diva-view-menu";var t=Le("view-icon","Change view");e.appendChild(t);var i=document.createElement("div");return i.id=r.ID+"view-options",i.className="diva-view-options",e.appendChild(i),e},Ce=function(e,t,i,n){var o=document.createElement("input");return o.id=r.ID+e,o.className=e,o.setAttribute("type","range"),o.setAttribute("value",t),o.setAttribute("min",i),o.setAttribute("max",n),o},Te=function(e,t,i,n,o){var a=document.createElement("div");a.id=r.ID+t,a.className=e+" diva-label";var s=document.createTextNode(i);a.appendChild(s);var l=document.createElement("span");l.id=r.ID+n;var c=document.createTextNode(o);return l.appendChild(c),a.appendChild(l),a},Ee=function(e){var t=document.createElement("span");t.className=e+" diva-label";var i=document.createTextNode("Page "),n=document.createElement("span");n.id=r.ID+"current-page";var o=document.createTextNode(" of "),a=document.createElement("span");return a.id=r.ID+"num-pages",t.appendChild(i),t.appendChild(n),t.appendChild(o),t.appendChild(a),t},Se=function(){var i=document.createElement("div");i.id=r.ID+"tools",i.className="diva-tools";var n=document.createElement("div");n.id=r.ID+"tools-left",n.className="diva-tools-left";var o=document.createElement("div");if(o.id=r.ID+"tools-right",o.className="diva-tools-right","slider"===r.enableZoomControls){var a=Ce("zoom-slider",r.zoomLevel,r.minZoomLevel,r.maxZoomLevel);n.appendChild(a)}else"buttons"===r.enableZoomControls&&(n.appendChild(Le("zoom-out-button","Zoom Out")),n.appendChild(Le("zoom-in-button","Zoom In")));if("slider"===r.enableGridControls){var s=Ce("grid-slider",r.pagesPerRow,r.minPagesPerRow,r.maxPagesPerRow);n.appendChild(s)}else"buttons"===r.enableGridControls&&(n.appendChild(Le("grid-out-button","Zoom Out")),n.appendChild(Le("grid-in-button","Zoom In")));if("slider"===r.enableZoomControls||"buttons"===r.enableZoomControls){var c=Te("diva-zoom-label","zoom-label","Zoom level: ","zoom-level",r.zoomLevel);n.appendChild(c)}if("slider"===r.enableGridControls||"buttons"===r.enableGridControls){var d=Te("diva-grid-label","grid-label","Pages per row: ","pages-per-row",r.pagesPerRow);n.appendChild(d)}var u=document.createElement("span");u.id=r.ID+"page-nav",u.className="diva-page-nav";var g=Ee("diva-page-label");if(u.appendChild(g),r.enableGotoPage){var h=document.createElement("form");h.id=r.ID+"goto-page",h.className="diva-goto-form";var v=document.createElement("input");v.id=r.ID+"goto-page-input",v.className="diva-input",v.setAttribute("type","text"),h.appendChild(v);var f=document.createElement("input");f.setAttribute("type","submit"),f.setAttribute("value","Go"),h.appendChild(f),u.appendChild(h)}o.appendChild(u);var m=Oe();if(o.appendChild(m),r.enableLinkIcon){var b=Le("link-icon","Link to this page");o.appendChild(b)}if(r.enableFullscreen){var w=Le("fullscreen-icon","Toggle fullscreen mode");o.appendChild(w)}i.appendChild(n),i.appendChild(o),r.toolbarParentObject.prepend(i);var y=function(){var e=document.createDocumentFragment(),t=Le("document-icon","Document View"),i=Le("book-icon","Book View"),n=Le("grid-icon","Grid View"),o=document.getElementById(r.ID+"view-icon"),a=" diva-view-icon diva-button";r.inGrid?o.className="diva-grid-icon"+a:r.inBookLayout?o.className="diva-book-icon"+a:o.className="diva-document-icon"+a,(r.inGrid||r.inBookLayout)&&e.appendChild(t),(r.inGrid||!r.inBookLayout)&&e.appendChild(i),r.inGrid||e.appendChild(n);for(var s=document.getElementById(r.ID+"view-options");s.firstChild;)s.removeChild(s.firstChild);s.appendChild(e)};e(r.selector+"zoom-slider").on("input",function(e){var t=parseInt(this.value,10);de(t)}),e(r.selector+"zoom-slider").on("change",function(e){var t=parseInt(this.value,10);t!==r.zoomLevel&&de(t)});var I=function(e){de(r.zoomLevel+e)};e(r.selector+"zoom-out-button").click(function(){I(-1)}),e(r.selector+"zoom-in-button").click(function(){I(1)}),e(r.selector+"grid-slider").on("input",function(e){var t=parseInt(this.value,10);ue(t)}),e(r.selector+"grid-slider").on("change",function(e){var t=parseInt(this.value,10);t!==r.zoomLevel&&ue(t)}),e(r.selector+"fullscreen-icon").click(function(){oe()}),e(r.selector+"grid-out-button").click(function(){ue(r.pagesPerRow-1)}),e(r.selector+"grid-in-button").click(function(){ue(r.pagesPerRow+1)}),e(r.selector+"view-icon").click(function(){e(r.selector+"view-options").toggle()}),e(r.selector+"view-options").on("click",".diva-button",function(i){var n,o=i.target.classList[0];"diva-document-icon"===o?n="document":"diva-book-icon"===o?n="book":"diva-grid-icon"===o&&(n="grid"),t.Events.publish("UserDidChooseView",[n],l),e(r.selector+"view-options").hide()}),t.Events.subscribe("UserDidChooseView",ae,r.ID),e(document).mouseup(function(t){var i=e(r.selector+"view-options");i.is(t.target)||0!==i.has(t.target).length||t.target.id===r.ID+"view-icon"||i.hide()}),e(r.selector+"goto-page").submit(function(){var t=parseInt(e(r.selector+"goto-page-input").val(),10),i=t-1;return p(i)?r.inGrid?Y(i):V(i):alert("Invalid page number"),!1});var x=e(r.selector+"link-icon");x.click(function(){if(e("body").prepend('<div id="'+r.ID+'link-popup" class="diva-popup diva-link-popup"><input id="'+r.ID+'link-popup-input" class="diva-input" type="text" value="'+be()+'"/></div>'),r.inFullscreen)e(r.selector+"link-popup").addClass("in-fullscreen");else{var t=x.offset().left-222+x.outerWidth(),i=x.offset().top+x.outerHeight()-1;e(r.selector+"link-popup").removeClass("in-fullscreen").css({top:i+"px",left:t+"px"})}return e("body").mouseup(function(t){var i=t.target.id;i!==r.ID+"link-popup"&&i!==r.ID+"link-popup-input"&&e(r.selector+"link-popup").remove()}),r.outerObject.scroll(function(){e(r.selector+"link-popup").remove()}),e(r.selector+"link-popup input").click(function(){e(this).focus().select()}),!1});var P=r.inGrid?"grid":"zoom";e(r.selector+P+"-slider").css("display","inline-block"),e(r.selector+P+"-out-button").css("display","inline-block"),e(r.selector+P+"-in-button").css("display","inline-block");var D=r.inFullscreen?"block":"inline-block";e(r.selector+P+"-label").css("display",D);var L={updateCurrentPage:function(){document.getElementById(r.ID+"current-page").textContent=parseInt(r.currentPageIndex,10)+1},setNumPages:function(e){document.getElementById(r.ID+"num-pages").textContent=e},updateZoomLabel:function(){"slider"===r.enableZoomControls&&r.zoomLevel!==e(r.selector+"zoom-slider").val()&&e(r.selector+"zoom-slider").val(r.zoomLevel),document.getElementById(r.ID+"zoom-level").textContent=r.zoomLevel.toString()},updateGridLabel:function(){"slider"===r.enableGridControls&&r.pagesPerRow!==e(r.selector+"grid-slider").val()&&e(r.selector+"grid-slider").val(r.pagesPerRow),document.getElementById(r.ID+"pages-per-row").textContent=r.pagesPerRow},closePopups:function(){e(".diva-popup").css("display","none")},switchView:function(t){e(r.selector+P+"-slider").hide(),e(r.selector+P+"-out-button").hide(),e(r.selector+P+"-in-button").hide(),e(r.selector+P+"-label").hide(),P=r.inGrid?"grid":"zoom",e(r.selector+P+"-slider").css("display","inline-block"),e(r.selector+P+"-out-button").css("display","inline-block"),e(r.selector+P+"-in-button").css("display","inline-block");var i=r.inFullscreen?"block":"inline-block";e(r.selector+P+"-label").css("display",i)},switchMode:function(){var t,i=document.getElementById(r.ID+"tools-right"),n=document.getElementById(r.ID+"page-nav");r.inFullscreen?(e(r.selector+"tools").addClass("diva-fullscreen-tools"),i.removeChild(n),i.appendChild(n),P=r.inGrid?"grid":"zoom",t=r.inFullscreen?"block":"inline-block",e(r.selector+P+"-label").css("display",t)):(e(r.selector+"tools").removeClass("diva-fullscreen-tools"),i.removeChild(n),i.insertBefore(n,i.firstChild),P=r.inGrid?"grid":"zoom",t=r.inFullscreen?"block":"inline-block",e(r.selector+P+"-label").css("display",t))},displayViewMenu:y};return L},ke=function(){if(window.divaPlugins){var t=[];e.each(window.divaPlugins,function(e,i){var n=i.pluginName[0].toUpperCase()+i.pluginName.substring(1);if(r["enable"+n]){var o=i.init(r,l);if(!o)return;var a=i.titleText||n+" plugin";if("function"==typeof i.handleClick){t.push('<div class="diva-'+i.pluginName+'-icon" title="'+a+'"></div>');var s=".diva-"+i.pluginName+"-icon";r.outerObject.on("click",s,function(e){i.handleClick.call(this,e,r,l)}),r.outerObject.on("touchend",s,function(e){e.preventDefault(),i.handleClick.call(this,e,r,l)})}r.plugins.push(i)}}),t.length&&(r.pageTools='<div class="diva-page-tools">'+t.join("")+"</div>")}},ze=function(){clearTimeout(r.throbberTimeoutID),e(r.selector+"throbber").hide()},Me=function(e){var t=e;switch(t){case"d":r.inGrid=!1,r.inBookLayout=!1;break;case"b":r.inGrid=!1,r.inBookLayout=!0;break;case"g":r.inGrid=!0,r.inBookLayout=!1}},je=function(e){var t=e["@id"],i=/#xywh=([0-9]+,[0-9]+,[0-9]+,[0-9]+)/,n="",o=!0;if(/\/([0-9]+,[0-9]+,[0-9]+,[0-9]+)\//.test(t)){var a=t.split("/");n=a[a.length-4]}else if(i.test(t)){var r=i.exec(t);n=r[1]}else e.service&&e.service["@id"]&&(t=e.service["@id"],o=!1);o&&(t=t.split("/").slice(0,-4).join("/"));var s={url:t};if(n.length){var l=n.split(",");s.x=parseInt(l[0],10),s.y=parseInt(l[1],10),s.w=parseInt(l[2],10),s.h=parseInt(l[3],10)}return s},Ae=function(e){var i=function(e,t){return e/Math.pow(2,t)},n=function(e,t){var i=Math.max(e,t);return Math.ceil(Math.log((i+1)/257)/Math.log(2))},o=function(e,t){for(var i=e.length;i--;)e[i]=t};t.Events.publish("ManifestDidLoad",[e],l);var a=e.sequences[0];r.documentPaged="paged"===e.viewingHint||"paged"===a.viewingHint;for(var s,c,d,u,g,h,v,p,f,m=a.canvases,b=new Array(m.length),w=new Array(m.length),y=e.label,I=0,x=m.length;x>I;I++){p=m[I].images[0].resource,s=p.width||m[I].width,c=p.height||m[I].height,u=je(p),d=u.url,"/"!==d.slice(-1)&&(d+="/"),g=n(s,c),h=m[I].label;var P="non-paged"!==m[I].viewingHint;v=p.service["@context"],f="http://iiif.io/api/image/2/context.json"===v?2:"http://library.stanford.edu/iiif/image-api/1.1/context.json"===v?1.1:1,w[I]={mx_w:s,mx_h:c,mx_z:g,fn:h,url:d,api:f,paged:P},u.hasOwnProperty("x")&&(w[I].xoffset=u.x,w[I].yoffset=u.y),b[I]=g}var D=Math.min.apply(Math,b),L=0,O=100,C=new Array(D+1),T=new Array(D+1),E=new Array(D+1),S=new Array(D+1),k=new Array(D+1);o(C,0),o(T,0),o(E,0),o(S,0),o(k,0);var z,M,j,A=[],F=w.length;for(I=0;F>I;I++){z=[];for(var H=0;D+1>H;H++){M=Math.floor(i(w[I].mx_w,D-H)),j=Math.floor(i(w[I].mx_h,D-H)),z[H]={h:j,w:M},C[H]+=M,T[H]+=j,E[H]=Math.max(M,E[H]),S[H]=Math.max(j,S[H]);var B=w[I].mx_h/w[I].mx_w;L=Math.max(B,L),O=Math.min(B,O)}A[I]={d:z,m:w[I].mx_z,f:w[I].fn,url:w[I].url,api:w[I].api,paged:w[I].paged},w[I].hasOwnProperty("xoffset")&&(A[I].xoffset=w[I].xoffset,A[I].yoffset=w[I].yoffset)}var R=[],Z=[];for(I=0;D+1>I;I++)R.push(C[I]/w.length),Z.push(T[I]/w.length);var W={a_wid:R,a_hei:Z,max_w:E,max_h:S,max_ratio:L,min_ratio:O,t_hei:T,t_wid:C},_={item_title:y,dims:W,max_zoom:D,pgs:A};return _},Fe=function(e,t,i){ze();var n='<div id="'+r.ID+'error" class="diva-error"><p><strong>Error</strong></p><p>Invalid objectData. Error code: '+t+" "+i+"</p>",o=0===r.objectData.lastIndexOf("http",0);if(o&&""===i){var a=r.objectData.replace(/https?:\/\//i,"").split(/[/?#]/)[0];location.hostname!==a&&(n+='<p>Attempted to access cross-origin data without CORS.</p><p>You may need to update your server configuration to support CORS. For help, see the <a href="https://github.com/DDMAL/diva.js/wiki/Installation#a-note-about-cross-site-requests" target="_blank">cross-site request documentation.</a></p>')}n+="</div>",r.outerObject.append(n)},He=function(i){Be(i),t.Events.publish("ObjectDidLoad",[r],l),we();var n=parseInt(e.getHashParam("y"+r.hashParamSuffix),10);isNaN(n)?r.verticalOffset=ge(r.currentPageIndex,"top"):r.verticalOffset=n;var o=parseInt(e.getHashParam("x"+r.hashParamSuffix),10);isNaN(o)?0===r.goDirectlyTo&&r.inBookLayout&&r.verticallyOriented?r.horizontalOffset=0+r.horizontalPadding:r.horizontalOffset=he(r.currentPageIndex,"center"):r.horizontalOffset=o,r.inFullscreen?ie(!1):$(),we(),t.Events.publish("ViewerDidLoad",[r],l),r.loaded=!0},Be=function(i){var n;if(!i.hasOwnProperty("@context")||-1===i["@context"].indexOf("iiif")&&-1===i["@context"].indexOf("shared-canvas")?n=i:(r.isIIIF=!0,n=Ae(i)),ze(),r.pages=n.pgs,r.maxRatio=n.dims.max_ratio,r.minRatio=n.dims.min_ratio,r.itemTitle=n.item_title,r.numPages=n.pgs.length,r.maxWidths=n.dims.max_w,r.maxHeights=n.dims.max_h,r.averageWidths=n.dims.a_wid,r.averageHeights=n.dims.a_hei,r.totalHeights=n.dims.t_hei,r.totalWidths=n.dims.t_wid,r.realMaxZoom=n.max_zoom,r.maxZoomLevel=r.maxZoomLevel>=0&&r.maxZoomLevel<=n.max_zoom?r.maxZoomLevel:n.max_zoom,r.minZoomLevel=r.minZoomLevel>=0&&r.minZoomLevel<=r.maxZoomLevel?r.minZoomLevel:0,r.zoomLevel=U(r.zoomLevel),r.minPagesPerRow=Math.max(2,r.minPagesPerRow),r.maxPagesPerRow=Math.max(r.minPagesPerRow,r.maxPagesPerRow),r.enableFilename){var o=e.getHashParam("i"+r.hashParamSuffix),a=d(o);p(a)&&(r.goDirectlyTo=a,r.currentPageIndex=a)}else{var s=parseInt(e.getHashParam("p"+r.hashParamSuffix),10)-1;p(s)&&(r.goDirectlyTo=s,r.currentPageIndex=s)}if(t.Events.publish("NumberOfPagesDidChange",[r.numPages],l),r.enableAutoTitle&&(e(r.selector+"title").length?e(r.selector+"title").html(r.itemTitle):r.parentObject.prepend('<div id="'+r.ID+'title" class="diva-title">'+r.itemTitle+"</div>")),p(parseInt(r.goDirectlyTo),10)||(r.goDirectlyTo=0),r.adaptivePadding>0){var c=r.zoomLevel;r.horizontalPadding=parseInt(r.averageWidths[c]*r.adaptivePadding,10),r.verticalPadding=parseInt(r.averageHeights[c]*r.adaptivePadding,10)}else r.horizontalPadding=r.fixedPadding,r.verticalPadding=r.fixedPadding;r.pageTools.length&&(r.verticalPadding=Math.max(40,r.verticalPadding)),r.documentPaged&&(r.inBookLayout=!0);var u=e.getHashParam("v"+r.hashParamSuffix);Me(u)},Re=function(){return"object"==typeof r.objectData?void setTimeout(function(){He(r.objectData)},0):(r.throbberTimeoutID=setTimeout(function(){e(r.selector+"throbber").show()},r.throbberTimeout),void e.ajax({url:r.objectData,cache:!0,dataType:"json",error:Fe,success:He}))},Ze=function(){return r.loaded?!0:(console.warn("The viewer is not completely initialized. This is likely because it is still downloading data. To fix this, only call this function if the isReady() method returns true."),!1)},We=function(){r.scrollbarWidth=e.getScrollbarWidth(),r.mobileWebkit=void 0!==window.orientation,r.ID=e.generateId("diva-"),r.selector="#"+r.ID;var i=parseInt(r.ID,10);i>1&&(r.hashParamSuffix=i),r.parentObject.append('<div id="'+r.ID+'outer" class="diva-outer"></div>'),r.outerObject=e(r.selector+"outer"),r.outerObject.append('<div id="'+r.ID+'inner" class="diva-inner diva-dragger"></div>'),r.innerObject=e(r.selector+"inner"),r.outerObject.append('<div id="'+r.ID+'throbber" class="diva-throbber"></div>');var n=parseInt(e.getHashParam("n"+r.hashParamSuffix),10);n>=r.minPagesPerRow&&n<=r.maxPagesPerRow&&(r.pagesPerRow=n);var o=e.getHashParam("z"+r.hashParamSuffix);""!==o&&(o=parseInt(o,10),o>=r.minZoomLevel&&(r.zoomLevel=o)),r.enableToolbar&&(r.toolbar=Se(),t.Events.subscribe("VisiblePageDidChange",r.toolbar.updateCurrentPage,r.ID),t.Events.subscribe("ModeDidSwitch",r.toolbar.switchMode,r.ID),t.Events.subscribe("ViewDidSwitch",r.toolbar.switchView,r.ID),t.Events.subscribe("ViewDidSwitch",r.toolbar.displayViewMenu,r.ID),t.Events.subscribe("ZoomLevelDidChange",r.toolbar.updateZoomLabel,r.ID),t.Events.subscribe("GridRowNumberDidChange",r.toolbar.updateGridLabel,r.ID),t.Events.subscribe("NumberOfPagesDidChange",r.toolbar.setNumPages,r.ID),t.Events.subscribe("ObjectDidLoad",r.toolbar.displayViewMenu,r.ID),t.Events.subscribe("ObjectDidLoad",r.toolbar.switchView,r.ID),t.Events.subscribe("ObjectDidLoad",function(){r.toolbar.setNumPages(r.numPages)},r.ID),t.Events.subscribe("ViewerDidLoad",r.toolbar.switchMode,r.ID),t.Events.subscribe("ViewerDidLoad",function(){r.toolbar.updateCurrentPage(r.currentPageIndex)},r.ID),t.Events.subscribe("ViewerDidLoad",function(){r.toolbar.updateZoomLabel(r.zoomLevel)},r.ID));var a=e.getHashParam("f"+r.hashParamSuffix),s="true"===a;r.inFullscreen=r.inFullscreen&&"false"!==a||s,Re(),ke(),De()};We(),this.getItemTitle=function(){return r.itemTitle},this.gotoPageByNumber=function(e,t,i){var n=parseInt(e,10)-1;return p(n)?(G(n,ge(n,i),he(n,t)),!0):!1},this.gotoPageByIndex=function(e,t,i){return e=parseInt(e,10),p(e)?(G(e,ge(e,i),he(e,t)),!0):!1},this.getNumberOfPages=function(){return Ze()?r.numPages:!1},this.getPageDimensionsAtZoomLevel=function(e,t){if(!Ze())return!1;t>r.maxZoomLevel&&(t=r.maxZoomLevel);var i=r.pages[parseInt(e,10)],n=i.d[parseInt(t,10)];return{width:n.w,height:n.h}},this.getCurrentPageDimensionsAtCurrentZoomLevel=function(){return this.getPageDimensionsAtZoomLevel(r.currentPageIndex,r.zoomLevel)},this.isReady=function(){return r.loaded},this.getCurrentPageIndex=function(){return r.currentPageIndex},this.getCurrentPageFilename=function(){return r.pages[r.currentPageIndex].f},this.getCurrentPageNumber=function(){return r.currentPageIndex+1},this.getFilenames=function(){for(var e=[],t=0;t<r.numPages;t++)e[t]=r.pages[t].f;return e},this.getZoomLevel=function(){return r.zoomLevel},this.getMaxZoomLevel=function(){return r.maxZoomLevel},this.getMaxZoomLevelForPage=function(e){return Ze?r.pages[e].m:!1},this.getMinZoomLevel=function(){return r.minZoomLevel},this.setZoomLevel=function(e){return r.inGrid&&(r.goDirectlyTo=r.currentPageIndex,r.inGrid=!1,ne()),de(e)},this.zoomIn=function(){return this.setZoomLevel(r.zoomLevel+1)},this.zoomOut=function(){return this.setZoomLevel(r.zoomLevel-1)},this.inViewport=function(e,t,i,n,o){var a=e-1,s=r.pageTopOffsets[a]+i,l=s+o,c=r.pageLeftOffsets[a]+t,d=c+n;return g(s,l)&&u(c,d)},this.isPageInViewport=function(e){return f(e)},this.isPageLoaded=function(e){return m(e)},this.toggleFullscreenMode=function(){oe()},this.closePopups=function(){r.toolbar.closePopups()},this.enterFullscreenMode=function(){return r.inFullscreen?!1:(oe(),!0)},this.leaveFullscreenMode=function(){return r.inFullscreen?(oe(),!0):!1},this.changeView=function(e){return ae(e)},this.enterGridView=function(){return r.inGrid?!1:(ae("grid"),!0)},this.leaveGridView=function(){return r.inGrid?(r.goDirectlyTo=r.currentPageIndex,r.inGrid=!1,ne(),!0):!1},this.gotoPageByName=function(e,t,i){var n=d(e);return p(n)?(G(n,ge(n,i),he(n,t)),!0):!1},this.getPageIndex=function(e){return d(e)},this.getCurrentURL=function(){return be()},this.getURLHash=function(){return me()},this.getState=function(){return fe()},this.getInstanceSelector=function(){return r.selector},this.getInstanceId=function(){return r.ID},this.getSettings=function(){return r},this.translateFromMaxZoomLevel=function(e){var t=r.maxZoomLevel-r.zoomLevel;return e/Math.pow(2,t)},this.translateToMaxZoomLevel=function(e){var t=r.maxZoomLevel-r.zoomLevel;return 0===t?e:e*Math.pow(2,t)},this.setState=function(e){var t;t=d(e.i),p(t)?r.goDirectlyTo=t:p(e.p)&&(r.goDirectlyTo=e.p);var i=parseInt(e.x,10),n=parseInt(e.y,10);e.z>=r.minZoomLevel&&e.z<=r.maxZoomLevel&&(r.zoomLevel=e.z),e.n>=r.minPagesPerRow&&e.n<=r.maxPagesPerRow&&(r.pagesPerRow=e.n),r.inFullscreen!==e.f?(Me(e.v),r.inFullscreen=e.f,ie(!1),r.horizontalOffset=i,r.verticalOffset=n,G(t,r.verticalOffset,r.horizontalOffset)):(r.horizontalOffset=i,r.verticalOffset=n,"g"===e.v&&(!r.inGrid||r.inBookLayout)||"d"===e.v&&(r.inGrid||r.inBookLayout)||"b"===e.v&&!r.inBookLayout?(Me(e.v),ne()):$())},this.enableScrollable=function(){r.isScrollable||(ye(),r.enableKeyScroll=r.initialKeyScroll,r.enableSpaceScroll=r.initialSpaceScroll,r.outerObject.css("overflow","auto"),r.isScrollable=!0)},this.disableScrollable=function(){r.isScrollable&&(r.innerObject.hasClass("diva-dragger")&&r.innerObject.unbind("mousedown"),r.outerObject.unbind("dblclick"),r.outerObject.unbind("contextmenu"),r.outerObject.css("overflow","hidden"),r.initialKeyScroll=r.enableKeyScroll,r.initialSpaceScroll=r.enableSpaceScroll,r.enableKeyScroll=!1,r.enableSpaceScroll=!1,r.isScrollable=!1)},this.toggleOrientation=function(){return re()},this.getPageOffset=function(e){return{top:parseInt(r.pageTopOffsets[e]),left:parseInt(r.pageLeftOffsets[e])}},this.getCurrentPageOffset=function(){return this.getPageOffset(r.currentPageIndex)},this.getPageDimensionsAtCurrentGridLevel=function(e){e=p(e)?e:r.currentPageIndex;var t=r.rowHeight-r.fixedPadding,i=r.fixedHeightGrid?(r.rowHeight-r.fixedPadding)*c(e,"w")/c(e,"h"):r.gridPageWidth;return{height:parseInt(t,10),width:parseInt(i,10)}},this.getPageIndexForPageXYValues=function(e,t){var i=document.getElementById(r.ID+"outer"),n=i.getBoundingClientRect(),o=n.top,a=n.left,s=n.bottom,l=n.right;if(a>e||e>l)return!1;if(o>t||t>s)return!1;for(var c=document.getElementsByClassName("diva-page"),d=c.length;d--;){var u=c[d],g=u.getBoundingClientRect();if(!(e<g.left||e>g.right||t<g.top||t>g.bottom))return u.getAttribute("data-index")}return!1},this.isVerticallyOriented=function(){return r.verticallyOriented},this.changeObject=function(t){return r.loaded=!1,K(),r.objectData=t,"object"==typeof t?void setTimeout(function(){Be(t),$(),r.loaded=!0}):(r.throbberTimeoutID=setTimeout(function(){e(r.selector+"throbber").show()},r.throbberTimeout),void e.ajax({url:r.objectData,cache:!0,dataType:"json",error:Fe,success:function(e,t,i){Be(e),ze(),$(),r.loaded=!0}}))},this.activate=function(){r.isActiveDiva=!0},this.deactivate=function(){r.isActiveDiva=!1},this.destroy=function(){e("body").removeClass("diva-hide-scrollbar"),r.parentObject.empty().removeData("diva"),t.Events.publish("ViewerDidTerminate",[r],l),r.parentObject.removeAttr("style").removeAttr("class"),t.Events.unsubscribeAll(r.ID)}};e.fn.diva=function(t){return this.each(function(){var n=e(this);if(!n.data("diva")){var o=new i(this,t);n.data("diva",o)}})}}(e),function(e){window.divaPlugins.push(function(){var i={},n={init:function(n,o){function a(e){return Math.log(e)/Math.log(10)}var r,s,l,c,d;o.startScrolling=function(){return n.currentlyAutoScrolling?void console.warn("You are trying to start autoscrolling, but it is already scrolling."):(e("#"+n.ID+"autoscroll-toggle").text("Turn off"),s&&o.disableScrollable(),n.currentlyAutoScrolling=!0,void restartScrollingInterval())},restartScrollingInterval=function(){clearInterval(n.autoScrollInterval),n.verticallyOriented?n.autoScrollInterval=setInterval(function(){n.outerObject.scrollTop(n.outerObject.scrollTop()+r)},l):n.autoScrollInterval=setInterval(function(){n.outerObject.scrollLeft(n.outerObject.scrollLeft()+r)},l)},o.stopScrolling=function(){return n.currentlyAutoScrolling?(e("#"+n.ID+"autoscroll-toggle").text("Turn on"),s&&o.enableScrollable(),n.currentlyAutoScrolling=!1,void clearInterval(n.autoScrollInterval)):void console.warn("You are trying to stop autoscrolling, but it is not currently active.")},o.toggleScrolling=function(){n.currentlyAutoScrolling?o.stopScrolling():o.startScrolling()},o.changeRefresh=function(e){l=e,u()},o.changeScrollSpeed=function(t){d=t,u(),e("#"+n.ID+"autoscroll-pps").val(a(d)),n.currentlyAutoScrolling&&restartScrollingInterval()};var u=function(){l=c,r=d/(1e3/l),1>r&&(l*=1/r,r=d/(1e3/l))};if(o.disableManualScroll=function(){s=!0,n.currentlyAutoScrolling&&o.disableScrollable()},o.enableManualScroll=function(){s=!1,n.currentlyAutoScrolling&&o.enableScrollable()},n.currentlyAutoScrolling=!1,n.autoScrollInterval="",s=n.disableManualScroll||!1,l=n.autoScrollRefresh||50,c=l,o.changeScrollSpeed(n.scrollSpeed||10),e(window).on("keyup",function(e){e.shiftKey&&32===e.keyCode&&o.toggleScrolling()}),!n.disableAutoscrollPrefs){var g=function(t){if(n.inFullscreen){var o=e(n.selector+"tools"),a=o.css("right");i.jqObj.css({right:a,"margin-right":0,top:o.offset().top+o.outerHeight()+15})}else i.jqObj.css({right:e(window).width()-(n.outerObject.offset().left+n.outerObject.outerWidth())+n.scrollbarWidth,"margin-right":".6em"}),i.jqObj.offset({top:n.outerObject.offset().top+1})};t.Events.subscribe("ModeDidSwitch",g,n.ID),t.Events.subscribe("ViewerDidLoad",function(t){var r="<div id='"+n.ID+"autoscroll-prefs' class='diva-autoscroll-prefs diva-popup'><b>Autoscrolling options:</b><br><span class='diva-autoscroll-prefs-text'>Speed:</span><input type='range' id='"+n.ID+"autoscroll-pps' class='diva-autoscroll-pps diva-autoscroll-prefs-input' value='"+a(d)+"' min='0' max='3' step='0.1'><br><span class='diva-autoscroll-prefs-text'>Allow manual scroll:</span><input type='checkbox' id='"+n.ID+"autoscroll-manual' class='diva-autoscroll-manual diva-autoscroll-prefs-input' checked='checked'><br><button id='"+n.ID+"autoscroll-toggle' class='diva-autoscroll-prefs-toggle diva-autoscroll-prefs-input'> Turn on </button></div>";e("#"+n.ID+"page-nav").before("<div id='"+n.ID+"autoscroll-icon' class='diva-button diva-autoscroll-icon' title='Expand autoscroll options'></div>"),e("body").prepend(r),e("#"+n.ID+"autoscroll-pps").on("change",function(e){o.changeScrollSpeed(Math.pow(10,e.target.value))}),e("#"+n.ID+"autoscroll-manual").on("change",function(e){e.target.checked?o.enableManualScroll():o.disableManualScroll()}),e("#"+n.ID+"autoscroll-toggle").on("click",o.toggleScrolling),e("#"+n.ID+"autoscroll-icon").on("click",function(t){i.jqObj=e("#"+n.ID+"autoscroll-prefs"),"none"===i.jqObj.css("display")?(i.jqObj.css({display:"block"}),g(n.inFullscreen)):i.jqObj.css("display","none")})},n.ID)}},pluginName:"autoscroll",titleText:"Automatically scrolls page along primary axis"};return n}())}(e),function(e){window.divaPlugins.push(function(){var i,n,o,a={},r={},s={},l={brightnessMax:150,brightnessMin:-100,brightnessStep:1,contrastMax:3,contrastMin:-1,contrastStep:.05,localStoragePrefix:"canvas-",mobileWebkitMaxZoom:2,rgbMax:50,rgbMin:-50,throbberFadeSpeed:200,throbberTimeout:100,buttons:["contrast","brightness","rotation","zoom"]},c=function(e){return e*Math.PI/180},d=function(e,t){var i=e.x-a.centerX,o=-(e.y-a.centerY),r=c(n.rotation.previous-t),s=Math.cos(r)*i-Math.sin(r)*o+a.centerX,l=-(Math.sin(r)*i+Math.cos(r)*o)+a.centerY;return{x:s,y:l}},u=function(e,t){var n=e.context,o=e.size/2,a=-(e.width/2),r=-(e.height/2);n.clearRect(0,0,e.size,e.size),n.save(),n.translate(o,o),n.rotate(c(t)),n.drawImage(i,a,r,e.width,e.height),n.restore(),e.data=n.getImageData(0,0,e.size,e.size)},g=function(){var e;for(e in n)if(n[e].current!==n[e].previous)return!0;return!1},h=function(){var e;for(e in n)n[e].previous=n[e].current},v=function(){u(r,n.rotation.current),b(r)},p=function(){var t=n.rotation.current,i=n.rotation.previous,o=n.zoom.current,r=n.zoom.previous;if(t!==i||o!==r){var l=e("#diva-canvas-wrapper").scrollLeft(),c=e("#diva-canvas-wrapper").scrollTop(),v=s.viewport.width/2,p=s.viewport.height/2,f=d({
x:l+v,y:c+p},t),m=Math.pow(2,o-r),w=m*f.x-v,y=m*f.y-p;u(a,t),e("#diva-canvas-wrapper").scrollLeft(w),e("#diva-canvas-wrapper").scrollTop(y)}g()&&(b(a),h())},f=function(e){var t,i,n=e.data,o=e.context.createImageData(n),a=o.data;for(t=0,i=a.length;i>t;t++)a[t]=n.data[t];return o},m=function(e){var t=n[e].current!==n[e].previous,i=n[e].current!==n[e].initial;return t||i},b=function(e){var t,i,o,a,r,l,c,d,u=f(e),g=u.data,h=n.brightness.current,v=n.contrast.current,p=1+Math.min(s.brightnessMax,Math.max(s.brightnessMin,h))/s.brightnessMax,b=p*v,w=128-128*v,y=n.red.current,I=n.green.current,x=n.blue.current,P=m("red"),D=m("green"),L=m("blue"),O=m("brightness"),C=m("contrast"),T=O||C;for(t=0,o=u.width;o>t;t++)for(i=0,a=u.height;a>i;i++)r=4*(i*o+t),l=g[r],c=g[r+1],d=g[r+2],l+c+d>0&&(P&&l&&(l+=y),D&&c&&(c+=I),L&&d&&(d+=x),T&&(l&&(l=l*b+w),c&&(c=c*b+w),d&&(d=d*b+w)),g[r]=l,g[r+1]=c,g[r+2]=d);e.context.clearRect(0,0,o,a),e.context.putImageData(u,0,0)},w=function(){var t=e("#diva-canvas-wrapper").scrollLeft()*r.scaleFactor,i=e("#diva-canvas-wrapper").scrollTop()*r.scaleFactor,n=Math.min(Math.round(s.viewport.height*r.scaleFactor),s.mapSize)-4,o=Math.min(Math.round(s.viewport.width*r.scaleFactor),s.mapSize)-4;e("#diva-map-viewbox").height(n).width(o).css({top:i,left:t})},y=function(t){r.canvas=document.getElementById("diva-canvas-minimap"),r.size=s.mapSize,r.canvas.width=r.size,r.canvas.height=r.size,r.context=r.canvas.getContext("2d"),r.context.fillRect(0,0,r.size,r.size),r.scaleFactor=s.mapSize/a.size,r.cornerX=a.cornerX*r.scaleFactor,r.cornerY=a.cornerY*r.scaleFactor,r.width=t.width*r.scaleFactor,r.height=t.height*r.scaleFactor,r.context.drawImage(t,r.cornerX,r.cornerY,r.width,r.height),r.data=r.context.getImageData(0,0,s.mapSize,s.mapSize),e("#diva-map-viewbox").show(),w()},I=function(t,n){i=new Image,i.crossOrigin="anonymous",i.onload=function(){a.size=Math.sqrt(i.width*i.width+i.height*i.height),a.canvas=document.getElementById("diva-canvas"),a.canvas.width=a.size,a.canvas.height=a.size,a.cornerX=(a.size-i.width)/2,a.cornerY=(a.size-i.height)/2,a.width=i.width,a.height=i.height,a.centerX=a.size/2,a.centerY=a.size/2,a.context=a.canvas.getContext("2d"),a.context.drawImage(i,a.cornerX,a.cornerY,a.width,a.height);try{a.data=a.context.getImageData(0,0,a.size,a.size)}catch(t){var o='<div id="diva-error" class="diva-error"><p><strong>Error</strong></p><p>'+t.message+"</p>";if("SecurityError"!==t.name)throw t;o+='<p>You may need to update your server configuration in order to use the image manipulation tools. For help, see the <a href="https://github.com/DDMAL/diva.js/wiki/The-API-and-Plugins#a-note-about-canvas-and-cross-site-data" target="_blank">canvas cross-site data documentation</a>.</p></div>',o+="</div>",e("#diva-canvas-backdrop").append(o),O()}void 0===n&&y(i),v(),p(a),O(),"function"==typeof n&&n.call(n)},i.src=t,(i.complete||void 0===i.complete)&&(i.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",i.src=t)},x=function(){var t=n[o],i=t.current,a=t.transform?t.transform(i):i;e("#diva-canvas-value").html(a)},P=function(){e("#diva-canvas-slider").val(n[o].current)},D=function(e){var t,i=s.zoomWidthRatio*Math.pow(2,e),n=s.imageDir+"/",o=s.selectedPageIndex;if(s.isIIIF){var a=s.pages[o].api>1.1?"default":"native";t=encodeURI(s.pages[o].url+"full/"+i+",/0/"+a+".jpg")}else t=s.iipServerURL+"?FIF="+n+s.filename+"&WID="+i+"&CVT=JPEG";return t},L=function(){(n.zoom.current>0||s.mobileWebkit)&&e(s.selector+"throbber").addClass("canvas-throbber").show()},O=function(){e(s.selector+"throbber").removeClass("canvas-throbber").hide()},C=function(){var e,t={},i=!1,o=s.localStoragePrefix+s.filename;for(e in n)n[e].previous!==n[e].initial&&(t[e]=n[e].previous,i=!0);i?(s.pluginIcon.addClass("new"),localStorage.setObject(o,t)):(s.pluginIcon.removeClass("new"),localStorage.removeItem(o))},T=function(e,t){s.zoomLevel=e;var i=D(e);I(i,function(){r.scaleFactor=r.size/a.size,w(),C()})},E=function(t){var i=38,n=40,o=37,a=39;switch(t.keyCode){case i:return e("#diva-canvas-wrapper").scrollTop(document.getElementById("diva-canvas-wrapper").scrollTop-s.arrowScrollAmount),!1;case n:return e("#diva-canvas-wrapper").scrollTop(document.getElementById("diva-canvas-wrapper").scrollTop+s.arrowScrollAmount),!1;case o:return e("#diva-canvas-wrapper").scrollLeft(document.getElementById("diva-canvas-wrapper").scrollLeft-s.arrowScrollAmount),!1;case a:return e("#diva-canvas-wrapper").scrollLeft(document.getElementById("diva-canvas-wrapper").scrollLeft+s.arrowScrollAmount),!1}},S={init:function(i,c){var d=!!window.HTMLCanvasElement;if(!d)return!1;e.extend(s,l,i.canvasPlugin),s.inCanvas=!1,s.iipServerURL=i.iipServerURL,s.imageDir=i.imageDir,s.selector=i.selector,s.mobileWebkit=i.mobileWebkit,s.arrowScrollAmount=i.arrowScrollAmount,n={contrast:{initial:1,min:s.contrastMin,max:s.contrastMax,step:s.contrastStep,transform:function(e){return e.toFixed(2)},title:"Change the contrast"},brightness:{initial:0,min:s.brightnessMin,max:s.brightnessMax,step:s.brightnessStep,title:"Adjust the brightness"},rotation:{initial:0,min:0,max:359,step:1,transform:function(e){return e+"&deg;"},title:"Rotate the image"},zoom:{initial:0,min:0,max:0,step:1,title:"Adjust the zoom level"},red:{initial:0,min:s.rgbMin,max:s.rgbMax,step:1,title:"Adjust the red channel"},green:{initial:0,min:s.rgbMin,max:s.rgbMax,step:1,title:"Adjust the green channel"},blue:{initial:0,min:s.rgbMin,max:s.rgbMax,step:1,title:"Adjust the blue channel"}};var u=function(){var e,t,i;for(i in n)t=n[i],e=t.initial,t.current=e,t.previous=e};if(u(),e("#diva-canvas-backdrop").length)return!0;var h,f,m,b,y=[];for(b in s.buttons)f=s.buttons[b],m=n[f].title,h='<div class="'+f+'" title="'+m+'"></div>',y.push(h);var I=y.join(""),D='<div id="diva-canvas-tools"><div id="diva-canvas-toolbar"><div id="diva-canvas-close" title="Return to the document viewer"></div><div id="diva-canvas-minimise" title="Minimise the toolbar"></div><span id="diva-canvas-info">Test</span></div><div id="diva-canvas-toolwindow"><div id="diva-map-viewbox"></div><canvas id="diva-canvas-minimap"></canvas><div id="diva-canvas-buttons">'+I+'</div><div id="diva-canvas-pane"><p id="diva-canvas-tooltip"><span id="diva-canvas-mode">contrast</span>: <span id="diva-canvas-value">0</span> <span id="diva-canvas-reset" class="link">(Reset)</span></p><input type="range" id="diva-canvas-slider"></input></div><br /><div class="action-buttons"><a href="#" id="diva-canvas-reset-all">Reset all</a><a href="#" id="diva-canvas-apply">Apply</a></div></div></div>',S='<div id="diva-canvas-wrapper"><canvas id="diva-canvas"></canvas></div>',k='<div id="diva-canvas-backdrop">'+D+S+"</div>";e("body").append(k),s.mapSize=e("#diva-canvas-minimap").width(),e("#diva-canvas-buttons div").click(function(){e("#diva-canvas-buttons .clicked").removeClass("clicked"),z(e(this).attr("class"))});var z=function(t){o=t;var i=n[o];e("#diva-canvas-buttons ."+o).addClass("clicked"),e("#diva-canvas-mode").text(o);var a=i.current,r=i.transform?i.transform(a):a,s=document.getElementById("diva-canvas-slider");s.min=i.min,s.max=i.max,s.step=i.step,e("#diva-canvas-slider").val(a),e("#diva-canvas-value").html(r)};return z("contrast"),e("#diva-canvas-slider").on("input",function(e){n[o].current=parseFloat(this.value),x(),v()}),e("#diva-canvas-reset-all").click(function(){var e;for(e in n)n[e].current=n[e].initial;x(),P(),v()}),e("#diva-canvas-reset").click(function(){n[o].current=n[o].initial,x(),P(),v()}),e("#diva-canvas-apply").click(function(){g()&&(L(),setTimeout(function(){n.zoom.current!==n.zoom.previous?T(n.zoom.current):(p(),O(),C())},s.throbberTimeout))}),e("#diva-canvas-close").click(function(){e("body").removeClass("overflow-hidden"),a.context.clearRect(0,0,a.size,a.size),r.context.clearRect(0,0,r.size,r.size),e("#diva-canvas-wrapper").scrollTop(0).scrollLeft(0),e("#diva-canvas-backdrop").hide(),e("#diva-map-viewbox").hide(),O(),c.enableScrollable(),e(document).off("keydown",E),u(),x(),P(),e("#diva-canvas-buttons .clicked").removeClass("clicked"),z("contrast"),t.Events.publish("CanvasViewDidHide")}),e("#diva-canvas-minimise").click(function(){e("#diva-canvas-toolwindow").slideToggle("fast")}),e(window).resize(function(){s.viewport={height:window.innerHeight-i.scrollbarWidth,width:window.innerWidth-i.scrollbarWidth},s.inCanvas&&w()}),e("#diva-canvas-wrapper").scroll(function(){s.inCanvas&&w()}),e("#diva-canvas-minimap, #diva-map-viewbox").mouseup(function(t){var i=e("#diva-canvas-minimap").offset(),n=(t.pageX-i.left)/r.scaleFactor,o=(t.pageY-i.top)/r.scaleFactor;e("#diva-canvas-wrapper").scrollTop(o-s.viewport.height/2),e("#diva-canvas-wrapper").scrollLeft(n-s.viewport.width/2)}),e("#diva-canvas").mousedown(function(){e(this).addClass("grabbing")}).mouseup(function(){e(this).removeClass("grabbing")}),e("#diva-canvas-wrapper").kinetic(),e("#diva-canvas-wrapper").dragscrollable({acceptPropagatedEvent:!0}),t.Events.subscribe("ObjectDidLoad",this.setupHook,i.ID),t.Events.subscribe("ViewerDidTerminate",this.destroy,i.ID),t.Events.subscribe("PageDidLoad",this.onPageLoad,i.ID),!0},pluginName:"canvas",titleText:"View the image on a canvas and adjust various settings",setupHook:function(e){s.viewport={height:window.innerHeight-e.scrollbarWidth,width:window.innerWidth-e.scrollbarWidth},s.minZoomLevel=e.minZoomLevel,s.maxZoomLevel=e.maxZoomLevel,s.mobileWebkit&&(s.maxZoomLevel=Math.min(s.maxZoomLevel,s.mobileWebkitMaxZoom)),n.zoom.min=s.minZoomLevel,n.zoom.max=s.maxZoomLevel},handleClick:function(i,a,r){var l,c=e(this).parent().parent(),d=e(c).attr("data-filename"),u=e(c).attr("data-index"),g=e(c).width()-1,h=a.zoomLevel;s.zoomWidthRatio=g/Math.pow(2,h),s.pluginIcon=e(this),s.pages=a.pages,s.isIIIF=a.isIIIF,s.selectedPageIndex=u,s.mobileWebkit&&(h=Math.min(s.maxZoomLevel,h)),s.filename=d,n.zoom.initial=h,n.zoom.current=h;var v=localStorage.getObject(s.localStoragePrefix+s.filename);if(v)for(l in v)n[l].current=v[l],l===o&&(x(),P()),"zoom"===l&&(h=v[l]);n.zoom.previous=h,e("body").addClass("overflow-hidden"),e("#diva-canvas-backdrop").show(),r.disableScrollable(),e(document).keydown(E),s.inCanvas=!0;var p=D(h);e("#diva-canvas-info").text(e(c).attr("title")),L(),t.Events.publish("CanvasViewDidActivate",[c]),I(p)},onPageLoad:function(t,i,n){var o=s.localStoragePrefix+i;null!==localStorage.getItem(o)&&e(n).find(".diva-canvas-icon").addClass("new")},destroy:function(t,i){e("#diva-canvas-backdrop").remove()}};return S}())}(e),function(e){window.divaPlugins.push(function(){var t={init:function(e,t){return!0},pluginName:"download",titleText:"Download image at the given zoom level",handleClick:function(t,i){var n,o=e(this).parent().parent(),a=e(o).attr("data-filename"),r=e(o).attr("data-index"),s=e(o).width()-1;if(i.isIIIF){var l=i.pages[r].api>1.1?"default":"native";n=encodeURI(i.pages[r].url+"full/"+s+",/0/"+l+".jpg")}else n=i.iipServerURL+"?FIF="+i.imageDir+"/"+a+"&WID="+s+"&CVT=JPEG";window.open(n)}};return t}())}(e),function(e){window.divaPlugins.push(function(){var e={init:function(e,i){function n(n,o,a){var l=e.parentObject.data("highlights");if("undefined"!=typeof l){if(l.hasOwnProperty(n)){for(var c=document.getElementById(e.ID+"page-"+n).getElementsByClassName(e.ID+"highlight");c[0];)c[0].parentNode.removeChild(c[0]);var d,u=i.getInstanceId()+"page-"+n,g=document.getElementById(u),h=l[n].regions,v=l[n].colour,p=l[n].divClass,f=i.getMaxZoomLevel();if(e.inGrid){var m=i.getPageDimensionsAtZoomLevel(n,f).width,b=g.clientWidth,w=m/b;d=Math.log(w)/Math.log(2)}else d=f-i.getZoomLevel();for(var y=h.length;y--;){var I=document.createElement("div");I.style.width=s(h[y].width,d)+"px",I.style.height=s(h[y].height,d)+"px",I.style.top=s(h[y].uly,d)+"px",I.style.left=s(h[y].ulx,d)+"px",I.style.background=v,I.style.border="1px solid #555",I.style.position="absolute",I.style.zIndex=100,I.className=p,"undefined"!=typeof h[y].divID&&I.setAttribute("data-highlight-id",h[y].divID),g.appendChild(I)}}r(),t.Events.publish("HighlightCompleted",[n,o,a])}}e.parentObject.data("highlights",{});var o,a,r=function(){var t,n,r,s=e.ID+"selected-highlight",l=document.getElementsByClassName(s);for(t=0;t<l.length;t++)n=l[t],n.id!==o&&(n.className=n.className.replace(" "+s,""),n.style.border="1px solid #555");if(i.isPageLoaded(a))for(r=document.querySelectorAll("*[data-highlight-id="+o+"]"),t=0;t<r.length;t++)n=r[t],n.className=n.className+" "+s,n.style.border="2px solid #000"};t.Events.subscribe("PageDidLoad",n,e.ID);var s=function(e,t){return e/Math.pow(2,t)};i.resetHighlights=function(){for(var t=document.getElementById(e.ID+"inner"),i=e.ID+"highlight",n=t.getElementsByClassName(i),o=n.length;o--;){var a=n[o].parentNode;a.removeChild(n[o])}e.parentObject.data("highlights",{})},i.removeHighlightsOnPage=function(t){var n=e.parentObject.data("highlights");if(n.hasOwnProperty(t)){for(var o=i.getInstanceId()+"page-"+t,a=document.getElementById(o),r=a.getElementsByTagName("div"),s=n[t].divClass,l=r.length;l--;)r[l].className===s&&a.removeChild(r[l]);delete n[t]}},i.highlightOnPages=function(e,t,n,o){for(var a=e.length;a--;)i.highlightOnPage(e[a],t[a],n,o)},i.highlightOnPage=function(t,o,a,r){"undefined"==typeof a&&(a="rgba(255, 0, 0, 0.2)"),r="undefined"==typeof r?e.ID+"highlight":e.ID+"highlight "+r;var s=(i.getMaxZoomLevel(),e.parentObject.data("highlights"));return s[t]={regions:o,colour:a,divClass:r},i.isPageLoaded(t)&&n(t,null,null),!0},i.gotoHighlight=function(t){var i=e.parentObject.data("highlights");if(null!==document.getElementById(t)){for(var n=parseInt(document.getElementById(t).parentNode.getAttribute("data-index"),10),o=i[n].regions.length;o--;)if(i[n].regions[o].divID===t)return l(n,i[n].regions[o])}else for(var a=Object.keys(i),r=a.length;r--;)for(var s=i[a[r]].regions,c=s.length;c--;)if(s[c].divID===t)return l(a[r],s[c]);return console.warn("Diva just tried to find a highlight that doesn't exist."),!1};var l=function(n,s){var l=parseFloat(s.uly)+parseFloat(s.height)/2,c=parseFloat(s.ulx)+parseFloat(s.width)/2,d=i.translateFromMaxZoomLevel(l),u=i.translateFromMaxZoomLevel(c);n=parseInt(n,10),i.gotoPageByIndex(n);var g=i.getSettings().outerObject,h=g.scrollTop()+d-g.height()/2+e.verticalPadding,v=g.scrollLeft()+u-g.width()/2+e.horizontalPadding;return g.scrollTop(h),g.scrollLeft(v),o=s.divID,a=n,t.Events.publish("SelectedHighlightChanged",[o,a]),r(),o},c=function(t){return e.verticallyOriented?i.translateFromMaxZoomLevel(parseFloat(t.uly)+parseFloat(t.height)/2):i.translateFromMaxZoomLevel(parseFloat(t.ulx)+parseFloat(t.width)/2)},d=function(t){var n,r,s,d,u,g,h,v,p,f,m=e.parentObject.data("highlights"),b=!1;if(o&&a){for(s=a,d=m[s].regions,u=d.length;u--;)if(d[u].divID==o){p=d[u],r=c(p);break}for(u=d.length,g=i.getPageDimensionsAtZoomLevel(s,i.getZoomLevel()),n=t?e.verticallyOriented?g.height:g.width:0,f=t?function(e,t,i){return e>t&&i>e}:function(e,t,i){return t>e&&e>i};u--;)p=d[u],h=c(p),p.divID!==o&&f(h,r,n)&&(b=!0,n=h,v=p);if(b)return l(s,v)}else s=0,r=0;var w,y=Object.keys(m),I=y.indexOf(s);for(w=t?I==y.length-1?y[0]:y[I+1]:0===I?y[y.length-1]:y[I-1],d=m[w].regions,u=d.length,g=i.getPageDimensionsAtZoomLevel(w,i.getMaxZoomLevel()),n=t?e.verticallyOriented?g.height:g.width:0,f=t?function(e,t){return t>e}:function(e,t){return e>t};u--;)p=d[u],h=c(p),f(h,n)&&(b=!0,n=h,v=p);return l(w,v)};return i.gotoNextHighlight=function(){return d(!0)},i.gotoPreviousHighlight=function(){return d(!1)},t.Events.subscribe("ViewerDidTerminate",this.destroy,e.ID),!0},destroy:function(e,t){e.parentObject.removeData("highlights")},pluginName:"highlight",titleText:"Highlight regions of pages"};return e}())}(e),function(e){window.divaPlugins.push(function(){var i={},n={init:function(n,o){function a(e,a,s){var l=n.parentObject.data("highlights");if("undefined"!=typeof l&&i.highlightsVisible){if(l.hasOwnProperty(e)){var c,d=o.getInstanceId()+"page-"+e,u=document.getElementById(d),g=l[e].regions,h=l[e].colour,v=l[e].divClass,p=o.getMaxZoomLevel();if(n.inGrid){var f=o.getPageDimensionsAtZoomLevel(e,p).width,m=u.clientWidth,b=f/m;c=Math.log(b)/Math.log(2)}else c=p-o.getZoomLevel();for(var w=g.length;w--;){var y=document.createElement("div");y.style.width=r(g[w].width,c)+"px",y.style.height=r(g[w].height,c)+"px",y.style.top=r(g[w].uly,c)+"px",y.style.left=r(g[w].ulx,c)+"px",y.style.background=h,y.style.border="1px solid #555",y.style.position="absolute",y.style.zIndex=100,y.className=v,"undefined"!=typeof g[w].name&&y.setAttribute("data-name",g[w].name),"undefined"!=typeof g[w].divID&&(y.id=g[w].divID),u.appendChild(y)}}t.Events.publish("HighlightCompleted",[e,a,s])}}n.parentObject.data("highlights",{}),i.highlightedPages=[],t.Events.subscribe("PageWillLoad",a,n.ID);var r=function(e,t){return e/Math.pow(2,t)};o.resetHighlights=function(){for(var e=document.getElementById(n.ID+"inner"),t=n.ID+"highlight",i=e.getElementsByClassName(t),o=i.length;o--;){var a=i[o].parentNode;a.removeChild(i[o])}n.parentObject.data("highlights",{})},o.removeHighlightsOnPage=function(e){var t=n.parentObject.data("highlights");if(t.hasOwnProperty(e)){for(var i=o.getInstanceId()+"page-"+e,a=document.getElementById(i),r=a.getElementsByTagName("div"),s=t[e].divClass,l=r.length;l--;)r[l].className===s&&a.removeChild(r[l]);delete t[e]}},o.hideHighlights=function(){i.highlightsVisible=!1;for(var e=n.ID+"highlight",t=document.getElementById(n.ID+"inner"),o=t.getElementsByClassName(e),a=o.length;a--;){var r=o[a].parentNode;r.removeChild(o[a])}},o.showHighlights=function(){i.highlightsVisible=!0;for(var e,t=document.getElementById(n.ID+"inner"),o=t.getElementsByClassName("diva-document-page"),r=0;r<o.length;r++){e=parseInt(o[r].getAttribute("data-index"),10);var s=n.parentObject.data("highlights");s.hasOwnProperty(e)?a(e,null,null):l(e)}},o.highlightOnPages=function(e,t,i,n){for(var a=e.length;a--;)o.highlightOnPage(e[a],t[a],i,n)},o.highlightOnPage=function(e,t,i,r){"undefined"==typeof i&&(i="rgba(255, 0, 0, 0.1)"),r="undefined"==typeof r?n.ID+"highlight":n.ID+"highlight "+r;var s=(o.getMaxZoomLevel(),n.parentObject.data("highlights"));return s[e]={regions:t,colour:i,divClass:r},o.isPageLoaded(e)&&a(e,null,null),!0},o.gotoHighlight=function(e){var t,i,a,r,s=n.parentObject.data("highlights"),l=!1;if(null!==document.getElementById(e)){t=parseInt(document.getElementById(e).parentNode.getAttribute("data-index"),10);for(var c=s[t].regions.length;c--;)if(s[t].regions[c].divID===e){i=s[t].regions[c],a=parseFloat(i.uly)+parseFloat(i.height)/2,r=parseFloat(i.ulx)+parseFloat(i.width)/2,l=!0;break}}else for(var d=Object.keys(s),u=d.length;u--;){for(var g=s[d[u]].regions,h=g.length;h--;)if(g[h].divID===e){t=d[u],i=g[h],a=parseFloat(i.uly)+parseFloat(i.height)/2,r=parseFloat(i.ulx)+parseFloat(i.width)/2,l=!0;break}if(l)break}if(!l)return console.warn("Diva just tried to find a highlight that doesn't exist."),!1;var v=o.getSettings().outerObject,p=o.translateFromMaxZoomLevel(a),f=o.translateFromMaxZoomLevel(r);o.gotoPageByIndex(t);var m=v.scrollTop()+p-v.height()/2+n.verticalPadding,b=v.scrollLeft()+f-v.width()/2+n.horizontalPadding;return v.scrollTop(m),v.scrollLeft(b),n.currentHighlight=e,!0};var s=function(e){return function(t,n,a){for(var r=t,s=t.length,l=[],c=0;s>c;c++){var d=r[c],u=d.resource.chars,g=d.on,h=g.slice(g.indexOf("#xywh=")+6),v=h.split(","),p={ulx:parseInt(v[0],10),uly:parseInt(v[1],10),width:parseInt(v[2],10),height:parseInt(v[3],10),name:u};l.push(p)}o.highlightOnPage(e,l),i.highlightedPages.push(e)}},l=function(t){var n=i.manifest.sequences[0].canvases;if(n[t].hasOwnProperty("otherContent"))for(var o=n[t].otherContent,a=0;a<o.length;a++)"sc:AnnotationList"===o[a]["@type"]&&e.ajax({url:o[a]["@id"],cache:!0,dataType:"json",success:s(t)})},c=function(e){i.manifest=e};t.Events.subscribe("ManifestDidLoad",c,n.ID),t.Events.subscribe("PageWillLoad",function(e){if(i.highlightsVisible){for(var t=0;t<i.highlightedPages.length;t++)if(i.highlightedPages[t]===e)return;l(e,i.manifest)}},n.ID);var d=[];return n.innerObject.on("mouseenter","."+n.ID+"highlight",function(e){var t=e.target,i=t.dataset.name,n=document.createElement("div");n.style.top=t.offsetTop+t.offsetHeight-1+"px",n.style.left=t.style.left,n.style.background="#fff",n.style.border="1px solid #555",n.style.position="absolute",n.style.zIndex=101,n.className="annotation-overlay",n.textContent=i,t.parentNode.appendChild(n),d.push(n)}),n.innerObject.on("mouseleave","."+n.ID+"highlight",function(e){for(;d.length;){var t=d.pop();t.parentNode.removeChild(t)}}),t.Events.subscribe("ViewerDidLoad",function(){e("#"+n.ID+"page-nav").before('<div id="'+n.ID+'annotations-icon" class="diva-button diva-annotations-icon" title="Turn annotations on or off"></div>'),e(n.selector+"annotations-icon").addClass("annotations-icon-active"),e("#"+n.ID+"annotations-icon").on("click",function(t){i.highlightsVisible?(o.hideHighlights(),e(n.selector+"annotations-icon").removeClass("annotations-icon-active")):(o.showHighlights(),e(n.selector+"annotations-icon").addClass("annotations-icon-active"))})},n.ID),i.highlightsVisible=!0,!0},destroy:function(e,t){e.parentObject.removeData("highlights")},pluginName:"IIIFHighlight",titleText:"Highlight regions of pages"};return n}())}(e),function(e){window.divaPlugins.push(function(){var i={init:function(i,n){var o=function(t){var n=function(e,t){var i=e.charAt(0).toUpperCase()+e.slice(1),n=i.replace("_"," ");return 0===t.indexOf("http://")&&(t='<a href="'+t+'" target="_blank">'+t+"</a>"),'<div class="metadata-row"><span class="metadata-label">'+n+':</span> <span class="metadata-value">'+t+"</span></div>"},o=function(e,t){for(var i=0;i<e.length;i++)if(e[i]["@language"]===t)return e[i]["@value"]},a=function(e){for(var i="",a=0;a<e.length;a++){var r=e[a];if(t.hasOwnProperty(r))if(t[r].constructor===Array){var s=o(t[r],"en");i+=n(r,s)}else i+=n(r,t[r])}return i},r='<div id="'+i.ID+'metadata" class="diva-modal">';if(r+=a(["label"]),t.hasOwnProperty("metadata"))for(var s=t.metadata,l=0;l<s.length;l++)if(s[l].value.constructor===Array){var c=o(s[l].value,"en");r+=n(s[l].label,c)}else r+=n(s[l].label,s[l].value);r+=a(["description","within","see_also","service","license","attribution"]),r+="</div>",i.parentObject.prepend(r),e(i.selector+"metadata").hide()};return t.Events.subscribe("ManifestDidLoad",o,i.ID),i.parentObject.prepend('<div style="text-align: center; clear: both"><a href="#" id="'+i.ID+'metadata-link" class="diva-metadata-link">Details</a></div>'),e(i.selector+"metadata-link").on("click",function(t){e(i.selector+"metadata").fadeToggle("fast")}),!0},destroy:function(e,t){},pluginName:"IIIFMetadata",titleText:"Show metadata from a IIIF manifest"};return i}())}(e),function(e){window.divaPlugins.push(function(){var e={init:function(e,i){void 0===e.pageAliases&&(e.pageAliases={}),void 0===e.pageAliasFunction&&(e.pageAliasFunction=function(){return!1}),i.getAliasForPageIndex=function(t){return e.pageAliases[t]||e.pageAliasFunction(t)||t+1},i.getPageIndexForAlias=function(t){for(var n=0;n<e.numPages;n++)if(i.getAliasForPageIndex(n)==t)return n;return!1},i.getPageIndicesForAlias=function(t){for(var n=[],o=0;o<e.numPages;o++)i.getAliasForPageIndex(o)==t&&n.push(o);return n},i.getCurrentAliasedPageIndex=function(){return i.getAliasForPageIndex(e.currentPageIndex)},i.gotoPageByAliasedNumber=function(e,t,n){return i.gotoPageByIndex(i.getPageIndexForAlias(e),t,n)};var n=function(){document.getElementById(this.getSettings().ID+"current-page").textContent=this.getCurrentAliasedPageIndex()},o=function(){var i=this.getSettings(),o=i.numPages;void 0!==i.newTotalPages?o=i.newTotalPages:void 0!==i.totalPageOffset&&(o+=i.totalPageOffset),document.getElementById(this.getSettings().ID+"num-pages").textContent=o,document.getElementById(this.getSettings().ID+"current-page").textContent=this.getCurrentAliasedPageIndex(),t.Events.unsubscribe(["VisiblePageDidChange",i.toolbar.updateCurrentPage,e.ID]),t.Events.subscribe("VisiblePageDidChange",n,e.ID)};t.Events.subscribe("ViewerDidLoad",o,e.ID)},pluginName:"pagealias",titleText:"Re-aliases page indexes"};return e}())}(e)});

; browserify_shim__define__module__export__(typeof diva != "undefined" ? diva : window.diva);

}).call(global, undefined, undefined, undefined, undefined, function defineExport(ex) { module.exports = ex; });

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],6:[function(require,module,exports){
'use strict';

exports.__esModule = true;
// istanbul ignore next

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

// istanbul ignore next

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj['default'] = obj; return newObj; } }

var _handlebarsBase = require('./handlebars/base');

var base = _interopRequireWildcard(_handlebarsBase);

// Each of these augment the Handlebars object. No need to setup here.
// (This is done to easily share code between commonjs and browse envs)

var _handlebarsSafeString = require('./handlebars/safe-string');

var _handlebarsSafeString2 = _interopRequireDefault(_handlebarsSafeString);

var _handlebarsException = require('./handlebars/exception');

var _handlebarsException2 = _interopRequireDefault(_handlebarsException);

var _handlebarsUtils = require('./handlebars/utils');

var Utils = _interopRequireWildcard(_handlebarsUtils);

var _handlebarsRuntime = require('./handlebars/runtime');

var runtime = _interopRequireWildcard(_handlebarsRuntime);

var _handlebarsNoConflict = require('./handlebars/no-conflict');

var _handlebarsNoConflict2 = _interopRequireDefault(_handlebarsNoConflict);

// For compatibility and usage outside of module systems, make the Handlebars object a namespace
function create() {
  var hb = new base.HandlebarsEnvironment();

  Utils.extend(hb, base);
  hb.SafeString = _handlebarsSafeString2['default'];
  hb.Exception = _handlebarsException2['default'];
  hb.Utils = Utils;
  hb.escapeExpression = Utils.escapeExpression;

  hb.VM = runtime;
  hb.template = function (spec) {
    return runtime.template(spec, hb);
  };

  return hb;
}

var inst = create();
inst.create = create;

_handlebarsNoConflict2['default'](inst);

inst['default'] = inst;

exports['default'] = inst;
module.exports = exports['default'];


},{"./handlebars/base":7,"./handlebars/exception":10,"./handlebars/no-conflict":20,"./handlebars/runtime":21,"./handlebars/safe-string":22,"./handlebars/utils":23}],7:[function(require,module,exports){
'use strict';

exports.__esModule = true;
exports.HandlebarsEnvironment = HandlebarsEnvironment;
// istanbul ignore next

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _utils = require('./utils');

var _exception = require('./exception');

var _exception2 = _interopRequireDefault(_exception);

var _helpers = require('./helpers');

var _decorators = require('./decorators');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var VERSION = '4.0.5';
exports.VERSION = VERSION;
var COMPILER_REVISION = 7;

exports.COMPILER_REVISION = COMPILER_REVISION;
var REVISION_CHANGES = {
  1: '<= 1.0.rc.2', // 1.0.rc.2 is actually rev2 but doesn't report it
  2: '== 1.0.0-rc.3',
  3: '== 1.0.0-rc.4',
  4: '== 1.x.x',
  5: '== 2.0.0-alpha.x',
  6: '>= 2.0.0-beta.1',
  7: '>= 4.0.0'
};

exports.REVISION_CHANGES = REVISION_CHANGES;
var objectType = '[object Object]';

function HandlebarsEnvironment(helpers, partials, decorators) {
  this.helpers = helpers || {};
  this.partials = partials || {};
  this.decorators = decorators || {};

  _helpers.registerDefaultHelpers(this);
  _decorators.registerDefaultDecorators(this);
}

HandlebarsEnvironment.prototype = {
  constructor: HandlebarsEnvironment,

  logger: _logger2['default'],
  log: _logger2['default'].log,

  registerHelper: function registerHelper(name, fn) {
    if (_utils.toString.call(name) === objectType) {
      if (fn) {
        throw new _exception2['default']('Arg not supported with multiple helpers');
      }
      _utils.extend(this.helpers, name);
    } else {
      this.helpers[name] = fn;
    }
  },
  unregisterHelper: function unregisterHelper(name) {
    delete this.helpers[name];
  },

  registerPartial: function registerPartial(name, partial) {
    if (_utils.toString.call(name) === objectType) {
      _utils.extend(this.partials, name);
    } else {
      if (typeof partial === 'undefined') {
        throw new _exception2['default']('Attempting to register a partial called "' + name + '" as undefined');
      }
      this.partials[name] = partial;
    }
  },
  unregisterPartial: function unregisterPartial(name) {
    delete this.partials[name];
  },

  registerDecorator: function registerDecorator(name, fn) {
    if (_utils.toString.call(name) === objectType) {
      if (fn) {
        throw new _exception2['default']('Arg not supported with multiple decorators');
      }
      _utils.extend(this.decorators, name);
    } else {
      this.decorators[name] = fn;
    }
  },
  unregisterDecorator: function unregisterDecorator(name) {
    delete this.decorators[name];
  }
};

var log = _logger2['default'].log;

exports.log = log;
exports.createFrame = _utils.createFrame;
exports.logger = _logger2['default'];


},{"./decorators":8,"./exception":10,"./helpers":11,"./logger":19,"./utils":23}],8:[function(require,module,exports){
'use strict';

exports.__esModule = true;
exports.registerDefaultDecorators = registerDefaultDecorators;
// istanbul ignore next

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _decoratorsInline = require('./decorators/inline');

var _decoratorsInline2 = _interopRequireDefault(_decoratorsInline);

function registerDefaultDecorators(instance) {
  _decoratorsInline2['default'](instance);
}


},{"./decorators/inline":9}],9:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _utils = require('../utils');

exports['default'] = function (instance) {
  instance.registerDecorator('inline', function (fn, props, container, options) {
    var ret = fn;
    if (!props.partials) {
      props.partials = {};
      ret = function (context, options) {
        // Create a new partials stack frame prior to exec.
        var original = container.partials;
        container.partials = _utils.extend({}, original, props.partials);
        var ret = fn(context, options);
        container.partials = original;
        return ret;
      };
    }

    props.partials[options.args[0]] = options.fn;

    return ret;
  });
};

module.exports = exports['default'];


},{"../utils":23}],10:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var errorProps = ['description', 'fileName', 'lineNumber', 'message', 'name', 'number', 'stack'];

function Exception(message, node) {
  var loc = node && node.loc,
      line = undefined,
      column = undefined;
  if (loc) {
    line = loc.start.line;
    column = loc.start.column;

    message += ' - ' + line + ':' + column;
  }

  var tmp = Error.prototype.constructor.call(this, message);

  // Unfortunately errors are not enumerable in Chrome (at least), so `for prop in tmp` doesn't work.
  for (var idx = 0; idx < errorProps.length; idx++) {
    this[errorProps[idx]] = tmp[errorProps[idx]];
  }

  /* istanbul ignore else */
  if (Error.captureStackTrace) {
    Error.captureStackTrace(this, Exception);
  }

  if (loc) {
    this.lineNumber = line;
    this.column = column;
  }
}

Exception.prototype = new Error();

exports['default'] = Exception;
module.exports = exports['default'];


},{}],11:[function(require,module,exports){
'use strict';

exports.__esModule = true;
exports.registerDefaultHelpers = registerDefaultHelpers;
// istanbul ignore next

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _helpersBlockHelperMissing = require('./helpers/block-helper-missing');

var _helpersBlockHelperMissing2 = _interopRequireDefault(_helpersBlockHelperMissing);

var _helpersEach = require('./helpers/each');

var _helpersEach2 = _interopRequireDefault(_helpersEach);

var _helpersHelperMissing = require('./helpers/helper-missing');

var _helpersHelperMissing2 = _interopRequireDefault(_helpersHelperMissing);

var _helpersIf = require('./helpers/if');

var _helpersIf2 = _interopRequireDefault(_helpersIf);

var _helpersLog = require('./helpers/log');

var _helpersLog2 = _interopRequireDefault(_helpersLog);

var _helpersLookup = require('./helpers/lookup');

var _helpersLookup2 = _interopRequireDefault(_helpersLookup);

var _helpersWith = require('./helpers/with');

var _helpersWith2 = _interopRequireDefault(_helpersWith);

function registerDefaultHelpers(instance) {
  _helpersBlockHelperMissing2['default'](instance);
  _helpersEach2['default'](instance);
  _helpersHelperMissing2['default'](instance);
  _helpersIf2['default'](instance);
  _helpersLog2['default'](instance);
  _helpersLookup2['default'](instance);
  _helpersWith2['default'](instance);
}


},{"./helpers/block-helper-missing":12,"./helpers/each":13,"./helpers/helper-missing":14,"./helpers/if":15,"./helpers/log":16,"./helpers/lookup":17,"./helpers/with":18}],12:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _utils = require('../utils');

exports['default'] = function (instance) {
  instance.registerHelper('blockHelperMissing', function (context, options) {
    var inverse = options.inverse,
        fn = options.fn;

    if (context === true) {
      return fn(this);
    } else if (context === false || context == null) {
      return inverse(this);
    } else if (_utils.isArray(context)) {
      if (context.length > 0) {
        if (options.ids) {
          options.ids = [options.name];
        }

        return instance.helpers.each(context, options);
      } else {
        return inverse(this);
      }
    } else {
      if (options.data && options.ids) {
        var data = _utils.createFrame(options.data);
        data.contextPath = _utils.appendContextPath(options.data.contextPath, options.name);
        options = { data: data };
      }

      return fn(context, options);
    }
  });
};

module.exports = exports['default'];


},{"../utils":23}],13:[function(require,module,exports){
'use strict';

exports.__esModule = true;
// istanbul ignore next

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _utils = require('../utils');

var _exception = require('../exception');

var _exception2 = _interopRequireDefault(_exception);

exports['default'] = function (instance) {
  instance.registerHelper('each', function (context, options) {
    if (!options) {
      throw new _exception2['default']('Must pass iterator to #each');
    }

    var fn = options.fn,
        inverse = options.inverse,
        i = 0,
        ret = '',
        data = undefined,
        contextPath = undefined;

    if (options.data && options.ids) {
      contextPath = _utils.appendContextPath(options.data.contextPath, options.ids[0]) + '.';
    }

    if (_utils.isFunction(context)) {
      context = context.call(this);
    }

    if (options.data) {
      data = _utils.createFrame(options.data);
    }

    function execIteration(field, index, last) {
      if (data) {
        data.key = field;
        data.index = index;
        data.first = index === 0;
        data.last = !!last;

        if (contextPath) {
          data.contextPath = contextPath + field;
        }
      }

      ret = ret + fn(context[field], {
        data: data,
        blockParams: _utils.blockParams([context[field], field], [contextPath + field, null])
      });
    }

    if (context && typeof context === 'object') {
      if (_utils.isArray(context)) {
        for (var j = context.length; i < j; i++) {
          if (i in context) {
            execIteration(i, i, i === context.length - 1);
          }
        }
      } else {
        var priorKey = undefined;

        for (var key in context) {
          if (context.hasOwnProperty(key)) {
            // We're running the iterations one step out of sync so we can detect
            // the last iteration without have to scan the object twice and create
            // an itermediate keys array.
            if (priorKey !== undefined) {
              execIteration(priorKey, i - 1);
            }
            priorKey = key;
            i++;
          }
        }
        if (priorKey !== undefined) {
          execIteration(priorKey, i - 1, true);
        }
      }
    }

    if (i === 0) {
      ret = inverse(this);
    }

    return ret;
  });
};

module.exports = exports['default'];


},{"../exception":10,"../utils":23}],14:[function(require,module,exports){
'use strict';

exports.__esModule = true;
// istanbul ignore next

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _exception = require('../exception');

var _exception2 = _interopRequireDefault(_exception);

exports['default'] = function (instance) {
  instance.registerHelper('helperMissing', function () /* [args, ]options */{
    if (arguments.length === 1) {
      // A missing field in a {{foo}} construct.
      return undefined;
    } else {
      // Someone is actually trying to call something, blow up.
      throw new _exception2['default']('Missing helper: "' + arguments[arguments.length - 1].name + '"');
    }
  });
};

module.exports = exports['default'];


},{"../exception":10}],15:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _utils = require('../utils');

exports['default'] = function (instance) {
  instance.registerHelper('if', function (conditional, options) {
    if (_utils.isFunction(conditional)) {
      conditional = conditional.call(this);
    }

    // Default behavior is to render the positive path if the value is truthy and not empty.
    // The `includeZero` option may be set to treat the condtional as purely not empty based on the
    // behavior of isEmpty. Effectively this determines if 0 is handled by the positive path or negative.
    if (!options.hash.includeZero && !conditional || _utils.isEmpty(conditional)) {
      return options.inverse(this);
    } else {
      return options.fn(this);
    }
  });

  instance.registerHelper('unless', function (conditional, options) {
    return instance.helpers['if'].call(this, conditional, { fn: options.inverse, inverse: options.fn, hash: options.hash });
  });
};

module.exports = exports['default'];


},{"../utils":23}],16:[function(require,module,exports){
'use strict';

exports.__esModule = true;

exports['default'] = function (instance) {
  instance.registerHelper('log', function () /* message, options */{
    var args = [undefined],
        options = arguments[arguments.length - 1];
    for (var i = 0; i < arguments.length - 1; i++) {
      args.push(arguments[i]);
    }

    var level = 1;
    if (options.hash.level != null) {
      level = options.hash.level;
    } else if (options.data && options.data.level != null) {
      level = options.data.level;
    }
    args[0] = level;

    instance.log.apply(instance, args);
  });
};

module.exports = exports['default'];


},{}],17:[function(require,module,exports){
'use strict';

exports.__esModule = true;

exports['default'] = function (instance) {
  instance.registerHelper('lookup', function (obj, field) {
    return obj && obj[field];
  });
};

module.exports = exports['default'];


},{}],18:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _utils = require('../utils');

exports['default'] = function (instance) {
  instance.registerHelper('with', function (context, options) {
    if (_utils.isFunction(context)) {
      context = context.call(this);
    }

    var fn = options.fn;

    if (!_utils.isEmpty(context)) {
      var data = options.data;
      if (options.data && options.ids) {
        data = _utils.createFrame(options.data);
        data.contextPath = _utils.appendContextPath(options.data.contextPath, options.ids[0]);
      }

      return fn(context, {
        data: data,
        blockParams: _utils.blockParams([context], [data && data.contextPath])
      });
    } else {
      return options.inverse(this);
    }
  });
};

module.exports = exports['default'];


},{"../utils":23}],19:[function(require,module,exports){
'use strict';

exports.__esModule = true;

var _utils = require('./utils');

var logger = {
  methodMap: ['debug', 'info', 'warn', 'error'],
  level: 'info',

  // Maps a given level value to the `methodMap` indexes above.
  lookupLevel: function lookupLevel(level) {
    if (typeof level === 'string') {
      var levelMap = _utils.indexOf(logger.methodMap, level.toLowerCase());
      if (levelMap >= 0) {
        level = levelMap;
      } else {
        level = parseInt(level, 10);
      }
    }

    return level;
  },

  // Can be overridden in the host environment
  log: function log(level) {
    level = logger.lookupLevel(level);

    if (typeof console !== 'undefined' && logger.lookupLevel(logger.level) <= level) {
      var method = logger.methodMap[level];
      if (!console[method]) {
        // eslint-disable-line no-console
        method = 'log';
      }

      for (var _len = arguments.length, message = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        message[_key - 1] = arguments[_key];
      }

      console[method].apply(console, message); // eslint-disable-line no-console
    }
  }
};

exports['default'] = logger;
module.exports = exports['default'];


},{"./utils":23}],20:[function(require,module,exports){
(function (global){
/* global window */
'use strict';

exports.__esModule = true;

exports['default'] = function (Handlebars) {
  /* istanbul ignore next */
  var root = typeof global !== 'undefined' ? global : window,
      $Handlebars = root.Handlebars;
  /* istanbul ignore next */
  Handlebars.noConflict = function () {
    if (root.Handlebars === Handlebars) {
      root.Handlebars = $Handlebars;
    }
    return Handlebars;
  };
};

module.exports = exports['default'];


}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],21:[function(require,module,exports){
'use strict';

exports.__esModule = true;
exports.checkRevision = checkRevision;
exports.template = template;
exports.wrapProgram = wrapProgram;
exports.resolvePartial = resolvePartial;
exports.invokePartial = invokePartial;
exports.noop = noop;
// istanbul ignore next

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

// istanbul ignore next

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj['default'] = obj; return newObj; } }

var _utils = require('./utils');

var Utils = _interopRequireWildcard(_utils);

var _exception = require('./exception');

var _exception2 = _interopRequireDefault(_exception);

var _base = require('./base');

function checkRevision(compilerInfo) {
  var compilerRevision = compilerInfo && compilerInfo[0] || 1,
      currentRevision = _base.COMPILER_REVISION;

  if (compilerRevision !== currentRevision) {
    if (compilerRevision < currentRevision) {
      var runtimeVersions = _base.REVISION_CHANGES[currentRevision],
          compilerVersions = _base.REVISION_CHANGES[compilerRevision];
      throw new _exception2['default']('Template was precompiled with an older version of Handlebars than the current runtime. ' + 'Please update your precompiler to a newer version (' + runtimeVersions + ') or downgrade your runtime to an older version (' + compilerVersions + ').');
    } else {
      // Use the embedded version info since the runtime doesn't know about this revision yet
      throw new _exception2['default']('Template was precompiled with a newer version of Handlebars than the current runtime. ' + 'Please update your runtime to a newer version (' + compilerInfo[1] + ').');
    }
  }
}

function template(templateSpec, env) {
  /* istanbul ignore next */
  if (!env) {
    throw new _exception2['default']('No environment passed to template');
  }
  if (!templateSpec || !templateSpec.main) {
    throw new _exception2['default']('Unknown template object: ' + typeof templateSpec);
  }

  templateSpec.main.decorator = templateSpec.main_d;

  // Note: Using env.VM references rather than local var references throughout this section to allow
  // for external users to override these as psuedo-supported APIs.
  env.VM.checkRevision(templateSpec.compiler);

  function invokePartialWrapper(partial, context, options) {
    if (options.hash) {
      context = Utils.extend({}, context, options.hash);
      if (options.ids) {
        options.ids[0] = true;
      }
    }

    partial = env.VM.resolvePartial.call(this, partial, context, options);
    var result = env.VM.invokePartial.call(this, partial, context, options);

    if (result == null && env.compile) {
      options.partials[options.name] = env.compile(partial, templateSpec.compilerOptions, env);
      result = options.partials[options.name](context, options);
    }
    if (result != null) {
      if (options.indent) {
        var lines = result.split('\n');
        for (var i = 0, l = lines.length; i < l; i++) {
          if (!lines[i] && i + 1 === l) {
            break;
          }

          lines[i] = options.indent + lines[i];
        }
        result = lines.join('\n');
      }
      return result;
    } else {
      throw new _exception2['default']('The partial ' + options.name + ' could not be compiled when running in runtime-only mode');
    }
  }

  // Just add water
  var container = {
    strict: function strict(obj, name) {
      if (!(name in obj)) {
        throw new _exception2['default']('"' + name + '" not defined in ' + obj);
      }
      return obj[name];
    },
    lookup: function lookup(depths, name) {
      var len = depths.length;
      for (var i = 0; i < len; i++) {
        if (depths[i] && depths[i][name] != null) {
          return depths[i][name];
        }
      }
    },
    lambda: function lambda(current, context) {
      return typeof current === 'function' ? current.call(context) : current;
    },

    escapeExpression: Utils.escapeExpression,
    invokePartial: invokePartialWrapper,

    fn: function fn(i) {
      var ret = templateSpec[i];
      ret.decorator = templateSpec[i + '_d'];
      return ret;
    },

    programs: [],
    program: function program(i, data, declaredBlockParams, blockParams, depths) {
      var programWrapper = this.programs[i],
          fn = this.fn(i);
      if (data || depths || blockParams || declaredBlockParams) {
        programWrapper = wrapProgram(this, i, fn, data, declaredBlockParams, blockParams, depths);
      } else if (!programWrapper) {
        programWrapper = this.programs[i] = wrapProgram(this, i, fn);
      }
      return programWrapper;
    },

    data: function data(value, depth) {
      while (value && depth--) {
        value = value._parent;
      }
      return value;
    },
    merge: function merge(param, common) {
      var obj = param || common;

      if (param && common && param !== common) {
        obj = Utils.extend({}, common, param);
      }

      return obj;
    },

    noop: env.VM.noop,
    compilerInfo: templateSpec.compiler
  };

  function ret(context) {
    var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    var data = options.data;

    ret._setup(options);
    if (!options.partial && templateSpec.useData) {
      data = initData(context, data);
    }
    var depths = undefined,
        blockParams = templateSpec.useBlockParams ? [] : undefined;
    if (templateSpec.useDepths) {
      if (options.depths) {
        depths = context !== options.depths[0] ? [context].concat(options.depths) : options.depths;
      } else {
        depths = [context];
      }
    }

    function main(context /*, options*/) {
      return '' + templateSpec.main(container, context, container.helpers, container.partials, data, blockParams, depths);
    }
    main = executeDecorators(templateSpec.main, main, container, options.depths || [], data, blockParams);
    return main(context, options);
  }
  ret.isTop = true;

  ret._setup = function (options) {
    if (!options.partial) {
      container.helpers = container.merge(options.helpers, env.helpers);

      if (templateSpec.usePartial) {
        container.partials = container.merge(options.partials, env.partials);
      }
      if (templateSpec.usePartial || templateSpec.useDecorators) {
        container.decorators = container.merge(options.decorators, env.decorators);
      }
    } else {
      container.helpers = options.helpers;
      container.partials = options.partials;
      container.decorators = options.decorators;
    }
  };

  ret._child = function (i, data, blockParams, depths) {
    if (templateSpec.useBlockParams && !blockParams) {
      throw new _exception2['default']('must pass block params');
    }
    if (templateSpec.useDepths && !depths) {
      throw new _exception2['default']('must pass parent depths');
    }

    return wrapProgram(container, i, templateSpec[i], data, 0, blockParams, depths);
  };
  return ret;
}

function wrapProgram(container, i, fn, data, declaredBlockParams, blockParams, depths) {
  function prog(context) {
    var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    var currentDepths = depths;
    if (depths && context !== depths[0]) {
      currentDepths = [context].concat(depths);
    }

    return fn(container, context, container.helpers, container.partials, options.data || data, blockParams && [options.blockParams].concat(blockParams), currentDepths);
  }

  prog = executeDecorators(fn, prog, container, depths, data, blockParams);

  prog.program = i;
  prog.depth = depths ? depths.length : 0;
  prog.blockParams = declaredBlockParams || 0;
  return prog;
}

function resolvePartial(partial, context, options) {
  if (!partial) {
    if (options.name === '@partial-block') {
      partial = options.data['partial-block'];
    } else {
      partial = options.partials[options.name];
    }
  } else if (!partial.call && !options.name) {
    // This is a dynamic partial that returned a string
    options.name = partial;
    partial = options.partials[partial];
  }
  return partial;
}

function invokePartial(partial, context, options) {
  options.partial = true;
  if (options.ids) {
    options.data.contextPath = options.ids[0] || options.data.contextPath;
  }

  var partialBlock = undefined;
  if (options.fn && options.fn !== noop) {
    options.data = _base.createFrame(options.data);
    partialBlock = options.data['partial-block'] = options.fn;

    if (partialBlock.partials) {
      options.partials = Utils.extend({}, options.partials, partialBlock.partials);
    }
  }

  if (partial === undefined && partialBlock) {
    partial = partialBlock;
  }

  if (partial === undefined) {
    throw new _exception2['default']('The partial ' + options.name + ' could not be found');
  } else if (partial instanceof Function) {
    return partial(context, options);
  }
}

function noop() {
  return '';
}

function initData(context, data) {
  if (!data || !('root' in data)) {
    data = data ? _base.createFrame(data) : {};
    data.root = context;
  }
  return data;
}

function executeDecorators(fn, prog, container, depths, data, blockParams) {
  if (fn.decorator) {
    var props = {};
    prog = fn.decorator(prog, props, container, depths && depths[0], data, blockParams, depths);
    Utils.extend(prog, props);
  }
  return prog;
}


},{"./base":7,"./exception":10,"./utils":23}],22:[function(require,module,exports){
// Build out our basic SafeString type
'use strict';

exports.__esModule = true;
function SafeString(string) {
  this.string = string;
}

SafeString.prototype.toString = SafeString.prototype.toHTML = function () {
  return '' + this.string;
};

exports['default'] = SafeString;
module.exports = exports['default'];


},{}],23:[function(require,module,exports){
'use strict';

exports.__esModule = true;
exports.extend = extend;
exports.indexOf = indexOf;
exports.escapeExpression = escapeExpression;
exports.isEmpty = isEmpty;
exports.createFrame = createFrame;
exports.blockParams = blockParams;
exports.appendContextPath = appendContextPath;
var escape = {
  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;',
  '"': '&quot;',
  "'": '&#x27;',
  '`': '&#x60;',
  '=': '&#x3D;'
};

var badChars = /[&<>"'`=]/g,
    possible = /[&<>"'`=]/;

function escapeChar(chr) {
  return escape[chr];
}

function extend(obj /* , ...source */) {
  for (var i = 1; i < arguments.length; i++) {
    for (var key in arguments[i]) {
      if (Object.prototype.hasOwnProperty.call(arguments[i], key)) {
        obj[key] = arguments[i][key];
      }
    }
  }

  return obj;
}

var toString = Object.prototype.toString;

exports.toString = toString;
// Sourced from lodash
// https://github.com/bestiejs/lodash/blob/master/LICENSE.txt
/* eslint-disable func-style */
var isFunction = function isFunction(value) {
  return typeof value === 'function';
};
// fallback for older versions of Chrome and Safari
/* istanbul ignore next */
if (isFunction(/x/)) {
  exports.isFunction = isFunction = function (value) {
    return typeof value === 'function' && toString.call(value) === '[object Function]';
  };
}
exports.isFunction = isFunction;

/* eslint-enable func-style */

/* istanbul ignore next */
var isArray = Array.isArray || function (value) {
  return value && typeof value === 'object' ? toString.call(value) === '[object Array]' : false;
};

exports.isArray = isArray;
// Older IE versions do not directly support indexOf so we must implement our own, sadly.

function indexOf(array, value) {
  for (var i = 0, len = array.length; i < len; i++) {
    if (array[i] === value) {
      return i;
    }
  }
  return -1;
}

function escapeExpression(string) {
  if (typeof string !== 'string') {
    // don't escape SafeStrings, since they're already safe
    if (string && string.toHTML) {
      return string.toHTML();
    } else if (string == null) {
      return '';
    } else if (!string) {
      return string + '';
    }

    // Force a string conversion as this will be done by the append regardless and
    // the regex test will do this transparently behind the scenes, causing issues if
    // an object's to string has escaped characters in it.
    string = '' + string;
  }

  if (!possible.test(string)) {
    return string;
  }
  return string.replace(badChars, escapeChar);
}

function isEmpty(value) {
  if (!value && value !== 0) {
    return true;
  } else if (isArray(value) && value.length === 0) {
    return true;
  } else {
    return false;
  }
}

function createFrame(object) {
  var frame = extend({}, object);
  frame._parent = object;
  return frame;
}

function blockParams(params, ids) {
  params.path = ids;
  return params;
}

function appendContextPath(contextPath, id) {
  return (contextPath ? contextPath + '.' : '') + id;
}


},{}],24:[function(require,module,exports){
// Create a simple path alias to allow browserify to resolve
// the runtime on a supported path.
module.exports = require('./dist/cjs/handlebars.runtime')['default'];

},{"./dist/cjs/handlebars.runtime":6}],25:[function(require,module,exports){
module.exports = require("handlebars/runtime")["default"];

},{"handlebars/runtime":24}],26:[function(require,module,exports){
/**
 * lunr - http://lunrjs.com - A bit like Solr, but much smaller and not as bright - 0.7.1
 * Copyright (C) 2016 Oliver Nightingale
 * @license MIT
 */

;(function(){

/**
 * Convenience function for instantiating a new lunr index and configuring it
 * with the default pipeline functions and the passed config function.
 *
 * When using this convenience function a new index will be created with the
 * following functions already in the pipeline:
 *
 * lunr.StopWordFilter - filters out any stop words before they enter the
 * index
 *
 * lunr.stemmer - stems the tokens before entering the index.
 *
 * Example:
 *
 *     var idx = lunr(function () {
 *       this.field('title', 10)
 *       this.field('tags', 100)
 *       this.field('body')
 *       
 *       this.ref('cid')
 *       
 *       this.pipeline.add(function () {
 *         // some custom pipeline function
 *       })
 *       
 *     })
 *
 * @param {Function} config A function that will be called with the new instance
 * of the lunr.Index as both its context and first parameter. It can be used to
 * customize the instance of new lunr.Index.
 * @namespace
 * @module
 * @returns {lunr.Index}
 *
 */
var lunr = function (config) {
  var idx = new lunr.Index

  idx.pipeline.add(
    lunr.trimmer,
    lunr.stopWordFilter,
    lunr.stemmer
  )

  if (config) config.call(idx, idx)

  return idx
}

lunr.version = "0.7.1"
/*!
 * lunr.utils
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * A namespace containing utils for the rest of the lunr library
 */
lunr.utils = {}

/**
 * Print a warning message to the console.
 *
 * @param {String} message The message to be printed.
 * @memberOf Utils
 */
lunr.utils.warn = (function (global) {
  return function (message) {
    if (global.console && console.warn) {
      console.warn(message)
    }
  }
})(this)

/**
 * Convert an object to a string.
 *
 * In the case of `null` and `undefined` the function returns
 * the empty string, in all other cases the result of calling
 * `toString` on the passed object is returned.
 *
 * @param {Any} obj The object to convert to a string.
 * @return {String} string representation of the passed object.
 * @memberOf Utils
 */
lunr.utils.asString = function (obj) {
  if (obj === void 0 || obj === null) {
    return ""
  } else {
    return obj.toString()
  }
}
/*!
 * lunr.EventEmitter
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * lunr.EventEmitter is an event emitter for lunr. It manages adding and removing event handlers and triggering events and their handlers.
 *
 * @constructor
 */
lunr.EventEmitter = function () {
  this.events = {}
}

/**
 * Binds a handler function to a specific event(s).
 *
 * Can bind a single function to many different events in one call.
 *
 * @param {String} [eventName] The name(s) of events to bind this function to.
 * @param {Function} fn The function to call when an event is fired.
 * @memberOf EventEmitter
 */
lunr.EventEmitter.prototype.addListener = function () {
  var args = Array.prototype.slice.call(arguments),
      fn = args.pop(),
      names = args

  if (typeof fn !== "function") throw new TypeError ("last argument must be a function")

  names.forEach(function (name) {
    if (!this.hasHandler(name)) this.events[name] = []
    this.events[name].push(fn)
  }, this)
}

/**
 * Removes a handler function from a specific event.
 *
 * @param {String} eventName The name of the event to remove this function from.
 * @param {Function} fn The function to remove from an event.
 * @memberOf EventEmitter
 */
lunr.EventEmitter.prototype.removeListener = function (name, fn) {
  if (!this.hasHandler(name)) return

  var fnIndex = this.events[name].indexOf(fn)
  this.events[name].splice(fnIndex, 1)

  if (!this.events[name].length) delete this.events[name]
}

/**
 * Calls all functions bound to the given event.
 *
 * Additional data can be passed to the event handler as arguments to `emit`
 * after the event name.
 *
 * @param {String} eventName The name of the event to emit.
 * @memberOf EventEmitter
 */
lunr.EventEmitter.prototype.emit = function (name) {
  if (!this.hasHandler(name)) return

  var args = Array.prototype.slice.call(arguments, 1)

  this.events[name].forEach(function (fn) {
    fn.apply(undefined, args)
  })
}

/**
 * Checks whether a handler has ever been stored against an event.
 *
 * @param {String} eventName The name of the event to check.
 * @private
 * @memberOf EventEmitter
 */
lunr.EventEmitter.prototype.hasHandler = function (name) {
  return name in this.events
}

/*!
 * lunr.tokenizer
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * A function for splitting a string into tokens ready to be inserted into
 * the search index. Uses `lunr.tokenizer.seperator` to split strings, change
 * the value of this property to change how strings are split into tokens.
 *
 * @module
 * @param {String} obj The string to convert into tokens
 * @see lunr.tokenizer.seperator
 * @returns {Array}
 */
lunr.tokenizer = function (obj) {
  if (!arguments.length || obj == null || obj == undefined) return []
  if (Array.isArray(obj)) return obj.map(function (t) { return lunr.utils.asString(t).toLowerCase() })

  return obj.toString().trim().toLowerCase().split(lunr.tokenizer.seperator)
}

/**
 * The sperator used to split a string into tokens. Override this property to change the behaviour of
 * `lunr.tokenizer` behaviour when tokenizing strings. By default this splits on whitespace and hyphens.
 *
 * @static
 * @see lunr.tokenizer
 */
lunr.tokenizer.seperator = /[\s\-]+/

/**
 * Loads a previously serialised tokenizer.
 *
 * A tokenizer function to be loaded must already be registered with lunr.tokenizer.
 * If the serialised tokenizer has not been registered then an error will be thrown.
 *
 * @param {String} label The label of the serialised tokenizer.
 * @returns {Function}
 * @memberOf tokenizer
 */
lunr.tokenizer.load = function (label) {
  var fn = this.registeredFunctions[label]

  if (!fn) {
    throw new Error('Cannot load un-registered function: ' + label)
  }

  return fn
}

lunr.tokenizer.label = 'default'

lunr.tokenizer.registeredFunctions = {
  'default': lunr.tokenizer
}

/**
 * Register a tokenizer function.
 *
 * Functions that are used as tokenizers should be registered if they are to be used with a serialised index.
 *
 * Registering a function does not add it to an index, functions must still be associated with a specific index for them to be used when indexing and searching documents.
 *
 * @param {Function} fn The function to register.
 * @param {String} label The label to register this function with
 * @memberOf tokenizer
 */
lunr.tokenizer.registerFunction = function (fn, label) {
  if (label in this.registeredFunctions) {
    lunr.utils.warn('Overwriting existing tokenizer: ' + label)
  }

  fn.label = label
  this.registeredFunctions[label] = fn
}
/*!
 * lunr.Pipeline
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * lunr.Pipelines maintain an ordered list of functions to be applied to all
 * tokens in documents entering the search index and queries being ran against
 * the index.
 *
 * An instance of lunr.Index created with the lunr shortcut will contain a
 * pipeline with a stop word filter and an English language stemmer. Extra
 * functions can be added before or after either of these functions or these
 * default functions can be removed.
 *
 * When run the pipeline will call each function in turn, passing a token, the
 * index of that token in the original list of all tokens and finally a list of
 * all the original tokens.
 *
 * The output of functions in the pipeline will be passed to the next function
 * in the pipeline. To exclude a token from entering the index the function
 * should return undefined, the rest of the pipeline will not be called with
 * this token.
 *
 * For serialisation of pipelines to work, all functions used in an instance of
 * a pipeline should be registered with lunr.Pipeline. Registered functions can
 * then be loaded. If trying to load a serialised pipeline that uses functions
 * that are not registered an error will be thrown.
 *
 * If not planning on serialising the pipeline then registering pipeline functions
 * is not necessary.
 *
 * @constructor
 */
lunr.Pipeline = function () {
  this._stack = []
}

lunr.Pipeline.registeredFunctions = {}

/**
 * Register a function with the pipeline.
 *
 * Functions that are used in the pipeline should be registered if the pipeline
 * needs to be serialised, or a serialised pipeline needs to be loaded.
 *
 * Registering a function does not add it to a pipeline, functions must still be
 * added to instances of the pipeline for them to be used when running a pipeline.
 *
 * @param {Function} fn The function to check for.
 * @param {String} label The label to register this function with
 * @memberOf Pipeline
 */
lunr.Pipeline.registerFunction = function (fn, label) {
  if (label in this.registeredFunctions) {
    lunr.utils.warn('Overwriting existing registered function: ' + label)
  }

  fn.label = label
  lunr.Pipeline.registeredFunctions[fn.label] = fn
}

/**
 * Warns if the function is not registered as a Pipeline function.
 *
 * @param {Function} fn The function to check for.
 * @private
 * @memberOf Pipeline
 */
lunr.Pipeline.warnIfFunctionNotRegistered = function (fn) {
  var isRegistered = fn.label && (fn.label in this.registeredFunctions)

  if (!isRegistered) {
    lunr.utils.warn('Function is not registered with pipeline. This may cause problems when serialising the index.\n', fn)
  }
}

/**
 * Loads a previously serialised pipeline.
 *
 * All functions to be loaded must already be registered with lunr.Pipeline.
 * If any function from the serialised data has not been registered then an
 * error will be thrown.
 *
 * @param {Object} serialised The serialised pipeline to load.
 * @returns {lunr.Pipeline}
 * @memberOf Pipeline
 */
lunr.Pipeline.load = function (serialised) {
  var pipeline = new lunr.Pipeline

  serialised.forEach(function (fnName) {
    var fn = lunr.Pipeline.registeredFunctions[fnName]

    if (fn) {
      pipeline.add(fn)
    } else {
      throw new Error('Cannot load un-registered function: ' + fnName)
    }
  })

  return pipeline
}

/**
 * Adds new functions to the end of the pipeline.
 *
 * Logs a warning if the function has not been registered.
 *
 * @param {Function} functions Any number of functions to add to the pipeline.
 * @memberOf Pipeline
 */
lunr.Pipeline.prototype.add = function () {
  var fns = Array.prototype.slice.call(arguments)

  fns.forEach(function (fn) {
    lunr.Pipeline.warnIfFunctionNotRegistered(fn)
    this._stack.push(fn)
  }, this)
}

/**
 * Adds a single function after a function that already exists in the
 * pipeline.
 *
 * Logs a warning if the function has not been registered.
 *
 * @param {Function} existingFn A function that already exists in the pipeline.
 * @param {Function} newFn The new function to add to the pipeline.
 * @memberOf Pipeline
 */
lunr.Pipeline.prototype.after = function (existingFn, newFn) {
  lunr.Pipeline.warnIfFunctionNotRegistered(newFn)

  var pos = this._stack.indexOf(existingFn)
  if (pos == -1) {
    throw new Error('Cannot find existingFn')
  }

  pos = pos + 1
  this._stack.splice(pos, 0, newFn)
}

/**
 * Adds a single function before a function that already exists in the
 * pipeline.
 *
 * Logs a warning if the function has not been registered.
 *
 * @param {Function} existingFn A function that already exists in the pipeline.
 * @param {Function} newFn The new function to add to the pipeline.
 * @memberOf Pipeline
 */
lunr.Pipeline.prototype.before = function (existingFn, newFn) {
  lunr.Pipeline.warnIfFunctionNotRegistered(newFn)

  var pos = this._stack.indexOf(existingFn)
  if (pos == -1) {
    throw new Error('Cannot find existingFn')
  }

  this._stack.splice(pos, 0, newFn)
}

/**
 * Removes a function from the pipeline.
 *
 * @param {Function} fn The function to remove from the pipeline.
 * @memberOf Pipeline
 */
lunr.Pipeline.prototype.remove = function (fn) {
  var pos = this._stack.indexOf(fn)
  if (pos == -1) {
    return
  }

  this._stack.splice(pos, 1)
}

/**
 * Runs the current list of functions that make up the pipeline against the
 * passed tokens.
 *
 * @param {Array} tokens The tokens to run through the pipeline.
 * @returns {Array}
 * @memberOf Pipeline
 */
lunr.Pipeline.prototype.run = function (tokens) {
  var out = [],
      tokenLength = tokens.length,
      stackLength = this._stack.length

  for (var i = 0; i < tokenLength; i++) {
    var token = tokens[i]

    for (var j = 0; j < stackLength; j++) {
      token = this._stack[j](token, i, tokens)
      if (token === void 0 || token === '') break
    };

    if (token !== void 0 && token !== '') out.push(token)
  };

  return out
}

/**
 * Resets the pipeline by removing any existing processors.
 *
 * @memberOf Pipeline
 */
lunr.Pipeline.prototype.reset = function () {
  this._stack = []
}

/**
 * Returns a representation of the pipeline ready for serialisation.
 *
 * Logs a warning if the function has not been registered.
 *
 * @returns {Array}
 * @memberOf Pipeline
 */
lunr.Pipeline.prototype.toJSON = function () {
  return this._stack.map(function (fn) {
    lunr.Pipeline.warnIfFunctionNotRegistered(fn)

    return fn.label
  })
}
/*!
 * lunr.Vector
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * lunr.Vectors implement vector related operations for
 * a series of elements.
 *
 * @constructor
 */
lunr.Vector = function () {
  this._magnitude = null
  this.list = undefined
  this.length = 0
}

/**
 * lunr.Vector.Node is a simple struct for each node
 * in a lunr.Vector.
 *
 * @private
 * @param {Number} The index of the node in the vector.
 * @param {Object} The data at this node in the vector.
 * @param {lunr.Vector.Node} The node directly after this node in the vector.
 * @constructor
 * @memberOf Vector
 */
lunr.Vector.Node = function (idx, val, next) {
  this.idx = idx
  this.val = val
  this.next = next
}

/**
 * Inserts a new value at a position in a vector.
 *
 * @param {Number} The index at which to insert a value.
 * @param {Object} The object to insert in the vector.
 * @memberOf Vector.
 */
lunr.Vector.prototype.insert = function (idx, val) {
  this._magnitude = undefined;
  var list = this.list

  if (!list) {
    this.list = new lunr.Vector.Node (idx, val, list)
    return this.length++
  }

  if (idx < list.idx) {
    this.list = new lunr.Vector.Node (idx, val, list)
    return this.length++
  }

  var prev = list,
      next = list.next

  while (next != undefined) {
    if (idx < next.idx) {
      prev.next = new lunr.Vector.Node (idx, val, next)
      return this.length++
    }

    prev = next, next = next.next
  }

  prev.next = new lunr.Vector.Node (idx, val, next)
  return this.length++
}

/**
 * Calculates the magnitude of this vector.
 *
 * @returns {Number}
 * @memberOf Vector
 */
lunr.Vector.prototype.magnitude = function () {
  if (this._magnitude) return this._magnitude
  var node = this.list,
      sumOfSquares = 0,
      val

  while (node) {
    val = node.val
    sumOfSquares += val * val
    node = node.next
  }

  return this._magnitude = Math.sqrt(sumOfSquares)
}

/**
 * Calculates the dot product of this vector and another vector.
 *
 * @param {lunr.Vector} otherVector The vector to compute the dot product with.
 * @returns {Number}
 * @memberOf Vector
 */
lunr.Vector.prototype.dot = function (otherVector) {
  var node = this.list,
      otherNode = otherVector.list,
      dotProduct = 0

  while (node && otherNode) {
    if (node.idx < otherNode.idx) {
      node = node.next
    } else if (node.idx > otherNode.idx) {
      otherNode = otherNode.next
    } else {
      dotProduct += node.val * otherNode.val
      node = node.next
      otherNode = otherNode.next
    }
  }

  return dotProduct
}

/**
 * Calculates the cosine similarity between this vector and another
 * vector.
 *
 * @param {lunr.Vector} otherVector The other vector to calculate the
 * similarity with.
 * @returns {Number}
 * @memberOf Vector
 */
lunr.Vector.prototype.similarity = function (otherVector) {
  return this.dot(otherVector) / (this.magnitude() * otherVector.magnitude())
}
/*!
 * lunr.SortedSet
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * lunr.SortedSets are used to maintain an array of uniq values in a sorted
 * order.
 *
 * @constructor
 */
lunr.SortedSet = function () {
  this.length = 0
  this.elements = []
}

/**
 * Loads a previously serialised sorted set.
 *
 * @param {Array} serialisedData The serialised set to load.
 * @returns {lunr.SortedSet}
 * @memberOf SortedSet
 */
lunr.SortedSet.load = function (serialisedData) {
  var set = new this

  set.elements = serialisedData
  set.length = serialisedData.length

  return set
}

/**
 * Inserts new items into the set in the correct position to maintain the
 * order.
 *
 * @param {Object} The objects to add to this set.
 * @memberOf SortedSet
 */
lunr.SortedSet.prototype.add = function () {
  var i, element

  for (i = 0; i < arguments.length; i++) {
    element = arguments[i]
    if (~this.indexOf(element)) continue
    this.elements.splice(this.locationFor(element), 0, element)
  }

  this.length = this.elements.length
}

/**
 * Converts this sorted set into an array.
 *
 * @returns {Array}
 * @memberOf SortedSet
 */
lunr.SortedSet.prototype.toArray = function () {
  return this.elements.slice()
}

/**
 * Creates a new array with the results of calling a provided function on every
 * element in this sorted set.
 *
 * Delegates to Array.prototype.map and has the same signature.
 *
 * @param {Function} fn The function that is called on each element of the
 * set.
 * @param {Object} ctx An optional object that can be used as the context
 * for the function fn.
 * @returns {Array}
 * @memberOf SortedSet
 */
lunr.SortedSet.prototype.map = function (fn, ctx) {
  return this.elements.map(fn, ctx)
}

/**
 * Executes a provided function once per sorted set element.
 *
 * Delegates to Array.prototype.forEach and has the same signature.
 *
 * @param {Function} fn The function that is called on each element of the
 * set.
 * @param {Object} ctx An optional object that can be used as the context
 * @memberOf SortedSet
 * for the function fn.
 */
lunr.SortedSet.prototype.forEach = function (fn, ctx) {
  return this.elements.forEach(fn, ctx)
}

/**
 * Returns the index at which a given element can be found in the
 * sorted set, or -1 if it is not present.
 *
 * @param {Object} elem The object to locate in the sorted set.
 * @returns {Number}
 * @memberOf SortedSet
 */
lunr.SortedSet.prototype.indexOf = function (elem) {
  var start = 0,
      end = this.elements.length,
      sectionLength = end - start,
      pivot = start + Math.floor(sectionLength / 2),
      pivotElem = this.elements[pivot]

  while (sectionLength > 1) {
    if (pivotElem === elem) return pivot

    if (pivotElem < elem) start = pivot
    if (pivotElem > elem) end = pivot

    sectionLength = end - start
    pivot = start + Math.floor(sectionLength / 2)
    pivotElem = this.elements[pivot]
  }

  if (pivotElem === elem) return pivot

  return -1
}

/**
 * Returns the position within the sorted set that an element should be
 * inserted at to maintain the current order of the set.
 *
 * This function assumes that the element to search for does not already exist
 * in the sorted set.
 *
 * @param {Object} elem The elem to find the position for in the set
 * @returns {Number}
 * @memberOf SortedSet
 */
lunr.SortedSet.prototype.locationFor = function (elem) {
  var start = 0,
      end = this.elements.length,
      sectionLength = end - start,
      pivot = start + Math.floor(sectionLength / 2),
      pivotElem = this.elements[pivot]

  while (sectionLength > 1) {
    if (pivotElem < elem) start = pivot
    if (pivotElem > elem) end = pivot

    sectionLength = end - start
    pivot = start + Math.floor(sectionLength / 2)
    pivotElem = this.elements[pivot]
  }

  if (pivotElem > elem) return pivot
  if (pivotElem < elem) return pivot + 1
}

/**
 * Creates a new lunr.SortedSet that contains the elements in the intersection
 * of this set and the passed set.
 *
 * @param {lunr.SortedSet} otherSet The set to intersect with this set.
 * @returns {lunr.SortedSet}
 * @memberOf SortedSet
 */
lunr.SortedSet.prototype.intersect = function (otherSet) {
  var intersectSet = new lunr.SortedSet,
      i = 0, j = 0,
      a_len = this.length, b_len = otherSet.length,
      a = this.elements, b = otherSet.elements

  while (true) {
    if (i > a_len - 1 || j > b_len - 1) break

    if (a[i] === b[j]) {
      intersectSet.add(a[i])
      i++, j++
      continue
    }

    if (a[i] < b[j]) {
      i++
      continue
    }

    if (a[i] > b[j]) {
      j++
      continue
    }
  };

  return intersectSet
}

/**
 * Makes a copy of this set
 *
 * @returns {lunr.SortedSet}
 * @memberOf SortedSet
 */
lunr.SortedSet.prototype.clone = function () {
  var clone = new lunr.SortedSet

  clone.elements = this.toArray()
  clone.length = clone.elements.length

  return clone
}

/**
 * Creates a new lunr.SortedSet that contains the elements in the union
 * of this set and the passed set.
 *
 * @param {lunr.SortedSet} otherSet The set to union with this set.
 * @returns {lunr.SortedSet}
 * @memberOf SortedSet
 */
lunr.SortedSet.prototype.union = function (otherSet) {
  var longSet, shortSet, unionSet

  if (this.length >= otherSet.length) {
    longSet = this, shortSet = otherSet
  } else {
    longSet = otherSet, shortSet = this
  }

  unionSet = longSet.clone()

  for(var i = 0, shortSetElements = shortSet.toArray(); i < shortSetElements.length; i++){
    unionSet.add(shortSetElements[i])
  }

  return unionSet
}

/**
 * Returns a representation of the sorted set ready for serialisation.
 *
 * @returns {Array}
 * @memberOf SortedSet
 */
lunr.SortedSet.prototype.toJSON = function () {
  return this.toArray()
}
/*!
 * lunr.Index
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * lunr.Index is object that manages a search index.  It contains the indexes
 * and stores all the tokens and document lookups.  It also provides the main
 * user facing API for the library.
 *
 * @constructor
 */
lunr.Index = function () {
  this._fields = []
  this._ref = 'id'
  this.pipeline = new lunr.Pipeline
  this.documentStore = new lunr.Store
  this.tokenStore = new lunr.TokenStore
  this.corpusTokens = new lunr.SortedSet
  this.eventEmitter =  new lunr.EventEmitter
  this.tokenizerFn = lunr.tokenizer

  this._idfCache = {}

  this.on('add', 'remove', 'update', (function () {
    this._idfCache = {}
  }).bind(this))
}

/**
 * Bind a handler to events being emitted by the index.
 *
 * The handler can be bound to many events at the same time.
 *
 * @param {String} [eventName] The name(s) of events to bind the function to.
 * @param {Function} fn The serialised set to load.
 * @memberOf Index
 */
lunr.Index.prototype.on = function () {
  var args = Array.prototype.slice.call(arguments)
  return this.eventEmitter.addListener.apply(this.eventEmitter, args)
}

/**
 * Removes a handler from an event being emitted by the index.
 *
 * @param {String} eventName The name of events to remove the function from.
 * @param {Function} fn The serialised set to load.
 * @memberOf Index
 */
lunr.Index.prototype.off = function (name, fn) {
  return this.eventEmitter.removeListener(name, fn)
}

/**
 * Loads a previously serialised index.
 *
 * Issues a warning if the index being imported was serialised
 * by a different version of lunr.
 *
 * @param {Object} serialisedData The serialised set to load.
 * @returns {lunr.Index}
 * @memberOf Index
 */
lunr.Index.load = function (serialisedData) {
  if (serialisedData.version !== lunr.version) {
    lunr.utils.warn('version mismatch: current ' + lunr.version + ' importing ' + serialisedData.version)
  }

  var idx = new this

  idx._fields = serialisedData.fields
  idx._ref = serialisedData.ref

  idx.tokenizer = lunr.tokenizer.load(serialisedData.tokenizer)
  idx.documentStore = lunr.Store.load(serialisedData.documentStore)
  idx.tokenStore = lunr.TokenStore.load(serialisedData.tokenStore)
  idx.corpusTokens = lunr.SortedSet.load(serialisedData.corpusTokens)
  idx.pipeline = lunr.Pipeline.load(serialisedData.pipeline)

  return idx
}

/**
 * Adds a field to the list of fields that will be searchable within documents
 * in the index.
 *
 * An optional boost param can be passed to affect how much tokens in this field
 * rank in search results, by default the boost value is 1.
 *
 * Fields should be added before any documents are added to the index, fields
 * that are added after documents are added to the index will only apply to new
 * documents added to the index.
 *
 * @param {String} fieldName The name of the field within the document that
 * should be indexed
 * @param {Number} boost An optional boost that can be applied to terms in this
 * field.
 * @returns {lunr.Index}
 * @memberOf Index
 */
lunr.Index.prototype.field = function (fieldName, opts) {
  var opts = opts || {},
      field = { name: fieldName, boost: opts.boost || 1 }

  this._fields.push(field)
  return this
}

/**
 * Sets the property used to uniquely identify documents added to the index,
 * by default this property is 'id'.
 *
 * This should only be changed before adding documents to the index, changing
 * the ref property without resetting the index can lead to unexpected results.
 *
 * The value of ref can be of any type but it _must_ be stably comparable and
 * orderable.
 *
 * @param {String} refName The property to use to uniquely identify the
 * documents in the index.
 * @param {Boolean} emitEvent Whether to emit add events, defaults to true
 * @returns {lunr.Index}
 * @memberOf Index
 */
lunr.Index.prototype.ref = function (refName) {
  this._ref = refName
  return this
}

/**
 * Sets the tokenizer used for this index.
 *
 * By default the index will use the default tokenizer, lunr.tokenizer. The tokenizer
 * should only be changed before adding documents to the index. Changing the tokenizer
 * without re-building the index can lead to unexpected results.
 *
 * @param {Function} fn The function to use as a tokenizer.
 * @returns {lunr.Index}
 * @memberOf Index
 */
lunr.Index.prototype.tokenizer = function (fn) {
  var isRegistered = fn.label && (fn.label in lunr.tokenizer.registeredFunctions)

  if (!isRegistered) {
    lunr.utils.warn('Function is not a registered tokenizer. This may cause problems when serialising the index')
  }

  this.tokenizerFn = fn
  return this
}

/**
 * Add a document to the index.
 *
 * This is the way new documents enter the index, this function will run the
 * fields from the document through the index's pipeline and then add it to
 * the index, it will then show up in search results.
 *
 * An 'add' event is emitted with the document that has been added and the index
 * the document has been added to. This event can be silenced by passing false
 * as the second argument to add.
 *
 * @param {Object} doc The document to add to the index.
 * @param {Boolean} emitEvent Whether or not to emit events, default true.
 * @memberOf Index
 */
lunr.Index.prototype.add = function (doc, emitEvent) {
  var docTokens = {},
      allDocumentTokens = new lunr.SortedSet,
      docRef = doc[this._ref],
      emitEvent = emitEvent === undefined ? true : emitEvent

  this._fields.forEach(function (field) {
    var fieldTokens = this.pipeline.run(this.tokenizerFn(doc[field.name]))

    docTokens[field.name] = fieldTokens

    for (var i = 0; i < fieldTokens.length; i++) {
      var token = fieldTokens[i]
      allDocumentTokens.add(token)
      this.corpusTokens.add(token)
    }
  }, this)

  this.documentStore.set(docRef, allDocumentTokens)

  for (var i = 0; i < allDocumentTokens.length; i++) {
    var token = allDocumentTokens.elements[i]
    var tf = 0;

    for (var j = 0; j < this._fields.length; j++){
      var field = this._fields[j]
      var fieldTokens = docTokens[field.name]
      var fieldLength = fieldTokens.length

      if (!fieldLength) continue

      var tokenCount = 0
      for (var k = 0; k < fieldLength; k++){
        if (fieldTokens[k] === token){
          tokenCount++
        }
      }

      tf += (tokenCount / fieldLength * field.boost)
    }

    this.tokenStore.add(token, { ref: docRef, tf: tf })
  };

  if (emitEvent) this.eventEmitter.emit('add', doc, this)
}

/**
 * Removes a document from the index.
 *
 * To make sure documents no longer show up in search results they can be
 * removed from the index using this method.
 *
 * The document passed only needs to have the same ref property value as the
 * document that was added to the index, they could be completely different
 * objects.
 *
 * A 'remove' event is emitted with the document that has been removed and the index
 * the document has been removed from. This event can be silenced by passing false
 * as the second argument to remove.
 *
 * @param {Object} doc The document to remove from the index.
 * @param {Boolean} emitEvent Whether to emit remove events, defaults to true
 * @memberOf Index
 */
lunr.Index.prototype.remove = function (doc, emitEvent) {
  var docRef = doc[this._ref],
      emitEvent = emitEvent === undefined ? true : emitEvent

  if (!this.documentStore.has(docRef)) return

  var docTokens = this.documentStore.get(docRef)

  this.documentStore.remove(docRef)

  docTokens.forEach(function (token) {
    this.tokenStore.remove(token, docRef)
  }, this)

  if (emitEvent) this.eventEmitter.emit('remove', doc, this)
}

/**
 * Updates a document in the index.
 *
 * When a document contained within the index gets updated, fields changed,
 * added or removed, to make sure it correctly matched against search queries,
 * it should be updated in the index.
 *
 * This method is just a wrapper around `remove` and `add`
 *
 * An 'update' event is emitted with the document that has been updated and the index.
 * This event can be silenced by passing false as the second argument to update. Only
 * an update event will be fired, the 'add' and 'remove' events of the underlying calls
 * are silenced.
 *
 * @param {Object} doc The document to update in the index.
 * @param {Boolean} emitEvent Whether to emit update events, defaults to true
 * @see Index.prototype.remove
 * @see Index.prototype.add
 * @memberOf Index
 */
lunr.Index.prototype.update = function (doc, emitEvent) {
  var emitEvent = emitEvent === undefined ? true : emitEvent

  this.remove(doc, false)
  this.add(doc, false)

  if (emitEvent) this.eventEmitter.emit('update', doc, this)
}

/**
 * Calculates the inverse document frequency for a token within the index.
 *
 * @param {String} token The token to calculate the idf of.
 * @see Index.prototype.idf
 * @private
 * @memberOf Index
 */
lunr.Index.prototype.idf = function (term) {
  var cacheKey = "@" + term
  if (Object.prototype.hasOwnProperty.call(this._idfCache, cacheKey)) return this._idfCache[cacheKey]

  var documentFrequency = this.tokenStore.count(term),
      idf = 1

  if (documentFrequency > 0) {
    idf = 1 + Math.log(this.documentStore.length / documentFrequency)
  }

  return this._idfCache[cacheKey] = idf
}

/**
 * Searches the index using the passed query.
 *
 * Queries should be a string, multiple words are allowed and will lead to an
 * AND based query, e.g. `idx.search('foo bar')` will run a search for
 * documents containing both 'foo' and 'bar'.
 *
 * All query tokens are passed through the same pipeline that document tokens
 * are passed through, so any language processing involved will be run on every
 * query term.
 *
 * Each query term is expanded, so that the term 'he' might be expanded to
 * 'hello' and 'help' if those terms were already included in the index.
 *
 * Matching documents are returned as an array of objects, each object contains
 * the matching document ref, as set for this index, and the similarity score
 * for this document against the query.
 *
 * @param {String} query The query to search the index with.
 * @returns {Object}
 * @see Index.prototype.idf
 * @see Index.prototype.documentVector
 * @memberOf Index
 */
lunr.Index.prototype.search = function (query) {
  var queryTokens = this.pipeline.run(this.tokenizerFn(query)),
      queryVector = new lunr.Vector,
      documentSets = [],
      fieldBoosts = this._fields.reduce(function (memo, f) { return memo + f.boost }, 0)

  var hasSomeToken = queryTokens.some(function (token) {
    return this.tokenStore.has(token)
  }, this)

  if (!hasSomeToken) return []

  queryTokens
    .forEach(function (token, i, tokens) {
      var tf = 1 / tokens.length * this._fields.length * fieldBoosts,
          self = this

      var set = this.tokenStore.expand(token).reduce(function (memo, key) {
        var pos = self.corpusTokens.indexOf(key),
            idf = self.idf(key),
            similarityBoost = 1,
            set = new lunr.SortedSet

        // if the expanded key is not an exact match to the token then
        // penalise the score for this key by how different the key is
        // to the token.
        if (key !== token) {
          var diff = Math.max(3, key.length - token.length)
          similarityBoost = 1 / Math.log(diff)
        }

        // calculate the query tf-idf score for this token
        // applying an similarityBoost to ensure exact matches
        // these rank higher than expanded terms
        if (pos > -1) queryVector.insert(pos, tf * idf * similarityBoost)

        // add all the documents that have this key into a set
        // ensuring that the type of key is preserved
        var matchingDocuments = self.tokenStore.get(key),
            refs = Object.keys(matchingDocuments),
            refsLen = refs.length

        for (var i = 0; i < refsLen; i++) {
          set.add(matchingDocuments[refs[i]].ref)
        }

        return memo.union(set)
      }, new lunr.SortedSet)

      documentSets.push(set)
    }, this)

  var documentSet = documentSets.reduce(function (memo, set) {
    return memo.intersect(set)
  })

  return documentSet
    .map(function (ref) {
      return { ref: ref, score: queryVector.similarity(this.documentVector(ref)) }
    }, this)
    .sort(function (a, b) {
      return b.score - a.score
    })
}

/**
 * Generates a vector containing all the tokens in the document matching the
 * passed documentRef.
 *
 * The vector contains the tf-idf score for each token contained in the
 * document with the passed documentRef.  The vector will contain an element
 * for every token in the indexes corpus, if the document does not contain that
 * token the element will be 0.
 *
 * @param {Object} documentRef The ref to find the document with.
 * @returns {lunr.Vector}
 * @private
 * @memberOf Index
 */
lunr.Index.prototype.documentVector = function (documentRef) {
  var documentTokens = this.documentStore.get(documentRef),
      documentTokensLength = documentTokens.length,
      documentVector = new lunr.Vector

  for (var i = 0; i < documentTokensLength; i++) {
    var token = documentTokens.elements[i],
        tf = this.tokenStore.get(token)[documentRef].tf,
        idf = this.idf(token)

    documentVector.insert(this.corpusTokens.indexOf(token), tf * idf)
  };

  return documentVector
}

/**
 * Returns a representation of the index ready for serialisation.
 *
 * @returns {Object}
 * @memberOf Index
 */
lunr.Index.prototype.toJSON = function () {
  return {
    version: lunr.version,
    fields: this._fields,
    ref: this._ref,
    tokenizer: this.tokenizerFn.label,
    documentStore: this.documentStore.toJSON(),
    tokenStore: this.tokenStore.toJSON(),
    corpusTokens: this.corpusTokens.toJSON(),
    pipeline: this.pipeline.toJSON()
  }
}

/**
 * Applies a plugin to the current index.
 *
 * A plugin is a function that is called with the index as its context.
 * Plugins can be used to customise or extend the behaviour the index
 * in some way. A plugin is just a function, that encapsulated the custom
 * behaviour that should be applied to the index.
 *
 * The plugin function will be called with the index as its argument, additional
 * arguments can also be passed when calling use. The function will be called
 * with the index as its context.
 *
 * Example:
 *
 *     var myPlugin = function (idx, arg1, arg2) {
 *       // `this` is the index to be extended
 *       // apply any extensions etc here.
 *     }
 *
 *     var idx = lunr(function () {
 *       this.use(myPlugin, 'arg1', 'arg2')
 *     })
 *
 * @param {Function} plugin The plugin to apply.
 * @memberOf Index
 */
lunr.Index.prototype.use = function (plugin) {
  var args = Array.prototype.slice.call(arguments, 1)
  args.unshift(this)
  plugin.apply(this, args)
}
/*!
 * lunr.Store
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * lunr.Store is a simple key-value store used for storing sets of tokens for
 * documents stored in index.
 *
 * @constructor
 * @module
 */
lunr.Store = function () {
  this.store = {}
  this.length = 0
}

/**
 * Loads a previously serialised store
 *
 * @param {Object} serialisedData The serialised store to load.
 * @returns {lunr.Store}
 * @memberOf Store
 */
lunr.Store.load = function (serialisedData) {
  var store = new this

  store.length = serialisedData.length
  store.store = Object.keys(serialisedData.store).reduce(function (memo, key) {
    memo[key] = lunr.SortedSet.load(serialisedData.store[key])
    return memo
  }, {})

  return store
}

/**
 * Stores the given tokens in the store against the given id.
 *
 * @param {Object} id The key used to store the tokens against.
 * @param {Object} tokens The tokens to store against the key.
 * @memberOf Store
 */
lunr.Store.prototype.set = function (id, tokens) {
  if (!this.has(id)) this.length++
  this.store[id] = tokens
}

/**
 * Retrieves the tokens from the store for a given key.
 *
 * @param {Object} id The key to lookup and retrieve from the store.
 * @returns {Object}
 * @memberOf Store
 */
lunr.Store.prototype.get = function (id) {
  return this.store[id]
}

/**
 * Checks whether the store contains a key.
 *
 * @param {Object} id The id to look up in the store.
 * @returns {Boolean}
 * @memberOf Store
 */
lunr.Store.prototype.has = function (id) {
  return id in this.store
}

/**
 * Removes the value for a key in the store.
 *
 * @param {Object} id The id to remove from the store.
 * @memberOf Store
 */
lunr.Store.prototype.remove = function (id) {
  if (!this.has(id)) return

  delete this.store[id]
  this.length--
}

/**
 * Returns a representation of the store ready for serialisation.
 *
 * @returns {Object}
 * @memberOf Store
 */
lunr.Store.prototype.toJSON = function () {
  return {
    store: this.store,
    length: this.length
  }
}

/*!
 * lunr.stemmer
 * Copyright (C) 2016 Oliver Nightingale
 * Includes code from - http://tartarus.org/~martin/PorterStemmer/js.txt
 */

/**
 * lunr.stemmer is an english language stemmer, this is a JavaScript
 * implementation of the PorterStemmer taken from http://tartarus.org/~martin
 *
 * @module
 * @param {String} str The string to stem
 * @returns {String}
 * @see lunr.Pipeline
 */
lunr.stemmer = (function(){
  var step2list = {
      "ational" : "ate",
      "tional" : "tion",
      "enci" : "ence",
      "anci" : "ance",
      "izer" : "ize",
      "bli" : "ble",
      "alli" : "al",
      "entli" : "ent",
      "eli" : "e",
      "ousli" : "ous",
      "ization" : "ize",
      "ation" : "ate",
      "ator" : "ate",
      "alism" : "al",
      "iveness" : "ive",
      "fulness" : "ful",
      "ousness" : "ous",
      "aliti" : "al",
      "iviti" : "ive",
      "biliti" : "ble",
      "logi" : "log"
    },

    step3list = {
      "icate" : "ic",
      "ative" : "",
      "alize" : "al",
      "iciti" : "ic",
      "ical" : "ic",
      "ful" : "",
      "ness" : ""
    },

    c = "[^aeiou]",          // consonant
    v = "[aeiouy]",          // vowel
    C = c + "[^aeiouy]*",    // consonant sequence
    V = v + "[aeiou]*",      // vowel sequence

    mgr0 = "^(" + C + ")?" + V + C,               // [C]VC... is m>0
    meq1 = "^(" + C + ")?" + V + C + "(" + V + ")?$",  // [C]VC[V] is m=1
    mgr1 = "^(" + C + ")?" + V + C + V + C,       // [C]VCVC... is m>1
    s_v = "^(" + C + ")?" + v;                   // vowel in stem

  var re_mgr0 = new RegExp(mgr0);
  var re_mgr1 = new RegExp(mgr1);
  var re_meq1 = new RegExp(meq1);
  var re_s_v = new RegExp(s_v);

  var re_1a = /^(.+?)(ss|i)es$/;
  var re2_1a = /^(.+?)([^s])s$/;
  var re_1b = /^(.+?)eed$/;
  var re2_1b = /^(.+?)(ed|ing)$/;
  var re_1b_2 = /.$/;
  var re2_1b_2 = /(at|bl|iz)$/;
  var re3_1b_2 = new RegExp("([^aeiouylsz])\\1$");
  var re4_1b_2 = new RegExp("^" + C + v + "[^aeiouwxy]$");

  var re_1c = /^(.+?[^aeiou])y$/;
  var re_2 = /^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/;

  var re_3 = /^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/;

  var re_4 = /^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;
  var re2_4 = /^(.+?)(s|t)(ion)$/;

  var re_5 = /^(.+?)e$/;
  var re_5_1 = /ll$/;
  var re3_5 = new RegExp("^" + C + v + "[^aeiouwxy]$");

  var porterStemmer = function porterStemmer(w) {
    var   stem,
      suffix,
      firstch,
      re,
      re2,
      re3,
      re4;

    if (w.length < 3) { return w; }

    firstch = w.substr(0,1);
    if (firstch == "y") {
      w = firstch.toUpperCase() + w.substr(1);
    }

    // Step 1a
    re = re_1a
    re2 = re2_1a;

    if (re.test(w)) { w = w.replace(re,"$1$2"); }
    else if (re2.test(w)) { w = w.replace(re2,"$1$2"); }

    // Step 1b
    re = re_1b;
    re2 = re2_1b;
    if (re.test(w)) {
      var fp = re.exec(w);
      re = re_mgr0;
      if (re.test(fp[1])) {
        re = re_1b_2;
        w = w.replace(re,"");
      }
    } else if (re2.test(w)) {
      var fp = re2.exec(w);
      stem = fp[1];
      re2 = re_s_v;
      if (re2.test(stem)) {
        w = stem;
        re2 = re2_1b_2;
        re3 = re3_1b_2;
        re4 = re4_1b_2;
        if (re2.test(w)) {  w = w + "e"; }
        else if (re3.test(w)) { re = re_1b_2; w = w.replace(re,""); }
        else if (re4.test(w)) { w = w + "e"; }
      }
    }

    // Step 1c - replace suffix y or Y by i if preceded by a non-vowel which is not the first letter of the word (so cry -> cri, by -> by, say -> say)
    re = re_1c;
    if (re.test(w)) {
      var fp = re.exec(w);
      stem = fp[1];
      w = stem + "i";
    }

    // Step 2
    re = re_2;
    if (re.test(w)) {
      var fp = re.exec(w);
      stem = fp[1];
      suffix = fp[2];
      re = re_mgr0;
      if (re.test(stem)) {
        w = stem + step2list[suffix];
      }
    }

    // Step 3
    re = re_3;
    if (re.test(w)) {
      var fp = re.exec(w);
      stem = fp[1];
      suffix = fp[2];
      re = re_mgr0;
      if (re.test(stem)) {
        w = stem + step3list[suffix];
      }
    }

    // Step 4
    re = re_4;
    re2 = re2_4;
    if (re.test(w)) {
      var fp = re.exec(w);
      stem = fp[1];
      re = re_mgr1;
      if (re.test(stem)) {
        w = stem;
      }
    } else if (re2.test(w)) {
      var fp = re2.exec(w);
      stem = fp[1] + fp[2];
      re2 = re_mgr1;
      if (re2.test(stem)) {
        w = stem;
      }
    }

    // Step 5
    re = re_5;
    if (re.test(w)) {
      var fp = re.exec(w);
      stem = fp[1];
      re = re_mgr1;
      re2 = re_meq1;
      re3 = re3_5;
      if (re.test(stem) || (re2.test(stem) && !(re3.test(stem)))) {
        w = stem;
      }
    }

    re = re_5_1;
    re2 = re_mgr1;
    if (re.test(w) && re2.test(w)) {
      re = re_1b_2;
      w = w.replace(re,"");
    }

    // and turn initial Y back to y

    if (firstch == "y") {
      w = firstch.toLowerCase() + w.substr(1);
    }

    return w;
  };

  return porterStemmer;
})();

lunr.Pipeline.registerFunction(lunr.stemmer, 'stemmer')
/*!
 * lunr.stopWordFilter
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * lunr.generateStopWordFilter builds a stopWordFilter function from the provided
 * list of stop words.
 *
 * The built in lunr.stopWordFilter is built using this generator and can be used
 * to generate custom stopWordFilters for applications or non English languages.
 *
 * @module
 * @param {Array} token The token to pass through the filter
 * @returns {Function}
 * @see lunr.Pipeline
 * @see lunr.stopWordFilter
 */
lunr.generateStopWordFilter = function (stopWords) {
  var words = stopWords.reduce(function (memo, stopWord) {
    memo[stopWord] = stopWord
    return memo
  }, {})

  return function (token) {
    if (token && words[token] !== token) return token
  }
}

/**
 * lunr.stopWordFilter is an English language stop word list filter, any words
 * contained in the list will not be passed through the filter.
 *
 * This is intended to be used in the Pipeline. If the token does not pass the
 * filter then undefined will be returned.
 *
 * @module
 * @param {String} token The token to pass through the filter
 * @returns {String}
 * @see lunr.Pipeline
 */
lunr.stopWordFilter = lunr.generateStopWordFilter([
  'a',
  'able',
  'about',
  'across',
  'after',
  'all',
  'almost',
  'also',
  'am',
  'among',
  'an',
  'and',
  'any',
  'are',
  'as',
  'at',
  'be',
  'because',
  'been',
  'but',
  'by',
  'can',
  'cannot',
  'could',
  'dear',
  'did',
  'do',
  'does',
  'either',
  'else',
  'ever',
  'every',
  'for',
  'from',
  'get',
  'got',
  'had',
  'has',
  'have',
  'he',
  'her',
  'hers',
  'him',
  'his',
  'how',
  'however',
  'i',
  'if',
  'in',
  'into',
  'is',
  'it',
  'its',
  'just',
  'least',
  'let',
  'like',
  'likely',
  'may',
  'me',
  'might',
  'most',
  'must',
  'my',
  'neither',
  'no',
  'nor',
  'not',
  'of',
  'off',
  'often',
  'on',
  'only',
  'or',
  'other',
  'our',
  'own',
  'rather',
  'said',
  'say',
  'says',
  'she',
  'should',
  'since',
  'so',
  'some',
  'than',
  'that',
  'the',
  'their',
  'them',
  'then',
  'there',
  'these',
  'they',
  'this',
  'tis',
  'to',
  'too',
  'twas',
  'us',
  'wants',
  'was',
  'we',
  'were',
  'what',
  'when',
  'where',
  'which',
  'while',
  'who',
  'whom',
  'why',
  'will',
  'with',
  'would',
  'yet',
  'you',
  'your'
])

lunr.Pipeline.registerFunction(lunr.stopWordFilter, 'stopWordFilter')
/*!
 * lunr.trimmer
 * Copyright (C) 2016 Oliver Nightingale
 */

/**
 * lunr.trimmer is a pipeline function for trimming non word
 * characters from the begining and end of tokens before they
 * enter the index.
 *
 * This implementation may not work correctly for non latin
 * characters and should either be removed or adapted for use
 * with languages with non-latin characters.
 *
 * @module
 * @param {String} token The token to pass through the filter
 * @returns {String}
 * @see lunr.Pipeline
 */
lunr.trimmer = function (token) {
  return token.replace(/^\W+/, '').replace(/\W+$/, '')
}

lunr.Pipeline.registerFunction(lunr.trimmer, 'trimmer')
/*!
 * lunr.stemmer
 * Copyright (C) 2016 Oliver Nightingale
 * Includes code from - http://tartarus.org/~martin/PorterStemmer/js.txt
 */

/**
 * lunr.TokenStore is used for efficient storing and lookup of the reverse
 * index of token to document ref.
 *
 * @constructor
 */
lunr.TokenStore = function () {
  this.root = { docs: {} }
  this.length = 0
}

/**
 * Loads a previously serialised token store
 *
 * @param {Object} serialisedData The serialised token store to load.
 * @returns {lunr.TokenStore}
 * @memberOf TokenStore
 */
lunr.TokenStore.load = function (serialisedData) {
  var store = new this

  store.root = serialisedData.root
  store.length = serialisedData.length

  return store
}

/**
 * Adds a new token doc pair to the store.
 *
 * By default this function starts at the root of the current store, however
 * it can start at any node of any token store if required.
 *
 * @param {String} token The token to store the doc under
 * @param {Object} doc The doc to store against the token
 * @param {Object} root An optional node at which to start looking for the
 * correct place to enter the doc, by default the root of this lunr.TokenStore
 * is used.
 * @memberOf TokenStore
 */
lunr.TokenStore.prototype.add = function (token, doc, root) {
  var root = root || this.root,
      key = token.charAt(0),
      rest = token.slice(1)

  if (!(key in root)) root[key] = {docs: {}}

  if (rest.length === 0) {
    root[key].docs[doc.ref] = doc
    this.length += 1
    return
  } else {
    return this.add(rest, doc, root[key])
  }
}

/**
 * Checks whether this key is contained within this lunr.TokenStore.
 *
 * By default this function starts at the root of the current store, however
 * it can start at any node of any token store if required.
 *
 * @param {String} token The token to check for
 * @param {Object} root An optional node at which to start
 * @memberOf TokenStore
 */
lunr.TokenStore.prototype.has = function (token) {
  if (!token) return false

  var node = this.root

  for (var i = 0; i < token.length; i++) {
    if (!node[token.charAt(i)]) return false

    node = node[token.charAt(i)]
  }

  return true
}

/**
 * Retrieve a node from the token store for a given token.
 *
 * By default this function starts at the root of the current store, however
 * it can start at any node of any token store if required.
 *
 * @param {String} token The token to get the node for.
 * @param {Object} root An optional node at which to start.
 * @returns {Object}
 * @see TokenStore.prototype.get
 * @memberOf TokenStore
 */
lunr.TokenStore.prototype.getNode = function (token) {
  if (!token) return {}

  var node = this.root

  for (var i = 0; i < token.length; i++) {
    if (!node[token.charAt(i)]) return {}

    node = node[token.charAt(i)]
  }

  return node
}

/**
 * Retrieve the documents for a node for the given token.
 *
 * By default this function starts at the root of the current store, however
 * it can start at any node of any token store if required.
 *
 * @param {String} token The token to get the documents for.
 * @param {Object} root An optional node at which to start.
 * @returns {Object}
 * @memberOf TokenStore
 */
lunr.TokenStore.prototype.get = function (token, root) {
  return this.getNode(token, root).docs || {}
}

lunr.TokenStore.prototype.count = function (token, root) {
  return Object.keys(this.get(token, root)).length
}

/**
 * Remove the document identified by ref from the token in the store.
 *
 * By default this function starts at the root of the current store, however
 * it can start at any node of any token store if required.
 *
 * @param {String} token The token to get the documents for.
 * @param {String} ref The ref of the document to remove from this token.
 * @param {Object} root An optional node at which to start.
 * @returns {Object}
 * @memberOf TokenStore
 */
lunr.TokenStore.prototype.remove = function (token, ref) {
  if (!token) return
  var node = this.root

  for (var i = 0; i < token.length; i++) {
    if (!(token.charAt(i) in node)) return
    node = node[token.charAt(i)]
  }

  delete node.docs[ref]
}

/**
 * Find all the possible suffixes of the passed token using tokens
 * currently in the store.
 *
 * @param {String} token The token to expand.
 * @returns {Array}
 * @memberOf TokenStore
 */
lunr.TokenStore.prototype.expand = function (token, memo) {
  var root = this.getNode(token),
      docs = root.docs || {},
      memo = memo || []

  if (Object.keys(docs).length) memo.push(token)

  Object.keys(root)
    .forEach(function (key) {
      if (key === 'docs') return

      memo.concat(this.expand(token + key, memo))
    }, this)

  return memo
}

/**
 * Returns a representation of the token store ready for serialisation.
 *
 * @returns {Object}
 * @memberOf TokenStore
 */
lunr.TokenStore.prototype.toJSON = function () {
  return {
    root: this.root,
    length: this.length
  }
}

  /**
   * export the module via AMD, CommonJS or as a browser global
   * Export code from https://github.com/umdjs/umd/blob/master/returnExports.js
   */
  ;(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
      // AMD. Register as an anonymous module.
      define(factory)
    } else if (typeof exports === 'object') {
      /**
       * Node. Does not work with strict CommonJS, but
       * only CommonJS-like enviroments that support module.exports,
       * like Node.
       */
      module.exports = factory()
    } else {
      // Browser globals (root is window)
      root.lunr = factory()
    }
  }(this, function () {
    /**
     * Just return a value to define the module export.
     * This example returns an object, but the module
     * can return a function as the exported value.
     */
    return lunr
  }))
})();

},{}],27:[function(require,module,exports){
"use strict";

var Index = require('./index.js');

function SearchEngine(antiphoner) {
    var indices = {
        keyword: new Index('full_text_standard'),
        genre: new Index('genre'),
        feast: new Index('feast'),
        office: new Index('office'),
        mode: new Index('mode')
    };

    var folios = antiphoner.getFolios();
    folios.forEach(loadFolio);

    this.searchTextField = function (keyword, field) {
        var results = [];
        var lunr_results = indices[field].search(keyword);
        lunr_results.forEach(function (result, index, array) {
            try {
                results.push(antiphoner.getChant(result.ref));
            } catch (err) {
                console.log(err.message);
            }
        });
        return results;
    };

    this.searchVolpiano = function (volpiano) {
        var return_vals = [];
        var chants;
        folios.forEach(function (folio) {
            chants = antiphoner.getChants(folio);
            return_vals = return_vals.concat(chants.filter(chantContainsVolpiano, {volpiano: volpiano}));
        });
        return return_vals;
    };

    function loadChant(folio, sequence) {
        sequence = parseInt(sequence) + 1;
        var chant = antiphoner.getChant(folio + sequence);
        for (var index in indices) {
            indices[index].addChant(chant);
        }
    }

    function loadFolio(folio) {
        for (var sequence in antiphoner.getChants(folio)) {
            loadChant(folio, sequence);
        }
    }

    function chantContainsVolpiano(chant) {
        return chant.search_volpiano.includes(this.volpiano);
    }
};

module.exports = SearchEngine;
},{"./index.js":4}],28:[function(require,module,exports){
// hbsfy compiled Handlebars template
var HandlebarsCompiler = require('hbsfy/runtime');
module.exports = HandlebarsCompiler.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, helper, alias1=depth0 != null ? depth0 : {}, alias2=helpers.helperMissing, alias3="function", alias4=container.escapeExpression;

  return "        <h3  "
    + ((stack1 = helpers["if"].call(alias1,(depth0 != null ? depth0.youtube : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data})) != null ? stack1 : "")
    + ">"
    + alias4(((helper = (helper = helpers.incipit || (depth0 != null ? depth0.incipit : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"incipit","hash":{},"data":data}) : helper)))
    + " </h3>\n        <div class=\"metadata\">\n            <dl>\n                <dt>Feast</dt>\n                <dd>"
    + alias4(((helper = (helper = helpers.feast || (depth0 != null ? depth0.feast : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"feast","hash":{},"data":data}) : helper)))
    + "</dd>\n                <dt>Office</dt>\n                <dd>"
    + alias4(((helper = (helper = helpers.office || (depth0 != null ? depth0.office : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"office","hash":{},"data":data}) : helper)))
    + "</dd>\n                <dt>Genre</dt>\n                <dd>"
    + alias4(((helper = (helper = helpers.genre || (depth0 != null ? depth0.genre : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"genre","hash":{},"data":data}) : helper)))
    + "</dd>\n                <dt>Mode</dt>\n                <dd>"
    + alias4(((helper = (helper = helpers.mode || (depth0 != null ? depth0.mode : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"mode","hash":{},"data":data}) : helper)))
    + "</dd>\n            </dl>\n            <div class=\"notation\">"
    + alias4(((helper = (helper = helpers.volpiano || (depth0 != null ? depth0.volpiano : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"volpiano","hash":{},"data":data}) : helper)))
    + "</div>\n"
    + ((stack1 = helpers["if"].call(alias1,(depth0 != null ? depth0.youtube : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data})) != null ? stack1 : "")
    + "        </div>\n";
},"2":function(container,depth0,helpers,partials,data) {
    return "class=\"has-video\"";
},"4":function(container,depth0,helpers,partials,data) {
    var helper;

  return "                <div class=\"youtube-viewer\">\n                    <iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/"
    + container.escapeExpression(((helper = (helper = helpers.youtube || (depth0 != null ? depth0.youtube : depth0)) != null ? helper : helpers.helperMissing),(typeof helper === "function" ? helper.call(depth0 != null ? depth0 : {},{"name":"youtube","hash":{},"data":data}) : helper)))
    + "\" frameborder=\"0\"\n                            allowfullscreen></iframe>\n                </div>\n";
},"compiler":[7,">= 4.0.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1;

  return "<div class=\"page-items-holder\">\n"
    + ((stack1 = helpers.each.call(depth0 != null ? depth0 : {},(depth0 != null ? depth0.incipits : depth0),{"name":"each","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data})) != null ? stack1 : "")
    + "</div>";
},"useData":true});

},{"hbsfy/runtime":25}],29:[function(require,module,exports){
// hbsfy compiled Handlebars template
var HandlebarsCompiler = require('hbsfy/runtime');
module.exports = HandlebarsCompiler.template({"1":function(container,depth0,helpers,partials,data) {
    var helper, alias1=depth0 != null ? depth0 : {}, alias2=helpers.helperMissing, alias3="function", alias4=container.escapeExpression;

  return "        <li>\n            <h3><a class=\"search-result\" href=\""
    + alias4(((helper = (helper = helpers.folio || (depth0 != null ? depth0.folio : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"folio","hash":{},"data":data}) : helper)))
    + "/"
    + alias4(((helper = (helper = helpers.sequence || (depth0 != null ? depth0.sequence : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"sequence","hash":{},"data":data}) : helper)))
    + "\">"
    + alias4(((helper = (helper = helpers.incipit || (depth0 != null ? depth0.incipit : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"incipit","hash":{},"data":data}) : helper)))
    + "</a></h3>\n            <div class=\"notation\">"
    + alias4(((helper = (helper = helpers.volpiano || (depth0 != null ? depth0.volpiano : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{"name":"volpiano","hash":{},"data":data}) : helper)))
    + "</div>\n        </li>\n";
},"compiler":[7,">= 4.0.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, helper, alias1=depth0 != null ? depth0 : {};

  return "<div>\n    <h2>Results</h2>\n    "
    + container.escapeExpression(((helper = (helper = helpers.total || (depth0 != null ? depth0.total : depth0)) != null ? helper : helpers.helperMissing),(typeof helper === "function" ? helper.call(alias1,{"name":"total","hash":{},"data":data}) : helper)))
    + " results found\n"
    + ((stack1 = helpers.each.call(alias1,(depth0 != null ? depth0.results : depth0),{"name":"each","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data})) != null ? stack1 : "")
    + "</div>";
},"useData":true});

},{"hbsfy/runtime":25}]},{},[3]);
